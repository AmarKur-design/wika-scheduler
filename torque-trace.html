<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torque Calibration Complete</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">Torque TRACE Calibration System</h1>
        
        <!-- Top Buttons -->
        <div class="flex space-x-4 mb-6">
            <button onclick="showSignatureModal()" class="bg-purple-500 text-white px-4 py-2 rounded">
                <i class="fas fa-signature"></i> Manage Signature
            </button>
            <button onclick="showCertificatesModal()" class="bg-blue-500 text-white px-4 py-2 rounded">
                <i class="fas fa-certificate"></i> View Certificates
            </button>
            <button onclick="newCalibration()" class="bg-green-500 text-white px-4 py-2 rounded">
                <i class="fas fa-plus"></i> New Calibration
            </button>
        </div>

        <!-- Main Form -->
        <div class="bg-white p-6 rounded shadow mb-6">
            <h2 class="text-xl font-bold mb-4">Calibration Data</h2>
            
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block font-semibold mb-1">Certificate No:</label>
                    <input id="certNo" type="text" class="w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block font-semibold mb-1">Serial Number:</label>
                    <input id="serialNo" type="text" class="w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block font-semibold mb-1">Customer:</label>
                    <input id="customer" type="text" class="w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block font-semibold mb-1">Date Tested:</label>
                    <input id="dateTested" type="date" class="w-full border rounded px-3 py-2">
                </div>
            </div>

            <div class="flex space-x-4">
                <button onclick="generateCertificate()" class="bg-indigo-500 text-white px-6 py-2 rounded">
                    Generate Certificate
                </button>
                <button id="printLabelBtn" onclick="printLabel()" disabled class="bg-green-500 text-white px-6 py-2 rounded opacity-50">
                    Print Label (After Certificate)
                </button>
            </div>
        </div>
    </div>

    <!-- Signature Modal -->
    <div id="signatureModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded shadow-lg max-w-md w-full">
            <h3 class="text-xl font-bold mb-4">Manage Your Signature</h3>
            <input type="file" id="signatureFile" accept="image/*" class="mb-4" onchange="uploadSignature()">
            <div id="signaturePreview" class="mb-4 hidden">
                <img id="sigImg" class="max-w-full h-24 border" alt="Signature">
            </div>
            <button onclick="closeSignatureModal()" class="bg-gray-500 text-white px-4 py-2 rounded">Close</button>
        </div>
    </div>

    <!-- Certificates Modal -->
    <div id="certificatesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded shadow-lg max-w-4xl w-full max-h-screen overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">Saved Certificates</h3>
            <div id="certList"></div>
            <button onclick="closeCertificatesModal()" class="bg-gray-500 text-white px-4 py-2 rounded mt-4">Close</button>
        </div>
    </div>

<script>
let certificates = JSON.parse(localStorage.getItem('certificates') || '[]');
let userSignature = localStorage.getItem('userSignature');
let currentCertId = null;

// Set today's date
document.getElementById('dateTested').valueAsDate = new Date();

// Signature Management
function showSignatureModal() {
    document.getElementById('signatureModal').classList.remove('hidden');
    if (userSignature) {
        document.getElementById('sigImg').src = userSignature;
        document.getElementById('signaturePreview').classList.remove('hidden');
    }
}

function closeSignatureModal() {
    document.getElementById('signatureModal').classList.add('hidden');
}

function uploadSignature() {
    const file = document.getElementById('signatureFile').files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        userSignature = e.target.result;
        localStorage.setItem('userSignature', userSignature);
        document.getElementById('sigImg').src = userSignature;
        document.getElementById('signaturePreview').classList.remove('hidden');
        alert('Signature uploaded!');
    };
    reader.readAsDataURL(file);
}

// Certificate Generation
function generateCertificate() {
    const certData = {
        id: Date.now().toString(),
        certNo: document.getElementById('certNo').value,
        serialNo: document.getElementById('serialNo').value,
        customer: document.getElementById('customer').value,
        dateTested: document.getElementById('dateTested').value,
        signature: userSignature,
        timestamp: new Date().toISOString()
    };
    
    if (!certData.certNo || !certData.serialNo) {
        alert('Please fill in Certificate No and Serial Number');
        return;
    }
    
    certificates.unshift(certData);
    localStorage.setItem('certificates', JSON.stringify(certificates));
    currentCertId = certData.id;
    
    // Enable label button
    document.getElementById('printLabelBtn').disabled = false;
    document.getElementById('printLabelBtn').classList.remove('opacity-50');
    
    // Open certificate
    openCertificate(certData);
    alert('Certificate saved!');
}

function openCertificate(cert) {
    const win = window.open('', '_blank', 'width=900,height=1200');
    const sigHtml = cert.signature ? 
        '<img src="' + cert.signature + '" style="max-width:200px;max-height:60px">' :
        '<div style="border-bottom:2px solid black;width:200px;height:60px"></div>';
    
    win.document.write('<html><head><title>Certificate ' + cert.certNo + '</title></head><body style="font-family:Arial;padding:40px">');
    win.document.write('<h1 style="text-align:center">CALIBRATION CERTIFICATE</h1>');
    win.document.write('<p><strong>Certificate No:</strong> ' + cert.certNo + '</p>');
    win.document.write('<p><strong>Serial Number:</strong> ' + cert.serialNo + '</p>');
    win.document.write('<p><strong>Customer:</strong> ' + cert.customer + '</p>');
    win.document.write('<p><strong>Date:</strong> ' + cert.dateTested + '</p>');
    win.document.write('<div style="margin-top:60px;text-align:center">');
    win.document.write('<p>Approved Signatory:</p>');
    win.document.write(sigHtml);
    win.document.write('</div>');
    win.document.write('<div style="text-align:center;margin-top:40px">');
    win.document.write('<button onclick="window.print()" style="background:#3b82f6;color:white;padding:12px 24px;border:none;border-radius:5px;cursor:pointer">Print</button>');
    win.document.write('</div>');
    win.document.write('</body></html>');
    win.document.close();
}

// Label Printing with QR
function printLabel() {
    const cert = certificates.find(c => c.id === currentCertId);
    if (!cert) {
        alert('Generate certificate first!');
        return;
    }
    
    const qrData = 'CERT:' + cert.certNo + '|SN:' + cert.serialNo + '|DATE:' + cert.dateTested;
    
    const win = window.open('', '_blank', 'width=800,height=600');
    win.document.write('<html><head><title>Label</title>');
    win.document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></scr' + 'ipt>');
    win.document.write('<style>body{font-family:Arial;display:flex;justify-content:center;align-items:center;height:100vh}');
    win.document.write('.label{border:2px solid black;width:100mm;height:16mm;display:flex}');
    win.document.write('.logo{width:25mm;border-right:2px solid black;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:16pt}');
    win.document.write('.info{flex:1;padding:2mm;display:flex;flex-direction:column;justify-content:space-around;font-size:10pt}');
    win.document.write('.qr{width:18mm;border-left:2px solid black;display:flex;align-items:center;justify-content:center}');
    win.document.write('#qrcode canvas{max-width:16mm;max-height:12mm}</style></head><body>');
    win.document.write('<div class="label">');
    win.document.write('<div class="logo">WIKA</div>');
    win.document.write('<div class="info">');
    win.document.write('<div><strong>Report:</strong> ' + cert.certNo + '</div>');
    win.document.write('<div><strong>Date:</strong> ' + cert.dateTested + '</div>');
    win.document.write('<div><strong>SN:</strong> ' + cert.serialNo + '</div>');
    win.document.write('</div>');
    win.document.write('<div class="qr" id="qrcode"></div>');
    win.document.write('</div>');
    win.document.write('<div style="text-align:center;margin-top:20px">');
    win.document.write('<button onclick="window.print()" style="background:#3b82f6;color:white;padding:10px 20px;border:none;border-radius:5px;cursor:pointer">Print</button>');
    win.document.write('</div>');
    win.document.write('<scr' + 'ipt>new QRCode(document.getElementById("qrcode"),{text:"' + qrData + '",width:64,height:64});</scr' + 'ipt>');
    win.document.write('</body></html>');
    win.document.close();
}

// Certificates List
function showCertificatesModal() {
    document.getElementById('certificatesModal').classList.remove('hidden');
    renderCertificates();
}

function closeCertificatesModal() {
    document.getElementById('certificatesModal').classList.add('hidden');
}

function renderCertificates() {
    const list = document.getElementById('certList');
    if (certificates.length === 0) {
        list.innerHTML = '<p class="text-gray-500">No certificates yet</p>';
        return;
    }
    
    list.innerHTML = certificates.map(cert => 
        '<div class="border p-4 mb-2 rounded">' +
        '<div class="font-bold">' + cert.certNo + '</div>' +
        '<div class="text-sm text-gray-600">Customer: ' + cert.customer + ' | SN: ' + cert.serialNo + '</div>' +
        '<button onclick="openCertificate(' + JSON.stringify(cert).replace(/"/g, '&quot;') + ')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm mt-2 mr-2">View</button>' +
        '<button onclick="deleteCert(\'' + cert.id + '\')" class="bg-red-500 text-white px-3 py-1 rounded text-sm mt-2">Delete</button>' +
        '</div>'
    ).join('');
}

function deleteCert(id) {
    if (confirm('Delete this certificate?')) {
        certificates = certificates.filter(c => c.id !== id);
        localStorage.setItem('certificates', JSON.stringify(certificates));
        renderCertificates();
    }
}

function newCalibration() {
    if (confirm('Start new calibration?')) {
        document.getElementById('certNo').value = '';
        document.getElementById('serialNo').value = '';
        document.getElementById('customer').value = '';
        currentCertId = null;
        document.getElementById('printLabelBtn').disabled = true;
        document.getElementById('printLabelBtn').classList.add('opacity-50');
    }
}
</script>
</body>
</html>
