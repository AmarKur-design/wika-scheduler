<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reference Equipment - WIKA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 2rem; border-radius: 0.5rem; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Reference Equipment</h1>
                <p class="text-sm text-gray-600">Welcome, <span id="userName"></span></p>
            </div>
            <div class="flex space-x-4">
                <button onclick="showAddEquipment()" class="bg-green-500 hover:bg-green-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-plus mr-2"></i>Add Equipment
                </button>
                <a href="calibration.html" class="bg-gray-500 hover:bg-gray-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-arrow-left mr-2"></i>Back
                </a>
                <button onclick="logout()" class="bg-red-500 hover:bg-red-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
        </div>

        <!-- Equipment List -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-4 border-b">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-semibold">Equipment List</h2>
                    <div class="flex space-x-2">
                        <button onclick="exportToExcel()" class="bg-blue-500 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                            <i class="fas fa-file-excel mr-1"></i>Export
                        </button>
                        <button onclick="resetData()" class="bg-red-500 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                            <i class="fas fa-trash mr-1"></i>Reset Data
                        </button>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Equipment Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Serial Number</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Range</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Certificate No</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Calibration Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="equipmentTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Equipment rows will be generated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add/Edit Equipment Modal -->
    <div id="equipmentModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold" id="modalTitle">Add Equipment</h2>
                <button onclick="closeEquipmentModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <form id="equipmentForm" onsubmit="saveEquipment(event)">
                <input type="hidden" id="equipmentId">
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Equipment Type:</label>
                    <select id="equipmentType" required class="w-full border border-gray-300 rounded px-3 py-2">
                        <option value="">Select Type</option>
                        <option value="Transmitter">Transmitter</option>
                        <option value="Display">Display</option>
                        <option value="Gauge">Gauge</option>
                        <option value="Standard">Standard</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Serial Number:</label>
                    <input id="serialNumber" type="text" required class="w-full border border-gray-300 rounded px-3 py-2" placeholder="e.g., 214002">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Range:</label>
                    <input id="range" type="text" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="e.g., 25 N.m">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Certificate Number:</label>
                    <input id="certificateNo" type="text" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="e.g., 33666A">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Calibration Date:</label>
                    <input id="calibrationDate" type="date" class="w-full border border-gray-300 rounded px-3 py-2">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Due Date:</label>
                    <input id="dueDate" type="date" class="w-full border border-gray-300 rounded px-3 py-2">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Notes:</label>
                    <textarea id="notes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Additional information"></textarea>
                </div>

                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="closeEquipmentModal()" class="bg-gray-500 hover:bg-gray-700 text-white px-4 py-2 rounded">
                        Cancel
                    </button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded">
                        <i class="fas fa-save mr-2"></i>Save
                    </button>
                </div>
            </form>
        </div>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));

if (!currentUser) {
    window.location.href = 'index.html';
}

let referenceEquipment = [];

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('userName').textContent = currentUser.name;
    loadEquipment();
    renderEquipmentTable();
});

function logout() {
    sessionStorage.removeItem('currentUser');
    window.location.href = 'index.html';
}

function loadEquipment() {
    referenceEquipment = JSON.parse(localStorage.getItem('referenceEquipment') || '[]');
}

function saveEquipmentData() {
    localStorage.setItem('referenceEquipment', JSON.stringify(referenceEquipment));
}

function renderEquipmentTable() {
    const tbody = document.getElementById('equipmentTableBody');
    tbody.innerHTML = '';

    if (referenceEquipment.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                    No equipment found. Click "Add Equipment" to get started.
                </td>
            </tr>
        `;
        return;
    }

    referenceEquipment.forEach((equipment, index) => {
        const dueDate = equipment.dueDate ? new Date(equipment.dueDate) : null;
        const today = new Date();
        const isOverdue = dueDate && dueDate < today;
        const isDueSoon = dueDate && dueDate < new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000) && !isOverdue;
        
        let statusBadge = '<span class="px-2 py-1 text-xs rounded bg-green-100 text-green-800">Current</span>';
        if (isOverdue) {
            statusBadge = '<span class="px-2 py-1 text-xs rounded bg-red-100 text-red-800">Overdue</span>';
        } else if (isDueSoon) {
            statusBadge = '<span class="px-2 py-1 text-xs rounded bg-yellow-100 text-yellow-800">Due Soon</span>';
        }

        const row = document.createElement('tr');
        row.className = isOverdue ? 'bg-red-50' : isDueSoon ? 'bg-yellow-50' : '';
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                ${equipment.equipmentType}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${equipment.serialNumber}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${equipment.range || '-'}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${equipment.certificateNo || '-'}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${equipment.calibrationDate || '-'}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${equipment.dueDate || '-'}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm">
                ${statusBadge}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                <button onclick="editEquipment(${index})" class="text-indigo-600 hover:text-indigo-900">
                    <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteEquipment(${index})" class="text-red-600 hover:text-red-900">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function showAddEquipment() {
    document.getElementById('modalTitle').textContent = 'Add Equipment';
    document.getElementById('equipmentForm').reset();
    document.getElementById('equipmentId').value = '';
    document.getElementById('equipmentModal').classList.add('show');
}

function closeEquipmentModal() {
    document.getElementById('equipmentModal').classList.remove('show');
}

function saveEquipment(event) {
    event.preventDefault();
    
    const equipmentData = {
        equipmentType: document.getElementById('equipmentType').value,
        serialNumber: document.getElementById('serialNumber').value,
        range: document.getElementById('range').value,
        certificateNo: document.getElementById('certificateNo').value,
        calibrationDate: document.getElementById('calibrationDate').value,
        dueDate: document.getElementById('dueDate').value,
        notes: document.getElementById('notes').value
    };

    const equipmentId = document.getElementById('equipmentId').value;
    
    if (equipmentId) {
        // Update existing
        referenceEquipment[parseInt(equipmentId)] = equipmentData;
    } else {
        // Add new
        referenceEquipment.push(equipmentData);
    }

    saveEquipmentData();
    renderEquipmentTable();
    closeEquipmentModal();
    alert('Equipment saved successfully!');
}

function editEquipment(index) {
    const equipment = referenceEquipment[index];
    
    document.getElementById('modalTitle').textContent = 'Edit Equipment';
    document.getElementById('equipmentId').value = index;
    document.getElementById('equipmentType').value = equipment.equipmentType;
    document.getElementById('serialNumber').value = equipment.serialNumber;
    document.getElementById('range').value = equipment.range || '';
    document.getElementById('certificateNo').value = equipment.certificateNo || '';
    document.getElementById('calibrationDate').value = equipment.calibrationDate || '';
    document.getElementById('dueDate').value = equipment.dueDate || '';
    document.getElementById('notes').value = equipment.notes || '';
    
    document.getElementById('equipmentModal').classList.add('show');
}

function deleteEquipment(index) {
    if (confirm('Are you sure you want to delete this equipment?')) {
        referenceEquipment.splice(index, 1);
        saveEquipmentData();
        renderEquipmentTable();
    }
}

function exportToExcel() {
    if (referenceEquipment.length === 0) {
        alert('No equipment to export');
        return;
    }

    const exportData = referenceEquipment.map(eq => ({
        'Equipment Type': eq.equipmentType,
        'Serial Number': eq.serialNumber,
        'Range': eq.range || '',
        'Certificate No': eq.certificateNo || '',
        'Calibration Date': eq.calibrationDate || '',
        'Due Date': eq.dueDate || '',
        'Notes': eq.notes || ''
    }));

    const ws = XLSX.utils.json_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Reference Equipment');
    XLSX.writeFile(wb, 'reference-equipment.xlsx');
}

function resetData() {
    if (confirm('Are you sure you want to delete all equipment data? This cannot be undone.')) {
        localStorage.removeItem('referenceEquipment');
        referenceEquipment = [];
        renderEquipmentTable();
        alert('All equipment data has been cleared.');
    }
}
</script>
</body>
</html>

