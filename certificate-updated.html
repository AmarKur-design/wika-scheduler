<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificate Editor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @page { size: A4; margin: 0; }
        * { box-sizing: border-box; }
        body { margin: 0; background: #f5f5f5; font-family: Arial, sans-serif; }
        
        #toolbar { position: sticky; top: 0; z-index: 100; background: #1f2937; color: #fff; padding: 10px 16px; display: flex; gap: 10px; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        #toolbar .btn { background: #374151; color: #fff; border: 0; border-radius: 6px; padding: 9px 16px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
        #toolbar .btn:hover { background: #4b5563; }
        #toolbar .btn.active { background: #2563eb; }
        #toolbar .btn.save { background: #059669; }
        #toolbar .btn.save:hover { background: #047857; }
        #toolbar .spacer { flex: 1; }
        
        .editor-layout { display: flex; height: calc(100vh - 50px); }
        
        /* Edit Panel */
        #editPanel { width: 300px; background: #fff; border-right: 1px solid #e5e7eb; overflow-y: auto; padding: 20px; display: none; }
        #editPanel.visible { display: block; }
        #editPanel .section { margin-bottom: 24px; }
        #editPanel .section-title { font-weight: 700; font-size: 13px; color: #374151; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        #editPanel label { display: block; font-size: 12px; color: #6b7280; margin-bottom: 6px; font-weight: 500; }
        #editPanel input[type="range"], #editPanel input[type="number"], #editPanel select { width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px; }
        #editPanel input[type="range"] { padding: 0; }
        #editPanel .value-display { font-size: 12px; color: #374151; font-weight: 600; margin-top: 4px; }
        #editPanel .btn-group { display: flex; gap: 6px; margin-top: 8px; }
        #editPanel .btn-group button { flex: 1; padding: 8px; border: 1px solid #d1d5db; background: #fff; border-radius: 4px; cursor: pointer; font-size: 13px; transition: all 0.2s; }
        #editPanel .btn-group button:hover { background: #f3f4f6; }
        #editPanel .btn-group button.active { background: #2563eb; color: #fff; border-color: #2563eb; }
        #editPanel .upload-btn { width: 100%; padding: 10px; background: #2563eb; color: #fff; border: 0; border-radius: 6px; cursor: pointer; font-size: 13px; margin-top: 8px; }
        #editPanel .upload-btn:hover { background: #1d4ed8; }
        #editPanel .preview-logo { max-width: 100%; margin-top: 10px; border: 1px solid #e5e7eb; border-radius: 4px; }
        
        /* Certificate Viewport */
        .cert-viewport { flex: 1; overflow-y: auto; padding: 20px; background: #e5e7eb; }
        .page-wrap { max-width: 210mm; margin: 0 auto; background: #fff; box-shadow: 0 4px 16px rgba(0,0,0,0.1); min-height: 297mm; }
        .page { padding: 20mm; position: relative; }
        
        /* Certificate Styles */
        #certLogo { max-width: 180px; max-height: 80px; display: block; cursor: pointer; transition: opacity 0.2s; }
        #certLogo:hover { opacity: 0.7; }
        #certLogo.placeholder { border: 2px dashed #cbd5e1; padding: 20px; text-align: center; color: #94a3b8; }
        
        .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 18px; }
        .logo-section { text-align: right; }
        .company-details { font-size: 7pt; line-height: 1.4; color: #333; margin-top: 8px; }
        
        h2 { margin: 0; font-size: 18pt; font-weight: 900; }
        
        .info-line { display: flex; margin: 2px 0; font-size: 10pt; }
        .info-label { font-weight: bold; min-width: 150px; }
        .info-value { flex: 1; max-width: 100%; transition: max-width 0.3s; }
        
        .two-col { display: flex; gap: 40px; margin: 8px 0; }
        .two-col > div { flex: 1; }
        
        table { width: 100%; border-collapse: collapse; margin: 14px 0; font-size: 10pt; }
        th, td { border: 1px solid #000; padding: 6px; text-align: center; }
        th { background: #e5e7eb; font-weight: 700; }
        
        .section-title { font-weight: bold; font-size: 10pt; margin: 12px 0 4px 0; }
        .conditions { line-height: 1.5; font-size: 8pt; }
        
        .signature { text-align: center; font-size: 10pt; margin-top: 50px; }
        .sig-line { display: inline-block; width: 260px; border-bottom: 1px solid #000; margin-left: 10px; height: 28px; background-position: center left; background-repeat: no-repeat; background-size: contain; }
        
        .editable { outline: 2px dashed #60a5fa; outline-offset: 2px; cursor: text; padding: 2px 4px; border-radius: 2px; transition: all 0.2s; }
        .editable:hover { background-color: #eff6ff; }
        .editable:focus { outline-color: #2563eb; background-color: #dbeafe; }
        
        .draggable { cursor: move; position: relative; }
        .draggable:hover { outline: 2px solid #10b981; outline-offset: 3px; }
        .draggable.dragging { opacity: 0.5; z-index: 1000; }
        
        @media print { 
            #toolbar, #editPanel { display: none !important; } 
            body { background: white; } 
            .cert-viewport { padding: 0; background: white; }
            .page-wrap { box-shadow: none; margin: 0; max-width: 100%; }
            .page { padding: 0; }
            .editable { outline: none !important; }
            #certLogo { cursor: default; }
        }
    </style>
</head>
<body>
    <div id="toolbar">
        <button class="btn" id="editModeBtn" onclick="toggleEditMode()"><i class="fas fa-edit"></i> Edit Mode</button>
        <button class="btn save" onclick="saveAllEdits()"><i class="fas fa-save"></i> Save Changes</button>
        <button class="btn" onclick="resetAll()"><i class="fas fa-undo"></i> Reset</button>
        <div class="spacer"></div>
        <button class="btn" onclick="window.print()"><i class="fas fa-print"></i> Print</button>
        <button class="btn" onclick="downloadPDF()"><i class="fas fa-file-pdf"></i> Download</button>
        <button class="btn" onclick="goBack()"><i class="fas fa-arrow-left"></i> Back</button>
    </div>
    
    <div class="editor-layout">
        <div id="editPanel">
            <div class="section">
                <div class="section-title">üì∏ Logo</div>
                <button class="upload-btn" onclick="document.getElementById('logoUpload').click()">
                    <i class="fas fa-upload"></i> Upload Logo
                </button>
                <input type="file" id="logoUpload" accept="image/*" style="display:none" onchange="handleLogoUpload(event)">
                <img id="logoPreview" class="preview-logo" style="display:none">
                <button class="upload-btn" style="background:#dc2626; margin-top:8px" onclick="removeLogo()">
                    <i class="fas fa-trash"></i> Remove Logo
                </button>
            </div>
            
            <div class="section">
                <div class="section-title">üìè Page Margins</div>
                <label>Top Margin: <span id="marginTopVal">20mm</span></label>
                <input type="range" id="marginTop" min="10" max="40" value="20" oninput="updateMargin('top', this.value)">
                
                <label style="margin-top:12px">Bottom Margin: <span id="marginBottomVal">20mm</span></label>
                <input type="range" id="marginBottom" min="10" max="40" value="20" oninput="updateMargin('bottom', this.value)">
                
                <label style="margin-top:12px">Left/Right Margin: <span id="marginLRVal">20mm</span></label>
                <input type="range" id="marginLR" min="10" max="40" value="20" oninput="updateMargin('lr', this.value)">
            </div>
            
            <div class="section">
                <div class="section-title">üìù Text Formatting</div>
                <label>Title Font Size: <span id="titleSizeVal">18pt</span></label>
                <input type="range" id="titleSize" min="14" max="24" value="18" oninput="updateTitleSize(this.value)">
                
                <label style="margin-top:12px">Body Font Size: <span id="bodySizeVal">10pt</span></label>
                <input type="range" id="bodySize" min="8" max="14" value="10" oninput="updateBodySize(this.value)">
                
                <label style="margin-top:12px">Line Spacing</label>
                <div class="btn-group">
                    <button onclick="setLineSpacing(1.2)">Tight</button>
                    <button class="active" onclick="setLineSpacing(1.5)">Normal</button>
                    <button onclick="setLineSpacing(1.8)">Loose</button>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">üìê Layout</div>
                <label>Header Spacing: <span id="headerSpaceVal">18px</span></label>
                <input type="range" id="headerSpace" min="10" max="40" value="18" oninput="updateHeaderSpace(this.value)">
                
                <label style="margin-top:12px">Section Spacing: <span id="sectionSpaceVal">12px</span></label>
                <input type="range" id="sectionSpace" min="6" max="24" value="12" oninput="updateSectionSpace(this.value)">
                
                <label style="margin-top:12px">Field Width: <span id="fieldWidthVal">100%</span></label>
                <input type="range" id="fieldWidth" min="30" max="100" value="100" oninput="updateFieldWidth(this.value)">
                <p style="font-size:11px; color:#6b7280; margin-top:4px;">Adjusts width of editable text fields</p>
            </div>
            
            <div class="section">
                <div class="section-title">üñ±Ô∏è Drag & Drop</div>
                <button class="upload-btn" id="dragModeBtn" onclick="toggleDragMode()" style="background:#10b981">
                    <i class="fas fa-arrows-alt"></i> Enable Drag Mode
                </button>
                <p style="font-size:11px; color:#6b7280; margin-top:8px; line-height:1.4;">
                    Click to enable dragging elements. Green outline = draggable. Click and hold to move sections.
                </p>
            </div>
        </div>
        
        <div class="cert-viewport">
    <div class="page-wrap">
        <div id="certPage" class="page"></div>
            </div>
        </div>
    </div>
    
    <script>
        let isEditMode = false;
        let isDragMode = false;
        let originalCert = null;
        let customLogo = null;
        let draggedElement = null;
        let placeholder = null;
        let layoutSettings = {
            marginTop: 20,
            marginBottom: 20,
            marginLR: 20,
            titleSize: 18,
            bodySize: 10,
            lineSpacing: 1.5,
            headerSpace: 18,
            sectionSpace: 12,
            fieldWidth: 100
        };
        
        function getParam(name){ const u=new URL(location.href); return u.searchParams.get(name); }
        
        function render(cert){
            if(!cert){ 
                document.getElementById('certPage').innerHTML = '<p style="color:#b91c1c;padding:40px">No certificate data found.</p>'; 
                return; 
            }
            
            const hasAsLeft = cert.testResults && cert.testResults[0] && cert.testResults[0].asLeftAvg !== '-';
            const rows = (cert.testResults||[]).map((t,idx)=>`
                <tr>
                    <td>${t.nominal||'0'}</td>
                    <td>${t.asFoundAvg||'-'}</td>
                    <td>${(t.asLeftAvg&&t.asLeftAvg!=='-')?t.asLeftAvg:(t.asFoundAvg||'-')}</td>
                    <td>${(parseFloat(t.nominal||0)*parseFloat(cert.tolerance||0)).toFixed(2)}</td>
                    <td>${['0.16','0.097','0.085'][idx]||'0.10'}</td>
                </tr>
            `).join('');
            
            const sigStyle = cert.signature ? `style="background-image:url('${cert.signature}')"` : '';
            const logoSrc = customLogo || 'wika-logo.png';
            
            document.getElementById('certPage').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom:${layoutSettings.headerSpace}px; gap: 40px;">
                    <div style="flex: 1;">
                        <div class="draggable-section" data-section="header" style="margin-bottom: 10px;">
                            <h2 id="certTitle" style="font-size:${layoutSettings.titleSize}pt; margin:0">CALIBRATION REPORT</h2>
                        </div>
                        
                        <div class="info-line draggable-section" data-section="reportOn" style="font-size:${layoutSettings.bodySize}pt; margin-bottom: 10px;">
                            <span class="info-label">Report on:</span>
                            <span class="info-value editable" data-field="reportOn">Hand Torque Tool</span>
                        </div>
                        
                        <div class="draggable-section" data-section="customer" style="font-size:${layoutSettings.bodySize}pt;line-height:${layoutSettings.lineSpacing}">
                            <div class="info-line"><span class="info-label">Customer:</span><span class="info-value editable" data-field="customer">${cert.customer||''}</span></div>
                            <div class="info-line"><span class="info-label"></span><span class="info-value editable" data-field="street">${cert.street||''}</span></div>
                            <div class="info-line"><span class="info-label"></span><span class="info-value editable" data-field="address">${cert.address||''}</span></div>
                        </div>
                    </div>
                    
                    <div class="draggable-section logo-section" data-section="letterhead" style="text-align: right; flex-shrink: 0;">
                        <img id="certLogo" src="${logoSrc}" alt="Logo" onclick="isEditMode && document.getElementById('logoUpload').click()" 
                             onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22150%22 height=%2260%22%3E%3Crect width=%22150%22 height=%2260%22 fill=%22%23f3f4f6%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%239ca3af%22 font-size=%2214%22%3EWIKA%3C/text%3E%3C/svg%3E'">
                        <div class="company-details">WIKA Australia Pty Ltd<br>Unit 1, 6-8 Harvard Way<br>Canning Vale WA 6155<br>ABN: 80 152 894 652<br>Ph (08) 9452 3100<br>www.wika.com.au</div>
                    </div>
                </div>
                
                <div style="font-size:${layoutSettings.bodySize}pt;line-height:${layoutSettings.lineSpacing}">
                
                    <div class="two-col draggable-section" data-section="details" style="margin-top:${layoutSettings.sectionSpace}px">
                    <div>
                        <div class="info-line"><span class="info-label">Certificate No:</span><span class="info-value editable" data-field="certificateNo">${cert.certificateNo||''}</span></div>
                        <div class="info-line"><span class="info-label">Date Tested:</span><span class="info-value editable" data-field="dateTested">${cert.dateTested||''}</span></div>
                        <div class="info-line"><span class="info-label">Date Issued:</span><span class="info-value editable" data-field="dateIssued">${cert.dateIssued||''}</span></div>
                        <div class="info-line"><span class="info-label">Our Ref No:</span><span class="info-value editable" data-field="woNumber">${cert.woNumber||''}</span></div>
                        <div class="info-line"><span class="info-label">Customer PO:</span><span class="info-value editable" data-field="poNumber">${cert.poNumber||''}</span></div>
                        <div class="info-line"><span class="info-label">Item/Cat No:</span><span class="info-value editable" data-field="itemNo">${cert.itemNo||''}</span></div>
                        <div class="info-line"><span class="info-label">Make:</span><span class="info-value editable" data-field="make">${cert.make||''}</span></div>
                        <div class="info-line"><span class="info-label">Type/Model:</span><span class="info-value editable" data-field="model">${cert.model||''}</span></div>
                    </div>
                    <div>
                        <div class="info-line"><span class="info-label">Direction:</span><span class="info-value editable" data-field="direction">${cert.direction||'CW'}</span></div>
                        <div class="info-line"><span class="info-label">Measurement Range:</span><span class="info-value editable" data-field="range">${cert.rangeFrom||'0'} to ${cert.rangeTo||'400'} ${cert.unit||'N.m'}</span></div>
                        <div class="info-line"><span class="info-label">ID No:</span><span class="info-value editable" data-field="assetNo">${cert.assetNo||''}</span></div>
                        <div class="info-line"><span class="info-label">Serial No:</span><span class="info-value editable" data-field="serialNumber">${cert.serialNumber||''}</span></div>
                    </div>
                </div>
                
                    <div class="section-title" style="margin-top:${layoutSettings.sectionSpace}px">Reference Equipment Used:</div>
                <div class="info-line"><span class="info-label">Display Serial No:</span><span class="info-value editable" data-field="displaySN">${cert.displaySN||''}</span></div>
                <div class="info-line"><span class="info-label">Certificate No:</span><span class="info-value editable" data-field="displayCert">${cert.displayCert||''}</span></div>
                <div class="info-line"><span class="info-label">Tx Serial No:</span><span class="info-value editable" data-field="transmitterSN">${cert.transmitterSN||''}</span></div>
                <div class="info-line"><span class="info-label">Certificate No:</span><span class="info-value editable" data-field="transmitterCert">${cert.transmitterCert||''}</span></div>
                <div class="info-line"><span class="info-label">Tx Range:</span><span class="info-value editable" data-field="transmitterRange">${cert.transmitterRange||''}</span></div>
                
                    <table style="margin-top:${layoutSettings.sectionSpace}px;font-size:${layoutSettings.bodySize}pt">
                    <thead>
                        <tr>
                            <th>Set Torque<br>${cert.unit||'N.m'}</th>
                            <th>As Found Average<br>${cert.unit||'N.m'}</th>
                            <th>As Left Average<br>${cert.unit||'N.m'}</th>
                            <th>Tolerance<br>${cert.unit||'N.m'}</th>
                            <th>Uncertainty<br>%</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
                    
                    <div class="section-title" style="margin-top:${layoutSettings.sectionSpace}px">Accuracy (Tolerance): ¬±${(parseFloat(cert.tolerance||0)*100).toFixed(1)}%</div>
                    <div class="section-title" style="margin-top:${layoutSettings.sectionSpace}px">Conditions of Test</div>
                    <div class="conditions" style="line-height:${layoutSettings.lineSpacing}">
                    1. Uncertainty of Measurement with a Confidence Level of 95%, k=2<br>
                    2. Tested in accordance with PWI-101 and ISO 6789-1:2017<br>
                    3. Ambient Temperature ~20¬∞C ¬± 2¬∞C; RH ‚â§ 90%<br>
                    4. Results relate only to the item calibrated<br>
                    5. Test averages are a true average taken from 5 readings<br>
                    6. Observed values within max permissible relative deviation at each target setting<br>
                    7. The device under test was ${hasAsLeft?'adjusted':'not adjusted'}
                </div>
                    
                <div class="signature">
                    Approved Signatory:<span class="sig-line" ${sigStyle}></span>
                    <div style="margin-top:6px; font-weight: 600;">${cert.technician || cert.generatedBy || 'System Administrator'}</div>
                    </div>
                    
                    <div style="margin-top: 30px; font-size: 8pt; text-align: center; color: #666; padding-top: 15px; border-top: 1px solid #ddd;">
                        The results of the tests, calibrations and/ or measurements included in this document are traceable to Australian/ National Standards.
                    </div>
                </div>
            `;
            
            applyPageMargins();
        }
        
        function toggleEditMode(){
            isEditMode = !isEditMode;
            const panel = document.getElementById('editPanel');
            const btn = document.getElementById('editModeBtn');
            const editables = document.querySelectorAll('.editable');
            
            if(isEditMode){
                panel.classList.add('visible');
                btn.classList.add('active');
                btn.innerHTML = '<i class="fas fa-check"></i> Edit Mode ON';
            editables.forEach(el => {
                    el.setAttribute('contenteditable', 'true');
                });
                } else {
                panel.classList.remove('visible');
                btn.classList.remove('active');
                btn.innerHTML = '<i class="fas fa-edit"></i> Edit Mode';
                editables.forEach(el => {
                    el.removeAttribute('contenteditable');
                });
            }
        }
        
        function handleLogoUpload(event){
            const file = event.target.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e){
                customLogo = e.target.result;
                document.getElementById('certLogo').src = customLogo;
                document.getElementById('logoPreview').src = customLogo;
                document.getElementById('logoPreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
        
        function removeLogo(){
            customLogo = null;
            document.getElementById('certLogo').src = 'wika-logo.png';
            document.getElementById('logoPreview').style.display = 'none';
        }
        
        function applyPageMargins(){
            const page = document.querySelector('.page');
            if(page){
                page.style.padding = `${layoutSettings.marginTop}mm ${layoutSettings.marginLR}mm ${layoutSettings.marginBottom}mm ${layoutSettings.marginLR}mm`;
            }
        }
        
        function updateMargin(type, value){
            if(type === 'top'){
                layoutSettings.marginTop = value;
                document.getElementById('marginTopVal').textContent = value + 'mm';
            } else if(type === 'bottom'){
                layoutSettings.marginBottom = value;
                document.getElementById('marginBottomVal').textContent = value + 'mm';
            } else if(type === 'lr'){
                layoutSettings.marginLR = value;
                document.getElementById('marginLRVal').textContent = value + 'mm';
            }
            applyPageMargins();
        }
        
        function updateTitleSize(value){
            layoutSettings.titleSize = value;
            document.getElementById('titleSizeVal').textContent = value + 'pt';
            const title = document.getElementById('certTitle');
            if(title) title.style.fontSize = value + 'pt';
        }
        
        function updateBodySize(value){
            layoutSettings.bodySize = value;
            document.getElementById('bodySizeVal').textContent = value + 'pt';
            render(originalCert);
        }
        
        function setLineSpacing(value){
            layoutSettings.lineSpacing = value;
            document.querySelectorAll('#editPanel .btn-group button').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            render(originalCert);
        }
        
        function updateHeaderSpace(value){
            layoutSettings.headerSpace = value;
            document.getElementById('headerSpaceVal').textContent = value + 'px';
            render(originalCert);
        }
        
        function updateSectionSpace(value){
            layoutSettings.sectionSpace = value;
            document.getElementById('sectionSpaceVal').textContent = value + 'px';
            render(originalCert);
        }
        
        function updateFieldWidth(value){
            layoutSettings.fieldWidth = value;
            document.getElementById('fieldWidthVal').textContent = value + '%';
            const infoValues = document.querySelectorAll('.info-value');
            infoValues.forEach(el => {
                el.style.maxWidth = value + '%';
            });
        }
        
        function saveAllEdits(){
            if(!originalCert) return;
            
            // Save text edits
            const editables = document.querySelectorAll('[data-field]');
            const updates = {};
            editables.forEach(el => {
                const field = el.getAttribute('data-field');
                updates[field] = el.textContent;
            });
            Object.assign(originalCert, updates);
            
            // Save layout & logo
            originalCert.customLayout = layoutSettings;
            originalCert.customLogo = customLogo;
            
            // Save to localStorage
                try {
                    const all = JSON.parse(localStorage.getItem('torqueCertificates')||'[]');
                    const index = all.findIndex(c => c.id === originalCert.id);
                    if (index >= 0) {
                        all[index] = originalCert;
                        localStorage.setItem('torqueCertificates', JSON.stringify(all));
                    }
                    sessionStorage.setItem('currentCert', JSON.stringify(originalCert));
                alert('‚úÖ All changes saved successfully!');
            } catch(e) {
                alert('‚ùå Error saving: ' + e.message);
            }
        }
        
        function resetAll(){
            if(!confirm('Reset ALL changes (text, layout, logo)?')) return;
            customLogo = null;
            layoutSettings = {
                marginTop: 20, marginBottom: 20, marginLR: 20,
                titleSize: 18, bodySize: 10, lineSpacing: 1.5,
                headerSpace: 18, sectionSpace: 12, fieldWidth: 100
            };
            // Reset sliders
            document.getElementById('marginTop').value = 20;
            document.getElementById('marginBottom').value = 20;
            document.getElementById('marginLR').value = 20;
            document.getElementById('titleSize').value = 18;
            document.getElementById('bodySize').value = 10;
            document.getElementById('headerSpace').value = 18;
            document.getElementById('sectionSpace').value = 12;
            document.getElementById('fieldWidth').value = 100;
            // Update displays
            document.getElementById('marginTopVal').textContent = '20mm';
            document.getElementById('marginBottomVal').textContent = '20mm';
            document.getElementById('marginLRVal').textContent = '20mm';
            document.getElementById('titleSizeVal').textContent = '18pt';
            document.getElementById('bodySizeVal').textContent = '10pt';
            document.getElementById('headerSpaceVal').textContent = '18px';
            document.getElementById('sectionSpaceVal').textContent = '12px';
            document.getElementById('fieldWidthVal').textContent = '100%';
            document.getElementById('logoPreview').style.display = 'none';
            
            if(isEditMode) toggleEditMode();
            render(originalCert);
        }
        
        function downloadPDF(){
            window.print();
        }
        
        function goBack(){
            if(window.history.length > 1){
                history.back();
            } else {
                window.location.href = 'torque-trace.html';
            }
        }
        
        function toggleDragMode(){
            isDragMode = !isDragMode;
            const btn = document.getElementById('dragModeBtn');
            const sections = document.querySelectorAll('.draggable-section');
            
            if(isDragMode){
                btn.innerHTML = '<i class="fas fa-check"></i> Drag Mode ON';
                btn.style.background = '#059669';
                sections.forEach(el => {
                    el.classList.add('draggable');
                    el.setAttribute('draggable', 'true');
                });
                initDragHandlers();
            } else {
                btn.innerHTML = '<i class="fas fa-arrows-alt"></i> Enable Drag Mode';
                btn.style.background = '#10b981';
                sections.forEach(el => {
                    el.classList.remove('draggable');
                    el.removeAttribute('draggable');
                });
            }
        }
        
        function initDragHandlers(){
            const draggables = document.querySelectorAll('.draggable');
            const container = document.getElementById('certPage');
            
            draggables.forEach(draggable => {
                draggable.addEventListener('dragstart', handleDragStart);
                draggable.addEventListener('dragend', handleDragEnd);
            });
            
            container.addEventListener('dragover', handleDragOver);
            container.addEventListener('drop', handleDrop);
        }
        
        function handleDragStart(e){
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }
        
        function handleDragEnd(e){
            this.classList.remove('dragging');
            const draggables = document.querySelectorAll('.draggable');
            draggables.forEach(d => d.style.borderTop = '');
        }
        
        function handleDragOver(e){
            if (e.preventDefault) e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            const afterElement = getDragAfterElement(e.clientY);
            const draggables = document.querySelectorAll('.draggable');
            draggables.forEach(d => d.style.borderTop = '');
            
            if (afterElement && afterElement !== draggedElement) {
                afterElement.style.borderTop = '3px solid #10b981';
            }
            
            return false;
        }
        
        function handleDrop(e){
            if (e.stopPropagation) e.stopPropagation();
            e.preventDefault();
            
            if (draggedElement) {
                const afterElement = getDragAfterElement(e.clientY);
                const container = document.getElementById('certPage');
                
                if (afterElement == null) {
                    container.appendChild(draggedElement);
                } else {
                    container.insertBefore(draggedElement, afterElement);
                }
                
                const draggables = document.querySelectorAll('.draggable');
                draggables.forEach(d => d.style.borderTop = '');
            }
            
            return false;
        }
        
        function getDragAfterElement(y) {
            const draggableElements = [...document.querySelectorAll('.draggable:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        // Load certificate on page load
        (function(){
            const id = getParam('id');
            let cert = null;
            
            try {
                const tmp = sessionStorage.getItem('currentCert');
                if (tmp) {
                    const obj = JSON.parse(tmp);
                    if (!id || obj.id === id) cert = obj;
                }
                if (!cert) {
                    const all = JSON.parse(localStorage.getItem('torqueCertificates')||'[]');
                    cert = all.find(c=>c.id===id) || all[0] || null;
                }
            } catch(e) {}
            
            originalCert = cert;
            
            // Load saved layout settings if they exist
            if(cert && cert.customLayout){
                layoutSettings = cert.customLayout;
                document.getElementById('marginTop').value = layoutSettings.marginTop;
                document.getElementById('marginBottom').value = layoutSettings.marginBottom;
                document.getElementById('marginLR').value = layoutSettings.marginLR;
                document.getElementById('titleSize').value = layoutSettings.titleSize;
                document.getElementById('bodySize').value = layoutSettings.bodySize;
                document.getElementById('headerSpace').value = layoutSettings.headerSpace;
                document.getElementById('sectionSpace').value = layoutSettings.sectionSpace;
                if(layoutSettings.fieldWidth) document.getElementById('fieldWidth').value = layoutSettings.fieldWidth;
                updateMargin('top', layoutSettings.marginTop);
                updateMargin('bottom', layoutSettings.marginBottom);
                updateMargin('lr', layoutSettings.marginLR);
                document.getElementById('titleSizeVal').textContent = layoutSettings.titleSize + 'pt';
                document.getElementById('bodySizeVal').textContent = layoutSettings.bodySize + 'pt';
                document.getElementById('headerSpaceVal').textContent = layoutSettings.headerSpace + 'px';
                document.getElementById('sectionSpaceVal').textContent = layoutSettings.sectionSpace + 'px';
                if(layoutSettings.fieldWidth) document.getElementById('fieldWidthVal').textContent = layoutSettings.fieldWidth + '%';
            }
            
            if(cert && cert.customLogo){
                customLogo = cert.customLogo;
                document.getElementById('logoPreview').src = customLogo;
                document.getElementById('logoPreview').style.display = 'block';
            }
            
            render(cert);
            
            // Apply field width if set
            if(layoutSettings.fieldWidth && layoutSettings.fieldWidth !== 100){
                setTimeout(() => updateFieldWidth(layoutSettings.fieldWidth), 100);
            }
        })();
    </script>
</body>
</html>
