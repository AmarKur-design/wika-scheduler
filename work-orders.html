<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Orders List - Technician Scheduler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { display: flex; margin: 0; }
        .sidebar { width: 250px; min-height: 100vh; background: #1f2937; color: white; padding: 1.5rem 0; position: fixed; left: 0; top: 0; z-index: 100; }
        .sidebar-header { padding: 0 1.5rem 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 1rem; }
        .sidebar-user { font-size: 0.875rem; color: rgba(255,255,255,0.7); margin-top: 0.5rem; }
        .sidebar-nav { padding: 0; }
        .sidebar-btn { display: flex; align-items: center; padding: 0.75rem 1.5rem; color: rgba(255,255,255,0.8); transition: all 0.2s; cursor: pointer; border: none; background: none; width: 100%; text-align: left; text-decoration: none; }
        .sidebar-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .sidebar-btn.active { background: rgba(59, 130, 246, 0.2); color: white; border-left: 3px solid #3b82f6; }
        .sidebar-btn i { margin-right: 0.75rem; width: 20px; }
        .main-content { margin-left: 250px; flex: 1; min-height: 100vh; background: #f3f4f6; }
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .status-scheduled { background-color: #dbeafe; color: #1e40af; }
        .status-in-progress { background-color: #fef3c7; color: #92400e; }
        .status-completed { background-color: #d1fae5; color: #065f46; }
        .status-waiting-on-certs { background-color: #e9d5ff; color: #6b21a8; }
    </style>
</head>
<body>
    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h1 class="text-xl font-bold">WIKA Scheduler</h1>
            <div class="sidebar-user">
                <div id="userName"></div>
                <div class="text-xs" id="userRole"></div>
            </div>
        </div>
        <nav class="sidebar-nav">
            <a href="home.html" class="sidebar-btn">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
            <a href="calendar.html" class="sidebar-btn">
                <i class="fas fa-calendar-alt"></i>
                <span>Calendar</span>
            </a>
            <a href="manage-users.html" id="manageUsersBtn" class="sidebar-btn">
                <i class="fas fa-users-cog"></i>
                <span>Manage Users</span>
            </a>
            <a href="work-orders.html" class="sidebar-btn active">
                <i class="fas fa-list"></i>
                <span>Work Orders</span>
            </a>
            <a href="dashboard.html" class="sidebar-btn">
                <i class="fas fa-chart-line"></i>
                <span>Dashboard</span>
            </a>
            <button onclick="resetAllData()" class="sidebar-btn" style="margin-top: 1rem;">
                <i class="fas fa-redo"></i>
                <span>Reset Data</span>
            </button>
            <button onclick="logout()" class="sidebar-btn" style="margin-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1.5rem;">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </button>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-800">Work Orders List</h2>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Filters</h2>
            <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Work Order #</label>
                    <input id="workOrderNumberFilter" type="text" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Search by work order number..." onkeyup="filterWorkOrders()">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                    <select id="statusFilterMulti" multiple class="w-full border border-gray-300 rounded px-3 py-2" onchange="filterWorkOrders()" size="4">
                        <option value="scheduled">Scheduled</option>
                        <option value="in-progress">In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="waiting-on-certs">Waiting on Certs</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Tip: Hold Ctrl (Windows) or Cmd (Mac) to select multiple</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Technician</label>
                    <select id="technicianFilter" class="w-full border border-gray-300 rounded px-3 py-2" onchange="filterWorkOrders()">
                        <option value="">All Technicians</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Customer</label>
                    <input id="customerFilter" type="text" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Search customer..." onkeyup="filterWorkOrders()">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                    <input id="dateFilter" type="date" class="w-full border border-gray-300 rounded px-3 py-2" onchange="filterWorkOrders()">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Week</label>
                    <select id="weekFilter" class="w-full border border-gray-300 rounded px-3 py-2" onchange="filterWorkOrders()">
                        <option value="">All Weeks</option>
                        <option value="this-week">This Week</option>
                        <option value="next-week">Next Week</option>
                        <option value="last-week">Last Week</option>
                    </select>
                </div>
            </div>
            <div class="mt-4">
                <button onclick="clearFilters()" class="bg-gray-500 hover:bg-gray-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-times mr-2"></i>Clear Filters
                </button>
            </div>
        </div>

        <!-- Summary Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center">
                    <div class="p-2 bg-blue-100 rounded-lg">
                        <i class="fas fa-clipboard-list text-blue-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total Orders</p>
                        <p id="totalOrders" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center">
                    <div class="p-2 bg-yellow-100 rounded-lg">
                        <i class="fas fa-clock text-yellow-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">In Progress</p>
                        <p id="inProgressOrders" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center">
                    <div class="p-2 bg-green-100 rounded-lg">
                        <i class="fas fa-check text-green-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Completed</p>
                        <p id="completedOrders" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center">
                    <div class="p-2 bg-purple-100 rounded-lg">
                        <i class="fas fa-certificate text-purple-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Waiting on Certs</p>
                        <p id="waitingOrders" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Import Work Orders Section -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Import Work Orders</h2>
            <div class="flex items-center space-x-4">
                <button onclick="showImportModal()" class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded flex items-center">
                    <i class="fas fa-file-import mr-2"></i>
                    Import from CSV/Excel
                </button>
                <button onclick="downloadTemplate()" class="bg-gray-500 hover:bg-gray-700 text-white px-4 py-2 rounded flex items-center">
                    <i class="fas fa-download mr-2"></i>
                    Download Template
                </button>
            </div>
            <p class="text-sm text-gray-600 mt-2">Import work orders from a CSV or Excel file. You can assign a technician to all imported orders, or include technician names in your CSV file.</p>
        </div>

        <!-- Work Orders Table -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-semibold">All Work Orders</h2>
                <p id="tableSummary" class="text-sm text-gray-600 mt-1">Showing all work orders</p>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Work Order #</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Technician</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Work Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hours</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="workOrdersTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Work orders will be rendered here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Total Hours Summary -->
        <div class="bg-white rounded-lg shadow p-6 mt-6">
            <h2 class="text-xl font-semibold mb-4">Hours Summary</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="text-center">
                    <div class="text-3xl font-bold text-blue-600" id="totalFilteredHours">0</div>
                    <div class="text-sm text-gray-600">Total Hours (Filtered)</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-green-600" id="totalAllHours">0</div>
                    <div class="text-sm text-gray-600">Total Hours (All Orders)</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-purple-600" id="averageHoursPerOrder">0</div>
                    <div class="text-sm text-gray-600">Avg Hours per Order</div>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-200">
                <div class="text-sm text-gray-600">
                    <strong>Filtered Results:</strong> <span id="filteredSummary">Showing all work orders</span>
            </div>
        </div>
    </div>
    </div>

    <!-- Work Order Details Modal -->
        <div id="workOrderModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Work Order Details</h3>
                    <div id="workOrderDetails" class="text-sm text-gray-600">
                        <!-- Details will be populated here -->
                    </div>
                    <div class="flex justify-end mt-4">
                        <button onclick="closeWorkOrderModal()" class="bg-gray-500 hover:bg-gray-700 text-white px-4 py-2 rounded">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Work Order Edit Modal -->
        <div id="editWorkOrderModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
            <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Edit Work Order</h3>
                    <form id="editWorkOrderForm" onsubmit="updateWorkOrder(event)">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Work Order Number</label>
                                <input id="editWorkOrderNumber" type="text" required class="w-full border border-gray-300 rounded px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Technician</label>
                                <select id="editTechnician" required class="w-full border border-gray-300 rounded px-3 py-2">
                                    <option value="">Select Technician</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Work Type</label>
                            <input id="editWorkType" type="text" required class="w-full border border-gray-300 rounded px-3 py-2">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div class="relative">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Item/Make</label>
                                <input id="editItemMake" type="text" class="w-full border border-gray-300 rounded px-3 py-2" 
                                       placeholder="Start typing..." 
                                       oninput="showItemSuggestions()" 
                                       onfocus="showItemSuggestions()"
                                       autocomplete="off">
                                <div id="itemSuggestions" class="hidden absolute z-50 w-full bg-white border border-gray-300 rounded-b shadow-lg max-h-48 overflow-y-auto"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Model</label>
                                <input id="editItemModel" type="text" class="w-full border border-gray-300 rounded px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Serial Number</label>
                                <input id="editItemSerial" type="text" class="w-full border border-gray-300 rounded px-3 py-2">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Customer Name</label>
                                <input id="editCustomerName" type="text" required class="w-full border border-gray-300 rounded px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Hours Required</label>
                                <input id="editHoursRequired" type="number" step="0.1" required class="w-full border border-gray-300 rounded px-3 py-2">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                                <input id="editStartDate" type="date" required class="w-full border border-gray-300 rounded px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                <select id="editStatus" class="w-full border border-gray-300 rounded px-3 py-2">
                                    <option value="scheduled">Scheduled</option>
                                    <option value="in-progress">In Progress</option>
                                    <option value="completed">Completed</option>
                                    <option value="waiting-on-certs">Waiting on Certs</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                            <textarea id="editNotes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Add notes about this work order..."></textarea>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Attachment</label>
                            <input id="editAttachment" type="file" class="w-full border border-gray-300 rounded px-3 py-2" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                            <p class="text-sm text-gray-500 mt-1">PDF, Word docs, or image files</p>
                        </div>
                        <div class="flex justify-end space-x-4">
                            <button type="button" onclick="closeEditModal()" class="bg-gray-500 hover:bg-gray-700 text-white px-4 py-2 rounded">
                                Cancel
                            </button>
                            <button type="submit" class="bg-green-500 hover:bg-green-700 text-white px-4 py-2 rounded">
                                Update Work Order
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Work Orders Modal -->
    <div id="importModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Import Work Orders</h3>
                
                <!-- File Upload Section -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select File</label>
                    <input id="importFile" type="file" accept=".csv,.xlsx,.xls" class="w-full border border-gray-300 rounded px-3 py-2" onchange="handleFileSelect(event)">
                    <p class="text-sm text-gray-500 mt-1">Supported formats: CSV, Excel (.xlsx, .xls)</p>
                </div>

                <!-- Technician Assignment Section -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Assign Technician to All Imported Orders</label>
                    <select id="importTechnician" class="w-full border border-gray-300 rounded px-3 py-2">
                        <option value="">No Technician Assignment</option>
                    </select>
                    <p class="text-sm text-gray-500 mt-1">Assign a technician to all imported work orders. If your CSV file contains a "Technician" column, those values will override this bulk assignment.</p>
                </div>

                <!-- Preview Section -->
                <div id="importPreview" class="mb-6 hidden">
                    <h4 class="text-md font-medium text-gray-900 mb-3">Preview (First 5 rows)</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 border border-gray-300">
                            <thead class="bg-gray-50">
                                <tr id="previewHeaders">
                                    <!-- Headers will be populated here -->
                                </tr>
                            </thead>
                            <tbody id="previewRows" class="bg-white divide-y divide-gray-200">
                                <!-- Preview rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Import Results -->
                <div id="importResults" class="mb-6 hidden">
                    <h4 class="text-md font-medium text-gray-900 mb-3">Import Results</h4>
                    <div id="importResultsContent" class="p-4 bg-gray-50 rounded-lg">
                        <!-- Results will be shown here -->
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-end space-x-4">
                    <button onclick="closeImportModal()" class="bg-gray-500 hover:bg-gray-700 text-white px-4 py-2 rounded">
                        Cancel
                    </button>
                    <button id="importButton" onclick="importWorkOrders()" class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded hidden">
                        Import Work Orders
                    </button>
                </div>
            </div>
        </div>
    </div>

<script>
// Check if user is logged in
const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
if (!currentUser) {
    window.location.href = 'login.html';
}

let technicians = [];
let workOrders = [];
        let filteredWorkOrders = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupUserInfo();
            loadData();
            // Preload defaults: this week + statuses Scheduled/In Progress/Waiting on Certs
            document.getElementById('weekFilter').value = 'this-week';
            // Allow multi-select status via checkboxes (added below), fallback to single-select if not present
            const statusMulti = document.getElementById('statusFilterMulti');
            if (statusMulti && statusMulti.tagName === 'SELECT') {
                Array.from(statusMulti.options).forEach(opt => {
                    opt.selected = ['scheduled','in-progress','waiting-on-certs'].includes(opt.value);
                });
            }
            populateTechnicianFilter();
            filterWorkOrders();
            updateSummaryStats();
            updateHoursSummary();
        });

        function setupUserInfo() {
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
            
            // Hide Manage Users for non-admins
            const manageUsersBtn = document.getElementById('manageUsersBtn');
            if (manageUsersBtn && currentUser.role !== 'admin') {
                manageUsersBtn.style.display = 'none';
            }
        }

        function logout() {
            sessionStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }

        function resetAllData() {
            if (confirm('⚠️ WARNING: This will delete ALL technicians and work orders and reset to defaults. This cannot be undone. Continue?')) {
                localStorage.clear();
                location.reload();
            }
        }

        // Data management
        function loadData() {
            const storedTechnicians = localStorage.getItem('technicians');
            const storedWorkOrders = localStorage.getItem('workOrders');
            
            if (storedTechnicians) {
                technicians = JSON.parse(storedTechnicians);
            }
            
            if (storedWorkOrders) {
                workOrders = JSON.parse(storedWorkOrders);
                
                // Filter work orders based on user role
                if (currentUser.role === 'technician' && currentUser.technicianId) {
                    workOrders = workOrders.filter(wo => wo.technicianId === currentUser.technicianId);
                }
            }
        }

        function refreshData() {
            loadData();
            populateTechnicianFilter();
            filterWorkOrders();
            updateSummaryStats();
            updateHoursSummary();
        }

        // Filter functions
        function populateTechnicianFilter() {
            const filterSelect = document.getElementById('technicianFilter');
            filterSelect.innerHTML = '<option value="">All Technicians</option>';
            
            technicians.forEach(technician => {
                const option = document.createElement('option');
                option.value = technician.id;
                option.textContent = technician.name;
                filterSelect.appendChild(option);
            });
        }

        function filterWorkOrders() {
            const workOrderNumberFilter = document.getElementById('workOrderNumberFilter').value.toLowerCase();
            // Support multi-select checkboxes; fallback to single-select if present
            let selectedStatuses = [];
            const multi = document.getElementById('statusFilterMulti');
            if (multi && multi.tagName === 'SELECT') {
                selectedStatuses = Array.from(multi.selectedOptions).map(o => o.value);
            } else if (multi) {
                selectedStatuses = Array.from(multi.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
            } else {
                const single = document.getElementById('statusFilter');
                selectedStatuses = single && single.value ? [single.value] : [];
            }
            const technicianFilter = document.getElementById('technicianFilter').value;
            const customerFilter = document.getElementById('customerFilter').value.toLowerCase();
            const dateFilter = document.getElementById('dateFilter').value;
            const weekFilter = document.getElementById('weekFilter').value;
            
            filteredWorkOrders = workOrders.filter(workOrder => {
                const matchesWorkOrderNumber = !workOrderNumberFilter || workOrder.workOrderNumber.toLowerCase().includes(workOrderNumberFilter);
                const matchesStatus = selectedStatuses.length === 0 || selectedStatuses.includes(workOrder.status || 'scheduled');
                const matchesTechnician = !technicianFilter || workOrder.technicianId.toString() === technicianFilter;
                const matchesCustomer = !customerFilter || workOrder.customerName.toLowerCase().includes(customerFilter);
                const matchesDate = !dateFilter || workOrder.startDate === dateFilter;
                const matchesWeek = !weekFilter || isWorkOrderInWeek(workOrder.startDate, weekFilter);
                
                return matchesWorkOrderNumber && matchesStatus && matchesTechnician && matchesCustomer && matchesDate && matchesWeek;
            });
            
            renderWorkOrdersTable();
            updateSummaryStats();
            updateHoursSummary();
        }

        function clearFilters() {
            document.getElementById('workOrderNumberFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('technicianFilter').value = '';
            document.getElementById('customerFilter').value = '';
            document.getElementById('dateFilter').value = '';
            document.getElementById('weekFilter').value = '';
            filterWorkOrders();
        }

        // Rendering functions
        function renderWorkOrdersTable() {
            const tbody = document.getElementById('workOrdersTableBody');
            tbody.innerHTML = '';
            
            if (filteredWorkOrders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                            No work orders found matching your filters
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredWorkOrders.forEach(workOrder => {
                const technician = technicians.find(t => t.id === workOrder.technicianId);
                const technicianName = technician ? technician.name : 'Unknown';
                const statusClass = getStatusClass(workOrder.status);
                const statusText = getStatusText(workOrder.status);
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${workOrder.workOrderNumber}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${workOrder.customerName}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${technicianName}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${workOrder.workType}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${workOrder.hoursRequired}h
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${new Date(workOrder.startDate).toLocaleDateString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="status-badge ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <button onclick="showWorkOrderDetails(${workOrder.id})" class="text-blue-600 hover:text-blue-900 mr-2">
                            <i class="fas fa-eye"></i> View
                        </button>
                        <button onclick="editWorkOrder(${workOrder.id})" class="text-green-600 hover:text-green-900 mr-2">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button onclick="deleteWorkOrder(${workOrder.id})" class="text-red-600 hover:text-red-900">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function showWorkOrderDetails(workOrderId) {
            const workOrder = workOrders.find(wo => wo.id === workOrderId);
            if (!workOrder) return;
            
            const technician = technicians.find(t => t.id === workOrder.technicianId);
            const technicianName = technician ? technician.name : 'Unknown';
            
            // Get item information if itemId exists
            let itemInfo = '';
            let calibrationButtons = '';
            if (workOrder.itemId) {
                const items = JSON.parse(localStorage.getItem('items') || '[]');
                const item = items.find(i => i.id === workOrder.itemId);
                if (item) {
                    itemInfo = `
                        <div><strong>Item:</strong> ${item.make} ${item.model}</div>
                        <div><strong>Serial Number:</strong> ${item.serialNumber}</div>
                        <div><strong>Barcode:</strong> ${item.barcode}</div>
                    `;
                }
            } else if (workOrder.itemMake && workOrder.itemModel) {
                itemInfo = `
                    <div><strong>Item:</strong> ${workOrder.itemMake} ${workOrder.itemModel}</div>
                    <div><strong>Serial Number:</strong> ${workOrder.itemSerialNumber || 'N/A'}</div>
                `;
            }
            
            // Always show calibration buttons - check if part has calibration type
            calibrationButtons = generateCalibrationButtons(workOrder.workType, workOrderId);
            
            const details = `
                <div class="space-y-3">
                    <div><strong>Work Order #:</strong> ${workOrder.workOrderNumber}</div>
                    <div><strong>Customer:</strong> ${workOrder.customerName}</div>
                    <div><strong>Technician:</strong> ${technicianName}</div>
                    <div><strong>Work Type:</strong> ${workOrder.workType}</div>
                    <div><strong>Hours Required:</strong> ${workOrder.hoursRequired}h</div>
                    <div><strong>Start Date:</strong> ${new Date(workOrder.startDate).toLocaleDateString()}</div>
                    <div><strong>Status:</strong> <span class="status-badge ${getStatusClass(workOrder.status)}">${getStatusText(workOrder.status)}</span></div>
                    ${itemInfo}
                    <div><strong>Notes:</strong> ${workOrder.notes || 'None'}</div>
                    <div><strong>Attachment:</strong> ${workOrder.attachment || 'None'}</div>
                    <div class="mt-4 pt-3 border-t border-gray-200"><strong>Calibration Actions:</strong><div class="mt-2 flex flex-wrap gap-2">${calibrationButtons}</div></div>
                </div>
            `;
            
            document.getElementById('workOrderDetails').innerHTML = details;
            document.getElementById('workOrderModal').classList.remove('hidden');
        }

        function closeWorkOrderModal() {
            document.getElementById('workOrderModal').classList.add('hidden');
        }

        function deleteWorkOrder(workOrderId) {
            if (confirm('Are you sure you want to delete this work order?')) {
                workOrders = workOrders.filter(wo => wo.id !== workOrderId);
                localStorage.setItem('workOrders', JSON.stringify(workOrders));
                filterWorkOrders();
                updateSummaryStats();
                alert('Work order deleted successfully!');
            }
        }

        // Utility functions
        function getStatusClass(status) {
            switch(status) {
                case 'completed': return 'status-completed';
                case 'in-progress': return 'status-in-progress';
                case 'waiting-on-certs': return 'status-waiting-on-certs';
                default: return 'status-scheduled';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'completed': return 'Completed';
                case 'in-progress': return 'In Progress';
                case 'waiting-on-certs': return 'Waiting on Certs';
                default: return 'Scheduled';
            }
        }

        function updateSummaryStats() {
            const total = workOrders.length;
            const inProgress = workOrders.filter(wo => wo.status === 'in-progress').length;
            const completed = workOrders.filter(wo => wo.status === 'completed').length;
            const waiting = workOrders.filter(wo => wo.status === 'waiting-on-certs').length;
            
            document.getElementById('totalOrders').textContent = total;
            document.getElementById('inProgressOrders').textContent = inProgress;
            document.getElementById('completedOrders').textContent = completed;
            document.getElementById('waitingOrders').textContent = waiting;
            
            // Update table summary
            const summary = filteredWorkOrders.length === workOrders.length 
                ? `Showing all ${total} work orders`
                : `Showing ${filteredWorkOrders.length} of ${total} work orders`;
            document.getElementById('tableSummary').textContent = summary;
        }

        // Edit Work Order Functions
        function editWorkOrder(workOrderId) {
            const workOrder = workOrders.find(wo => wo.id === workOrderId);
            if (!workOrder) return;
            
            // Populate edit form with current work order data
            document.getElementById('editWorkOrderNumber').value = workOrder.workOrderNumber;
            document.getElementById('editWorkType').value = workOrder.workType;
            document.getElementById('editCustomerName').value = workOrder.customerName;
            document.getElementById('editHoursRequired').value = workOrder.hoursRequired;
            document.getElementById('editStartDate').value = workOrder.startDate;
            document.getElementById('editStatus').value = workOrder.status || 'scheduled';
            document.getElementById('editNotes').value = workOrder.notes || '';
            
            // Populate item fields if they exist
            document.getElementById('editItemMake').value = workOrder.itemMake || '';
            document.getElementById('editItemModel').value = workOrder.itemModel || '';
            document.getElementById('editItemSerial').value = workOrder.itemSerial || '';
            if (workOrder.itemId) {
                document.getElementById('editItemMake').dataset.selectedItemId = workOrder.itemId;
            }
            
            // Populate technician dropdown
            const technicianSelect = document.getElementById('editTechnician');
            technicianSelect.innerHTML = '<option value="">Select Technician</option>';
            technicians.forEach(technician => {
                const option = document.createElement('option');
                option.value = technician.id;
                option.textContent = technician.name;
                if (technician.id === workOrder.technicianId) {
                    option.selected = true;
                }
                technicianSelect.appendChild(option);
            });
            
            // Store the work order ID for updating
            document.getElementById('editWorkOrderForm').dataset.workOrderId = workOrderId;
            
            // Show the edit modal
            document.getElementById('editWorkOrderModal').classList.remove('hidden');
        }

        function updateWorkOrder(event) {
            event.preventDefault();
            
            const workOrderId = parseInt(document.getElementById('editWorkOrderForm').dataset.workOrderId);
            const workOrderIndex = workOrders.findIndex(wo => wo.id === workOrderId);
            
            if (workOrderIndex === -1) {
                alert('Work order not found!');
                return;
            }
            
            // Auto-create or link item
            const itemId = autoCreateOrLinkItem();
            
            // Get form data
            const updatedWorkOrder = {
                id: workOrderId,
                workOrderNumber: document.getElementById('editWorkOrderNumber').value,
                technicianId: parseInt(document.getElementById('editTechnician').value),
                workType: document.getElementById('editWorkType').value,
                customerName: document.getElementById('editCustomerName').value,
                hoursRequired: parseFloat(document.getElementById('editHoursRequired').value),
                startDate: document.getElementById('editStartDate').value,
                status: document.getElementById('editStatus').value,
                notes: document.getElementById('editNotes').value,
                attachment: document.getElementById('editAttachment').files[0]?.name || workOrders[workOrderIndex].attachment || '',
                // Item fields
                itemId: itemId,
                itemMake: document.getElementById('editItemMake').value,
                itemModel: document.getElementById('editItemModel').value,
                itemSerial: document.getElementById('editItemSerial').value
            };
            
            // Update the work order
            workOrders[workOrderIndex] = updatedWorkOrder;
            
            // Save to localStorage
            localStorage.setItem('workOrders', JSON.stringify(workOrders));
            
            // Refresh the display
            filterWorkOrders();
            updateSummaryStats();
            
            // Close modal
            closeEditModal();
            
            if (itemId && !document.getElementById('editItemMake').dataset.selectedItemId) {
                alert('Work order updated and new item created automatically!');
            } else {
                alert('Work order updated successfully!');
            }
        }

        function closeEditModal() {
            document.getElementById('editWorkOrderModal').classList.add('hidden');
            document.getElementById('editWorkOrderForm').reset();
            document.getElementById('itemSuggestions').classList.add('hidden');
        }

        // ============================================================================
        // ITEM AUTOCOMPLETE FUNCTIONALITY
        // ============================================================================
        
        function showItemSuggestions() {
            const input = document.getElementById('editItemMake');
            const query = input.value.toLowerCase().trim();
            const suggestionsDiv = document.getElementById('itemSuggestions');
            
            if (query.length < 2) {
                suggestionsDiv.classList.add('hidden');
                return;
            }
            
            // Load items from database
            const items = JSON.parse(localStorage.getItem('items') || '[]');
            
            // Filter items by make, model, or serial number
            const matches = items.filter(item => 
                item.make.toLowerCase().includes(query) ||
                item.model.toLowerCase().includes(query) ||
                item.serialNumber.toLowerCase().includes(query) ||
                item.barcode.toLowerCase().includes(query)
            ).slice(0, 10); // Limit to 10 suggestions
            
            if (matches.length === 0) {
                suggestionsDiv.innerHTML = `
                    <div class="px-4 py-2 text-sm text-gray-500 italic">
                        No existing items found. Keep typing to create new item.
                    </div>
                `;
                suggestionsDiv.classList.remove('hidden');
                return;
            }
            
            suggestionsDiv.innerHTML = matches.map(item => `
                <div class="px-4 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100"
                     onclick="selectExistingItem(${item.id})">
                    <div class="font-semibold text-sm">${item.make} ${item.model}</div>
                    <div class="text-xs text-gray-600">SN: ${item.serialNumber} | Barcode: ${item.barcode}</div>
                </div>
            `).join('');
            
            suggestionsDiv.classList.remove('hidden');
        }
        
        function selectExistingItem(itemId) {
            const items = JSON.parse(localStorage.getItem('items') || '[]');
            const item = items.find(i => i.id === itemId);
            
            if (item) {
                document.getElementById('editItemMake').value = item.make;
                document.getElementById('editItemModel').value = item.model;
                document.getElementById('editItemSerial').value = item.serialNumber;
                document.getElementById('editItemMake').dataset.selectedItemId = item.id;
                document.getElementById('itemSuggestions').classList.add('hidden');
            }
        }
        
        // Close suggestions when clicking outside
        document.addEventListener('click', function(event) {
            const suggestionsDiv = document.getElementById('itemSuggestions');
            const input = document.getElementById('editItemMake');
            
            if (suggestionsDiv && input && 
                !suggestionsDiv.contains(event.target) && 
                event.target !== input) {
                suggestionsDiv.classList.add('hidden');
            }
        });
        
        function autoCreateOrLinkItem() {
            const make = document.getElementById('editItemMake').value.trim();
            const model = document.getElementById('editItemModel').value.trim();
            const serial = document.getElementById('editItemSerial').value.trim();
            const selectedItemId = document.getElementById('editItemMake').dataset.selectedItemId;
            
            if (!make || !model || !serial) {
                return null; // No item data entered
            }
            
            // Check if user selected an existing item
            if (selectedItemId) {
                return parseInt(selectedItemId);
            }
            
            // Check if item already exists in database
            let items = JSON.parse(localStorage.getItem('items') || '[]');
            const existingItem = items.find(item => 
                item.make === make && 
                item.model === model && 
                item.serialNumber === serial
            );
            
            if (existingItem) {
                return existingItem.id;
            }
            
            // Create new item
            const newItem = {
                id: Date.now(),
                barcode: generateBarcode(),
                make: make,
                model: model,
                serialNumber: serial,
                createdDate: new Date().toISOString(),
                createdFrom: 'work-order'
            };
            
            items.push(newItem);
            localStorage.setItem('items', JSON.stringify(items));
            
            console.log('Auto-created new item:', newItem);
            return newItem.id;
        }
        
        function generateBarcode() {
            // Generate simple barcode (can be enhanced)
            return 'WIKA' + Date.now().toString().slice(-8);
        }

        // Week filtering helper function
        function isWorkOrderInWeek(workOrderDate, weekFilter) {
            const orderDate = new Date(workOrderDate);
            const today = new Date();
            
            switch(weekFilter) {
                case 'this-week':
                    return isDateInWeek(orderDate, getWeekStart(today));
                case 'next-week':
                    const nextWeekStart = new Date(today);
                    nextWeekStart.setDate(today.getDate() + 7);
                    return isDateInWeek(orderDate, getWeekStart(nextWeekStart));
                case 'last-week':
                    const lastWeekStart = new Date(today);
                    lastWeekStart.setDate(today.getDate() - 7);
                    return isDateInWeek(orderDate, getWeekStart(lastWeekStart));
                default:
                    return true;
            }
        }

        function getWeekStart(date) {
            const weekStart = new Date(date);
            weekStart.setDate(date.getDate() - date.getDay());
            return weekStart;
        }

        function isDateInWeek(date, weekStart) {
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            return date >= weekStart && date <= weekEnd;
        }

        // Hours summary functions
        function updateHoursSummary() {
            const totalFilteredHours = filteredWorkOrders.reduce((sum, wo) => sum + wo.hoursRequired, 0);
            const totalAllHours = workOrders.reduce((sum, wo) => sum + wo.hoursRequired, 0);
            const averageHoursPerOrder = filteredWorkOrders.length > 0 ? (totalFilteredHours / filteredWorkOrders.length).toFixed(1) : 0;
            
            document.getElementById('totalFilteredHours').textContent = totalFilteredHours.toFixed(1);
            document.getElementById('totalAllHours').textContent = totalAllHours.toFixed(1);
            document.getElementById('averageHoursPerOrder').textContent = averageHoursPerOrder;
            
            // Update filtered summary text
            const summary = filteredWorkOrders.length === workOrders.length 
                ? `Showing all ${workOrders.length} work orders (${totalAllHours.toFixed(1)}h total)`
                : `Showing ${filteredWorkOrders.length} of ${workOrders.length} work orders (${totalFilteredHours.toFixed(1)}h filtered)`;
            document.getElementById('filteredSummary').textContent = summary;
        }

        // Import functionality
        let importData = [];
        let importHeaders = [];

        function showImportModal() {
            // Populate technician dropdown
            const technicianSelect = document.getElementById('importTechnician');
            technicianSelect.innerHTML = '<option value="">No Technician Assignment</option>';
            
            technicians.forEach(tech => {
                const option = document.createElement('option');
                option.value = tech.id;
                option.textContent = tech.name;
                technicianSelect.appendChild(option);
            });

            // Reset modal state
            document.getElementById('importFile').value = '';
            document.getElementById('importPreview').classList.add('hidden');
            document.getElementById('importResults').classList.add('hidden');
            document.getElementById('importButton').classList.add('hidden');
            
            document.getElementById('importModal').classList.remove('hidden');
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.add('hidden');
            importData = [];
            importHeaders = [];
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                
                if (file.name.endsWith('.csv')) {
                    parseCSV(content);
                } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    // For Excel files, we'll use a simple approach
                    alert('Excel file parsing requires additional libraries. Please convert to CSV format for now.');
                    return;
                }
            };
            
            reader.readAsText(file);
        }

        function parseCSV(content) {
            const lines = content.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                alert('File must contain at least a header row and one data row.');
                return;
            }

            // Parse headers
            importHeaders = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            
            // Parse data rows
            importData = [];
            for (let i = 1; i < Math.min(lines.length, 6); i++) { // Show first 5 rows for preview
                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                if (values.length === importHeaders.length) {
                    importData.push(values);
                }
            }

            showPreview();
        }

        function showPreview() {
            const previewDiv = document.getElementById('importPreview');
            const headersRow = document.getElementById('previewHeaders');
            const rowsBody = document.getElementById('previewRows');

            // Clear previous content
            headersRow.innerHTML = '';
            rowsBody.innerHTML = '';

            // Add headers
            importHeaders.forEach(header => {
                const th = document.createElement('th');
                th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                th.textContent = header;
                headersRow.appendChild(th);
            });

            // Add preview rows
            importData.forEach(row => {
                const tr = document.createElement('tr');
                row.forEach(cell => {
                    const td = document.createElement('td');
                    td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-900';
                    td.textContent = cell;
                    tr.appendChild(td);
                });
                rowsBody.appendChild(tr);
            });

            previewDiv.classList.remove('hidden');
            document.getElementById('importButton').classList.remove('hidden');
        }

        function importWorkOrders() {
            const selectedTechnicianId = document.getElementById('importTechnician').value;
            let importedCount = 0;
            let errorCount = 0;
            const errors = [];

            // Parse all data (not just preview)
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file first.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const lines = content.split('\n').filter(line => line.trim());
                
                if (lines.length < 2) {
                    alert('File must contain at least a header row and one data row.');
                    return;
                }

                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                
                // Process all data rows
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                    
                    if (values.length !== headers.length) {
                        errorCount++;
                        errors.push(`Row ${i + 1}: Column count mismatch`);
                        continue;
                    }

                    try {
                        const workOrder = createWorkOrderFromRow(headers, values, selectedTechnicianId);
                        if (workOrder) {
                            workOrders.push(workOrder);
                            importedCount++;
                        } else {
                            errorCount++;
                            errors.push(`Row ${i + 1}: Invalid data`);
                        }
                    } catch (error) {
                        errorCount++;
                        errors.push(`Row ${i + 1}: ${error.message}`);
                    }
                }

                // Save data
                localStorage.setItem('workOrders', JSON.stringify(workOrders));
                
                // Show results
                showImportResults(importedCount, errorCount, errors);
                
                // Refresh the page
                refreshData();
            };
            
            reader.readAsText(file);
        }

        function createWorkOrderFromRow(headers, values, bulkTechnicianId) {
            const workOrder = {
                id: Date.now() + Math.random(), // Unique ID
                workOrderNumber: '',
                salesOrderNumber: '',
                customerPO: '',
                priority: 'standard',
                technicianId: bulkTechnicianId ? parseInt(bulkTechnicianId) : null,
                partNumber: '',
                workType: '',
                customerName: '',
                customerAccount: '',
                customerStreet: '',
                customerCity: '',
                hoursRequired: 1,
                startDate: new Date().toISOString().split('T')[0],
                startTime: '09:00',
                status: 'scheduled',
                location: 'in-lab',
                certificationType: 'TRACE',
                notes: '',
                attachment: '',
                itemMake: '',
                itemModel: '',
                itemSerialNumber: '',
                itemId: null
            };

            // Map CSV columns to work order fields
            headers.forEach((header, index) => {
                const value = values[index];
                const headerLower = header.toLowerCase();

                if (headerLower.includes('work order') || headerLower.includes('wo')) {
                    workOrder.workOrderNumber = value;
                } else if (headerLower.includes('sales order') || headerLower.includes('so')) {
                    workOrder.salesOrderNumber = value;
                } else if (headerLower.includes('customer po') || headerLower.includes('po')) {
                    workOrder.customerPO = value;
                } else if (headerLower.includes('customer') && !headerLower.includes('po')) {
                    workOrder.customerName = value;
                } else if (headerLower.includes('work type') || headerLower.includes('type')) {
                    workOrder.workType = value;
                } else if (headerLower.includes('hours') || headerLower.includes('hour')) {
                    workOrder.hoursRequired = parseFloat(value) || 1;
                } else if (headerLower.includes('date') || headerLower.includes('start date')) {
                    workOrder.startDate = value;
                } else if (headerLower.includes('status')) {
                    workOrder.status = value.toLowerCase();
                } else if (headerLower.includes('technician')) {
                    // Find technician by name and set technicianId (overrides bulk assignment)
                    const technician = technicians.find(tech => tech.name.toLowerCase() === value.toLowerCase());
                    if (technician) {
                        workOrder.technicianId = technician.id;
                    }
                } else if (headerLower.includes('make') || headerLower.includes('item make')) {
                    workOrder.itemMake = value;
                } else if (headerLower.includes('model') || headerLower.includes('item model')) {
                    workOrder.itemModel = value;
                } else if (headerLower.includes('serial') || headerLower.includes('serial number')) {
                    workOrder.itemSerialNumber = value;
                } else if (headerLower.includes('notes') || headerLower.includes('note')) {
                    workOrder.notes = value;
                } else if (headerLower.includes('priority')) {
                    workOrder.priority = value.toLowerCase();
                } else if (headerLower.includes('certification') || headerLower.includes('cert')) {
                    workOrder.certificationType = value.toUpperCase();
                }
            });

            // Validate required fields
            if (!workOrder.workOrderNumber) {
                workOrder.workOrderNumber = 'WO-' + Date.now().toString().slice(-6);
            }
            if (!workOrder.customerName) {
                workOrder.customerName = 'Imported Customer';
            }
            if (!workOrder.workType) {
                workOrder.workType = 'Calibration';
            }

            return workOrder;
        }

        function showImportResults(importedCount, errorCount, errors) {
            const resultsDiv = document.getElementById('importResults');
            const resultsContent = document.getElementById('importResultsContent');
            
            let html = `
                <div class="mb-4">
                    <div class="text-lg font-semibold text-green-600 mb-2">✓ ${importedCount} work orders imported successfully</div>
                    ${errorCount > 0 ? `<div class="text-lg font-semibold text-red-600 mb-2">✗ ${errorCount} errors occurred</div>` : ''}
                </div>
            `;
            
            if (errors.length > 0) {
                html += `
                    <div class="mb-4">
                        <h5 class="font-semibold text-gray-700 mb-2">Errors:</h5>
                        <ul class="list-disc list-inside text-sm text-gray-600">
                            ${errors.map(error => `<li>${error}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            resultsContent.innerHTML = html;
            resultsDiv.classList.remove('hidden');
        }

        function downloadTemplate() {
            const headers = [
                'Work Order Number',
                'Sales Order Number', 
                'Customer PO',
                'Customer Name',
                'Work Type',
                'Hours Required',
                'Start Date',
                'Status',
                'Technician',
                'Item Make',
                'Item Model',
                'Serial Number',
                'Notes',
                'Priority',
                'Certification Type'
            ];

            const sampleData = [
                'WO-001',
                'SO-001',
                'PO-12345',
                'Sample Customer',
                'Calibration',
                '2',
                '2025-10-25',
                'scheduled',
                'Andres Correa',
                'Fluke',
                '8846A',
                'SN123456',
                'Sample work order',
                'standard',
                'TRACE'
            ];

            const csvContent = [headers.join(','), sampleData.join(',')].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'work_orders_template.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function generateCalibrationButtons(workType, workOrderId) {
            // Get parts database to check calibration types
            const partsDatabase = JSON.parse(localStorage.getItem('partsDatabase') || '[]');
            
            // Find if any part matches this work type and has a calibration type
            const matchingPart = partsDatabase.find(part => 
                part.workType && part.workType.toLowerCase().includes(workType.toLowerCase()) && 
                part.calibrationType
            );
            
            const baseUrl = window.location.origin;
            let buttonsHtml = '';

            const calibrationPages = {
                'torque-trace': `${baseUrl}/torque-trace.html?workOrderId=${workOrderId}`,
                'electrical': `${baseUrl}/electrical.html?workOrderId=${workOrderId}`,
                'dimensional': `${baseUrl}/dimensional.html?workOrderId=${workOrderId}`,
                'pressure': `${baseUrl}/pressure.html?workOrderId=${workOrderId}`,
                'temperature': `${baseUrl}/temperature.html?workOrderId=${workOrderId}`
            };

            const buttonLabels = {
                'torque-trace': 'Go to Torque Calibration',
                'electrical': 'Go to Electrical Calibration',
                'dimensional': 'Go to Dimensional Calibration',
                'pressure': 'Go to Pressure Calibration',
                'temperature': 'Go to Temperature Calibration'
            };

            const buttonColors = {
                'torque-trace': 'bg-blue-500 hover:bg-blue-700',
                'electrical': 'bg-green-500 hover:bg-green-700',
                'dimensional': 'bg-purple-500 hover:bg-purple-700',
                'pressure': 'bg-red-500 hover:bg-red-700',
                'temperature': 'bg-yellow-500 hover:bg-yellow-700'
            };

            const disabledColors = {
                'torque-trace': 'bg-gray-300 text-gray-500 cursor-not-allowed',
                'electrical': 'bg-gray-300 text-gray-500 cursor-not-allowed',
                'dimensional': 'bg-gray-300 text-gray-500 cursor-not-allowed',
                'pressure': 'bg-gray-300 text-gray-500 cursor-not-allowed',
                'temperature': 'bg-gray-300 text-gray-500 cursor-not-allowed'
            };

            // Always show all calibration buttons
            Object.keys(calibrationPages).forEach(calibrationType => {
                const isActive = matchingPart && matchingPart.calibrationType === calibrationType;
                const buttonClass = isActive ? buttonColors[calibrationType] : disabledColors[calibrationType];
                const buttonText = isActive ? buttonLabels[calibrationType] : `${buttonLabels[calibrationType]} (Not Linked)`;
                const onClick = isActive ? `href="${calibrationPages[calibrationType]}" target="_blank"` : 'href="#" onclick="return false;"';
                
                buttonsHtml += `
                    <a ${onClick} class="${buttonClass} text-white px-3 py-1 rounded text-sm flex items-center">
                        <i class="fas fa-flask mr-1"></i> ${buttonText}
                    </a>
                `;
            });

            return buttonsHtml;
        }
    </script>
</body>
</html>
