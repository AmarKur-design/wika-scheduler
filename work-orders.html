<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Orders List - Technician Scheduler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .status-scheduled { background-color: #dbeafe; color: #1e40af; }
        .status-in-progress { background-color: #fef3c7; color: #92400e; }
        .status-completed { background-color: #d1fae5; color: #065f46; }
        .status-waiting-on-certs { background-color: #e9d5ff; color: #6b21a8; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Work Orders List</h1>
            <div class="flex space-x-4">
                <a href="calendar.html" class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-calendar mr-2"></i>Back to Calendar
                </a>
                <button onclick="refreshData()" class="bg-green-500 hover:bg-green-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-sync-alt mr-2"></i>Refresh
                </button>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Filters</h2>
            <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Work Order #</label>
                    <input id="workOrderNumberFilter" type="text" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Search by work order number..." onkeyup="filterWorkOrders()">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Status (multi-select)</label>
                    <div id="statusFilterMulti" class="grid grid-cols-1 gap-1 text-sm">
                        <label class="inline-flex items-center"><input type="checkbox" value="scheduled" onchange="filterWorkOrders()" class="mr-2">Scheduled</label>
                        <label class="inline-flex items-center"><input type="checkbox" value="in-progress" onchange="filterWorkOrders()" class="mr-2">In Progress</label>
                        <label class="inline-flex items-center"><input type="checkbox" value="completed" onchange="filterWorkOrders()" class="mr-2">Completed</label>
                        <label class="inline-flex items-center"><input type="checkbox" value="waiting-on-certs" onchange="filterWorkOrders()" class="mr-2">Waiting on Certs</label>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Technician</label>
                    <select id="technicianFilter" class="w-full border border-gray-300 rounded px-3 py-2" onchange="filterWorkOrders()">
                        <option value="">All Technicians</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Customer</label>
                    <input id="customerFilter" type="text" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Search customer..." onkeyup="filterWorkOrders()">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                    <input id="dateFilter" type="date" class="w-full border border-gray-300 rounded px-3 py-2" onchange="filterWorkOrders()">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Week</label>
                    <select id="weekFilter" class="w-full border border-gray-300 rounded px-3 py-2" onchange="filterWorkOrders()">
                        <option value="">All Weeks</option>
                        <option value="this-week">This Week</option>
                        <option value="next-week">Next Week</option>
                        <option value="last-week">Last Week</option>
                    </select>
                </div>
            </div>
            <div class="mt-4">
                <button onclick="clearFilters()" class="bg-gray-500 hover:bg-gray-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-times mr-2"></i>Clear Filters
                </button>
            </div>
        </div>

        <!-- Summary Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center">
                    <div class="p-2 bg-blue-100 rounded-lg">
                        <i class="fas fa-clipboard-list text-blue-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total Orders</p>
                        <p id="totalOrders" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center">
                    <div class="p-2 bg-yellow-100 rounded-lg">
                        <i class="fas fa-clock text-yellow-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">In Progress</p>
                        <p id="inProgressOrders" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center">
                    <div class="p-2 bg-green-100 rounded-lg">
                        <i class="fas fa-check text-green-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Completed</p>
                        <p id="completedOrders" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center">
                    <div class="p-2 bg-purple-100 rounded-lg">
                        <i class="fas fa-certificate text-purple-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Waiting on Certs</p>
                        <p id="waitingOrders" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Work Orders Table -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-semibold">All Work Orders</h2>
                <p id="tableSummary" class="text-sm text-gray-600 mt-1">Showing all work orders</p>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Work Order #</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Technician</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Work Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hours</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="workOrdersTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Work orders will be rendered here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Total Hours Summary -->
        <div class="bg-white rounded-lg shadow p-6 mt-6">
            <h2 class="text-xl font-semibold mb-4">Hours Summary</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="text-center">
                    <div class="text-3xl font-bold text-blue-600" id="totalFilteredHours">0</div>
                    <div class="text-sm text-gray-600">Total Hours (Filtered)</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-green-600" id="totalAllHours">0</div>
                    <div class="text-sm text-gray-600">Total Hours (All Orders)</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-purple-600" id="averageHoursPerOrder">0</div>
                    <div class="text-sm text-gray-600">Avg Hours per Order</div>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-200">
                <div class="text-sm text-gray-600">
                    <strong>Filtered Results:</strong> <span id="filteredSummary">Showing all work orders</span>
                </div>
            </div>
        </div>

        <!-- Work Order Details Modal -->
        <div id="workOrderModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Work Order Details</h3>
                    <div id="workOrderDetails" class="text-sm text-gray-600">
                        <!-- Details will be populated here -->
                    </div>
                    <div class="flex justify-end mt-4">
                        <button onclick="closeWorkOrderModal()" class="bg-gray-500 hover:bg-gray-700 text-white px-4 py-2 rounded">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Work Order Edit Modal -->
        <div id="editWorkOrderModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
            <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Edit Work Order</h3>
                    <form id="editWorkOrderForm" onsubmit="updateWorkOrder(event)">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Work Order Number</label>
                                <input id="editWorkOrderNumber" type="text" required class="w-full border border-gray-300 rounded px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Technician</label>
                                <select id="editTechnician" required class="w-full border border-gray-300 rounded px-3 py-2">
                                    <option value="">Select Technician</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Work Type</label>
                            <input id="editWorkType" type="text" required class="w-full border border-gray-300 rounded px-3 py-2">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Customer Name</label>
                                <input id="editCustomerName" type="text" required class="w-full border border-gray-300 rounded px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Hours Required</label>
                                <input id="editHoursRequired" type="number" step="0.1" required class="w-full border border-gray-300 rounded px-3 py-2">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                                <input id="editStartDate" type="date" required class="w-full border border-gray-300 rounded px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                <select id="editStatus" class="w-full border border-gray-300 rounded px-3 py-2">
                                    <option value="scheduled">Scheduled</option>
                                    <option value="in-progress">In Progress</option>
                                    <option value="completed">Completed</option>
                                    <option value="waiting-on-certs">Waiting on Certs</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                            <textarea id="editNotes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Add notes about this work order..."></textarea>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Attachment</label>
                            <input id="editAttachment" type="file" class="w-full border border-gray-300 rounded px-3 py-2" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                            <p class="text-sm text-gray-500 mt-1">PDF, Word docs, or image files</p>
                        </div>
                        <div class="flex justify-end space-x-4">
                            <button type="button" onclick="closeEditModal()" class="bg-gray-500 hover:bg-gray-700 text-white px-4 py-2 rounded">
                                Cancel
                            </button>
                            <button type="submit" class="bg-green-500 hover:bg-green-700 text-white px-4 py-2 rounded">
                                Update Work Order
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

<script>
// Check if user is logged in
const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
if (!currentUser) {
    window.location.href = 'login.html';
}

let technicians = [];
let workOrders = [];
        let filteredWorkOrders = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupUserInfo();
            loadData();
            // Preload defaults: this week + statuses Scheduled/In Progress/Waiting on Certs
            document.getElementById('weekFilter').value = 'this-week';
            // Allow multi-select status via checkboxes (added below), fallback to single-select if not present
            const statusMulti = document.getElementById('statusFilterMulti');
            if (statusMulti) {
                // select default three statuses
                Array.from(statusMulti.querySelectorAll('input[type="checkbox"]')).forEach(cb => {
                    cb.checked = ['scheduled','in-progress','waiting-on-certs'].includes(cb.value);
                });
            } else {
                const single = document.getElementById('statusFilter');
                if (single) single.value = '';
            }
            populateTechnicianFilter();
            filterWorkOrders();
            updateSummaryStats();
            updateHoursSummary();
        });

        function setupUserInfo() {
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
        }

        function logout() {
            sessionStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }

        // Data management
        function loadData() {
            const storedTechnicians = localStorage.getItem('technicians');
            const storedWorkOrders = localStorage.getItem('workOrders');
            
            if (storedTechnicians) {
                technicians = JSON.parse(storedTechnicians);
            }
            
            if (storedWorkOrders) {
                workOrders = JSON.parse(storedWorkOrders);
                
                // Filter work orders based on user role
                if (currentUser.role === 'technician' && currentUser.technicianId) {
                    workOrders = workOrders.filter(wo => wo.technicianId === currentUser.technicianId);
                }
            }
        }

        function refreshData() {
            loadData();
            populateTechnicianFilter();
            filterWorkOrders();
            updateSummaryStats();
            updateHoursSummary();
        }

        // Filter functions
        function populateTechnicianFilter() {
            const filterSelect = document.getElementById('technicianFilter');
            filterSelect.innerHTML = '<option value="">All Technicians</option>';
            
            technicians.forEach(technician => {
                const option = document.createElement('option');
                option.value = technician.id;
                option.textContent = technician.name;
                filterSelect.appendChild(option);
            });
        }

        function filterWorkOrders() {
            const workOrderNumberFilter = document.getElementById('workOrderNumberFilter').value.toLowerCase();
            // Support multi-select checkboxes; fallback to single-select if present
            let selectedStatuses = [];
            const multi = document.getElementById('statusFilterMulti');
            if (multi) {
                selectedStatuses = Array.from(multi.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
            } else {
                const single = document.getElementById('statusFilter');
                selectedStatuses = single && single.value ? [single.value] : [];
            }
            const technicianFilter = document.getElementById('technicianFilter').value;
            const customerFilter = document.getElementById('customerFilter').value.toLowerCase();
            const dateFilter = document.getElementById('dateFilter').value;
            const weekFilter = document.getElementById('weekFilter').value;
            
            filteredWorkOrders = workOrders.filter(workOrder => {
                const matchesWorkOrderNumber = !workOrderNumberFilter || workOrder.workOrderNumber.toLowerCase().includes(workOrderNumberFilter);
                const matchesStatus = selectedStatuses.length === 0 || selectedStatuses.includes(workOrder.status || 'scheduled');
                const matchesTechnician = !technicianFilter || workOrder.technicianId.toString() === technicianFilter;
                const matchesCustomer = !customerFilter || workOrder.customerName.toLowerCase().includes(customerFilter);
                const matchesDate = !dateFilter || workOrder.startDate === dateFilter;
                const matchesWeek = !weekFilter || isWorkOrderInWeek(workOrder.startDate, weekFilter);
                
                return matchesWorkOrderNumber && matchesStatus && matchesTechnician && matchesCustomer && matchesDate && matchesWeek;
            });
            
            renderWorkOrdersTable();
            updateSummaryStats();
            updateHoursSummary();
        }

        function clearFilters() {
            document.getElementById('workOrderNumberFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('technicianFilter').value = '';
            document.getElementById('customerFilter').value = '';
            document.getElementById('dateFilter').value = '';
            document.getElementById('weekFilter').value = '';
            filterWorkOrders();
        }

        // Rendering functions
        function renderWorkOrdersTable() {
            const tbody = document.getElementById('workOrdersTableBody');
            tbody.innerHTML = '';
            
            if (filteredWorkOrders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                            No work orders found matching your filters
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredWorkOrders.forEach(workOrder => {
                const technician = technicians.find(t => t.id === workOrder.technicianId);
                const technicianName = technician ? technician.name : 'Unknown';
                const statusClass = getStatusClass(workOrder.status);
                const statusText = getStatusText(workOrder.status);
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${workOrder.workOrderNumber}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${workOrder.customerName}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${technicianName}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${workOrder.workType}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${workOrder.hoursRequired}h
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${new Date(workOrder.startDate).toLocaleDateString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="status-badge ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <button onclick="showWorkOrderDetails(${workOrder.id})" class="text-blue-600 hover:text-blue-900 mr-2">
                            <i class="fas fa-eye"></i> View
                        </button>
                        <button onclick="editWorkOrder(${workOrder.id})" class="text-green-600 hover:text-green-900 mr-2">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button onclick="deleteWorkOrder(${workOrder.id})" class="text-red-600 hover:text-red-900">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function showWorkOrderDetails(workOrderId) {
            const workOrder = workOrders.find(wo => wo.id === workOrderId);
            if (!workOrder) return;
            
            const technician = technicians.find(t => t.id === workOrder.technicianId);
            const technicianName = technician ? technician.name : 'Unknown';
            
            const details = `
                <div class="space-y-3">
                    <div><strong>Work Order #:</strong> ${workOrder.workOrderNumber}</div>
                    <div><strong>Customer:</strong> ${workOrder.customerName}</div>
                    <div><strong>Technician:</strong> ${technicianName}</div>
                    <div><strong>Work Type:</strong> ${workOrder.workType}</div>
                    <div><strong>Hours Required:</strong> ${workOrder.hoursRequired}h</div>
                    <div><strong>Start Date:</strong> ${new Date(workOrder.startDate).toLocaleDateString()}</div>
                    <div><strong>Status:</strong> <span class="status-badge ${getStatusClass(workOrder.status)}">${getStatusText(workOrder.status)}</span></div>
                    <div><strong>Notes:</strong> ${workOrder.notes || 'None'}</div>
                    <div><strong>Attachment:</strong> ${workOrder.attachment || 'None'}</div>
                </div>
            `;
            
            document.getElementById('workOrderDetails').innerHTML = details;
            document.getElementById('workOrderModal').classList.remove('hidden');
        }

        function closeWorkOrderModal() {
            document.getElementById('workOrderModal').classList.add('hidden');
        }

        function deleteWorkOrder(workOrderId) {
            if (confirm('Are you sure you want to delete this work order?')) {
                workOrders = workOrders.filter(wo => wo.id !== workOrderId);
                localStorage.setItem('workOrders', JSON.stringify(workOrders));
                filterWorkOrders();
                updateSummaryStats();
                alert('Work order deleted successfully!');
            }
        }

        // Utility functions
        function getStatusClass(status) {
            switch(status) {
                case 'completed': return 'status-completed';
                case 'in-progress': return 'status-in-progress';
                case 'waiting-on-certs': return 'status-waiting-on-certs';
                default: return 'status-scheduled';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'completed': return 'Completed';
                case 'in-progress': return 'In Progress';
                case 'waiting-on-certs': return 'Waiting on Certs';
                default: return 'Scheduled';
            }
        }

        function updateSummaryStats() {
            const total = workOrders.length;
            const inProgress = workOrders.filter(wo => wo.status === 'in-progress').length;
            const completed = workOrders.filter(wo => wo.status === 'completed').length;
            const waiting = workOrders.filter(wo => wo.status === 'waiting-on-certs').length;
            
            document.getElementById('totalOrders').textContent = total;
            document.getElementById('inProgressOrders').textContent = inProgress;
            document.getElementById('completedOrders').textContent = completed;
            document.getElementById('waitingOrders').textContent = waiting;
            
            // Update table summary
            const summary = filteredWorkOrders.length === workOrders.length 
                ? `Showing all ${total} work orders`
                : `Showing ${filteredWorkOrders.length} of ${total} work orders`;
            document.getElementById('tableSummary').textContent = summary;
        }

        // Edit Work Order Functions
        function editWorkOrder(workOrderId) {
            const workOrder = workOrders.find(wo => wo.id === workOrderId);
            if (!workOrder) return;
            
            // Populate edit form with current work order data
            document.getElementById('editWorkOrderNumber').value = workOrder.workOrderNumber;
            document.getElementById('editWorkType').value = workOrder.workType;
            document.getElementById('editCustomerName').value = workOrder.customerName;
            document.getElementById('editHoursRequired').value = workOrder.hoursRequired;
            document.getElementById('editStartDate').value = workOrder.startDate;
            document.getElementById('editStatus').value = workOrder.status || 'scheduled';
            document.getElementById('editNotes').value = workOrder.notes || '';
            
            // Populate technician dropdown
            const technicianSelect = document.getElementById('editTechnician');
            technicianSelect.innerHTML = '<option value="">Select Technician</option>';
            technicians.forEach(technician => {
                const option = document.createElement('option');
                option.value = technician.id;
                option.textContent = technician.name;
                if (technician.id === workOrder.technicianId) {
                    option.selected = true;
                }
                technicianSelect.appendChild(option);
            });
            
            // Store the work order ID for updating
            document.getElementById('editWorkOrderForm').dataset.workOrderId = workOrderId;
            
            // Show the edit modal
            document.getElementById('editWorkOrderModal').classList.remove('hidden');
        }

        function updateWorkOrder(event) {
            event.preventDefault();
            
            const workOrderId = parseInt(document.getElementById('editWorkOrderForm').dataset.workOrderId);
            const workOrderIndex = workOrders.findIndex(wo => wo.id === workOrderId);
            
            if (workOrderIndex === -1) {
                alert('Work order not found!');
                return;
            }
            
            // Get form data
            const updatedWorkOrder = {
                id: workOrderId,
                workOrderNumber: document.getElementById('editWorkOrderNumber').value,
                technicianId: parseInt(document.getElementById('editTechnician').value),
                workType: document.getElementById('editWorkType').value,
                customerName: document.getElementById('editCustomerName').value,
                hoursRequired: parseFloat(document.getElementById('editHoursRequired').value),
                startDate: document.getElementById('editStartDate').value,
                status: document.getElementById('editStatus').value,
                notes: document.getElementById('editNotes').value,
                attachment: document.getElementById('editAttachment').files[0]?.name || workOrders[workOrderIndex].attachment || ''
            };
            
            // Update the work order
            workOrders[workOrderIndex] = updatedWorkOrder;
            
            // Save to localStorage
            localStorage.setItem('workOrders', JSON.stringify(workOrders));
            
            // Refresh the display
            filterWorkOrders();
            updateSummaryStats();
            
            // Close modal
            closeEditModal();
            
            alert('Work order updated successfully!');
        }

        function closeEditModal() {
            document.getElementById('editWorkOrderModal').classList.add('hidden');
            document.getElementById('editWorkOrderForm').reset();
        }

        // Week filtering helper function
        function isWorkOrderInWeek(workOrderDate, weekFilter) {
            const orderDate = new Date(workOrderDate);
            const today = new Date();
            
            switch(weekFilter) {
                case 'this-week':
                    return isDateInWeek(orderDate, getWeekStart(today));
                case 'next-week':
                    const nextWeekStart = new Date(today);
                    nextWeekStart.setDate(today.getDate() + 7);
                    return isDateInWeek(orderDate, getWeekStart(nextWeekStart));
                case 'last-week':
                    const lastWeekStart = new Date(today);
                    lastWeekStart.setDate(today.getDate() - 7);
                    return isDateInWeek(orderDate, getWeekStart(lastWeekStart));
                default:
                    return true;
            }
        }

        function getWeekStart(date) {
            const weekStart = new Date(date);
            weekStart.setDate(date.getDate() - date.getDay());
            return weekStart;
        }

        function isDateInWeek(date, weekStart) {
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            return date >= weekStart && date <= weekEnd;
        }

        // Hours summary functions
        function updateHoursSummary() {
            const totalFilteredHours = filteredWorkOrders.reduce((sum, wo) => sum + wo.hoursRequired, 0);
            const totalAllHours = workOrders.reduce((sum, wo) => sum + wo.hoursRequired, 0);
            const averageHoursPerOrder = filteredWorkOrders.length > 0 ? (totalFilteredHours / filteredWorkOrders.length).toFixed(1) : 0;
            
            document.getElementById('totalFilteredHours').textContent = totalFilteredHours.toFixed(1);
            document.getElementById('totalAllHours').textContent = totalAllHours.toFixed(1);
            document.getElementById('averageHoursPerOrder').textContent = averageHoursPerOrder;
            
            // Update filtered summary text
            const summary = filteredWorkOrders.length === workOrders.length 
                ? `Showing all ${workOrders.length} work orders (${totalAllHours.toFixed(1)}h total)`
                : `Showing ${filteredWorkOrders.length} of ${workOrders.length} work orders (${totalFilteredHours.toFixed(1)}h filtered)`;
            document.getElementById('filteredSummary').textContent = summary;
        }
    </script>
</body>
</html>
