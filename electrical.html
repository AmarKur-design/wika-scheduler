<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Electrical Calibration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS for Excel parsing -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- JSZip for DOCX reading -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <style>
        @media print {
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <div class="max-w-7xl mx-auto p-4">
        <div class="flex items-center justify-between mb-4">
            <h1 class="text-2xl font-semibold">Electrical Calibration</h1>
            <div class="space-x-2 no-print">
                <a href="index.html" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300">Home</a>
                <a href="calendar.html" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300">Back to Scheduler</a>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-4">
            <div class="border-b mb-4">
                <nav class="flex -mb-px space-x-6" aria-label="Tabs">
                    <button id="tabSetup" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-600 text-indigo-600">Setup</button>
                    <button id="tabLibrary" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">Model Library</button>
                    <button id="tabCalibrate" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">Calibrate</button>
                </nav>
            </div>

            <!-- Setup Panel -->
            <section id="panelSetup" class="space-y-6">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 space-y-3">
                        <h2 class="text-lg font-medium">Setup</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium mb-1">Laboratory</label>
                                <input id="setupLab" type="text" class="w-full border rounded px-3 py-2" placeholder="WIKA Australia Pty Ltd">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Technician</label>
                                <input id="setupTechnician" type="text" class="w-full border rounded px-3 py-2" placeholder="e.g., Andres Correa">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Date Tested</label>
                                <input id="setupDateTested" type="date" class="w-full border rounded px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Standard</label>
                                <select id="setupStandard" class="w-full border rounded px-3 py-2">
                                    <option value="ISO 17025">ISO 17025</option>
                                    <option value="Manufacturer Specifications">Manufacturer Specifications</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Ambient Temp (°C)</label>
                                <input id="setupTemp" type="number" step="0.1" class="w-full border rounded px-3 py-2" placeholder="20">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Humidity (%)</label>
                                <input id="setupHumidity" type="number" step="0.1" class="w-full border rounded px-3 py-2" placeholder="50">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Default Tolerance %</label>
                                <input id="setupDefaultTolerance" type="number" step="0.0001" class="w-full border rounded px-3 py-2" placeholder="0.05">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Default Uncertainty %</label>
                                <input id="setupDefaultUncertainty" type="number" step="0.0001" class="w-full border rounded px-3 py-2" placeholder="0.02">
                            </div>
                        </div>

                        <h3 class="text-base font-medium mt-2">Reference Equipment</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div>
                                <label class="block text-sm font-medium mb-1">Display SN</label>
                                <input id="setupDisplaySN" type="text" class="w-full border rounded px-3 py-2" placeholder="D12345">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Display Cert</label>
                                <input id="setupDisplayCert" type="text" class="w-full border rounded px-3 py-2" placeholder="CERT-001">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Display Range</label>
                                <input id="setupDisplayRange" type="text" class="w-full border rounded px-3 py-2" placeholder="0-1000 V">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Tx SN</label>
                                <input id="setupTxSN" type="text" class="w-full border rounded px-3 py-2" placeholder="T98765">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Tx Cert</label>
                                <input id="setupTxCert" type="text" class="w-full border rounded px-3 py-2" placeholder="CERT-123">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Tx Range</label>
                                <input id="setupTxRange" type="text" class="w-full border rounded px-3 py-2" placeholder="0-1000 V">
                            </div>
                        </div>

                        <div class="flex gap-2 mt-3">
                            <button id="saveSetupBtn" class="px-3 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Save Setup</button>
                            <button id="resetSetupBtn" class="px-3 py-2 bg-gray-200 rounded hover:bg-gray-300">Reset</button>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <h2 class="text-lg font-medium">Import Setup From Workbook</h2>
                        <p class="text-sm text-gray-600">Click to read first sheet from <span class="font-semibold">Electrical Workbook Draft.xlsm</span> and populate these fields (key/value style like the workbook’s Setup tab).</p>
                        <button id="importSetupBtn" class="px-3 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700">Import Setup</button>
                        <div id="importSetupLog" class="text-xs text-gray-600 whitespace-pre-wrap max-h-40 overflow-auto border rounded p-2"></div>
                    </div>
                </div>
            </section>

            <!-- Library Panel -->
            <section id="panelLibrary" class="hidden space-y-6">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2">
                        <h2 class="text-lg font-medium mb-2">Makes & Models</h2>
                        <div class="flex items-end gap-3 mb-3">
                            <div class="flex-1">
                                <label class="block text-sm font-medium mb-1">Make</label>
                                <input id="makeInput" type="text" class="w-full border rounded px-3 py-2" placeholder="e.g., Fluke">
                            </div>
                            <div class="flex-1">
                                <label class="block text-sm font-medium mb-1">Model</label>
                                <input id="modelInput" type="text" class="w-full border rounded px-3 py-2" placeholder="e.g., 87V">
                            </div>
                            <button id="addModelBtn" class="px-3 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Add</button>
                        </div>

                        <div class="overflow-auto border rounded">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Make</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Model</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Specs</th>
                                        <th class="px-4 py-2"></th>
                                    </tr>
                                </thead>
                                <tbody id="modelsTable" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <h2 class="text-lg font-medium">Import From File</h2>
                        <p class="text-sm text-gray-600">Upload the Electrical Workbook Draft (Excel) or a model report (Word). Supported: <span class="font-semibold">.xlsx, .xls, .docx</span>.</p>
                        <div class="grid grid-cols-1 gap-2">
                            <div>
                                <label class="block text-xs font-medium">Excel (.xlsx/.xls)</label>
                                <input id="excelFile" type="file" accept=".xlsx,.xls" class="block w-full text-sm" />
                            </div>
                            <div>
                                <label class="block text-xs font-medium">Word (.docx or .doc)</label>
                                <input id="wordFile" type="file" accept=".docx,.doc,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/msword" class="block w-full text-sm" />
                            </div>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <button id="importBtn" class="px-3 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700">Import</button>
                            <button id="importWorkbookBtn" class="px-3 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700" title="Imports 'Electrical Workbook Draft.xlsm' from this folder">Import Electrical Workbook</button>
                            <button id="seedFlukeBtn" class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" title="Adds Fluke 8846A with demo As Found/As Left specs">Add Fluke 8846A (demo)</button>
                            <button id="exportBtn" class="px-3 py-2 bg-gray-200 rounded hover:bg-gray-300">Export JSON</button>
                            <button id="clearBtn" class="px-3 py-2 bg-red-50 text-red-700 rounded hover:bg-red-100">Clear Library</button>
                        </div>
                        <div id="importLog" class="text-xs text-gray-600 whitespace-pre-wrap max-h-40 overflow-auto border rounded p-2"></div>

                        <div class="border-t pt-3">
                            <h3 class="text-base font-medium mb-2">Add/Update Specs</h3>
                            <div class="space-y-2 text-sm">
                                <div>
                                    <label class="block text-xs font-medium">Function</label>
                                    <input id="specFunction" type="text" class="w-full border rounded px-2 py-1" placeholder="e.g., DC Voltage">
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-xs font-medium">Range</label>
                                        <input id="specRange" type="text" class="w-full border rounded px-2 py-1" placeholder="e.g., 0-10">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium">Unit</label>
                                        <input id="specUnit" type="text" class="w-full border rounded px-2 py-1" placeholder="e.g., V">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-xs font-medium">Tolerance % (optional)</label>
                                        <input id="specTolerance" type="number" step="0.0001" class="w-full border rounded px-2 py-1" placeholder="e.g., 0.5">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium">Uncertainty % (optional)</label>
                                        <input id="specUncertainty" type="number" step="0.0001" class="w-full border rounded px-2 py-1" placeholder="e.g., 0.2">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium">Test Points (comma-separated)</label>
                                    <input id="specPoints" type="text" class="w-full border rounded px-2 py-1" placeholder="e.g., 0, 1, 2, 5, 10">
                                </div>
                                <div class="flex gap-2">
                                    <button id="addSpecFound" class="px-3 py-1.5 bg-blue-600 text-white rounded hover:bg-blue-700">Add to As Found</button>
                                    <button id="addSpecLeft" class="px-3 py-1.5 bg-indigo-600 text-white rounded hover:bg-indigo-700">Add to As Left</button>
                                </div>
                                <div id="specBindInfo" class="text-xs text-gray-500">Select a make/model row above to bind specs.</div>
                            </div>
                        </div>

                        <div class="border-t pt-3">
                            <h3 class="text-base font-medium mb-2">Model Reference Equipment & Defaults</h3>
                            <div class="space-y-2 text-sm">
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-xs font-medium">Default Tolerance %</label>
                                        <input id="modelTolerance" type="number" step="0.0001" class="w-full border rounded px-2 py-1" placeholder="e.g., 0.5">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium">Default Uncertainty %</label>
                                        <input id="modelUncertainty" type="number" step="0.0001" class="w-full border rounded px-2 py-1" placeholder="e.g., 0.2">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-xs font-medium">Display SN</label>
                                        <input id="refDisplaySN" type="text" class="w-full border rounded px-2 py-1" placeholder="e.g., D12345">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium">Display Cert</label>
                                        <input id="refDisplayCert" type="text" class="w-full border rounded px-2 py-1" placeholder="e.g., CERT-001"></input>
                                    </div>
                                </div>
                                <div class="grid grid-cols-3 gap-2">
                                    <div>
                                        <label class="block text-xs font-medium">Tx SN</label>
                                        <input id="refTxSN" type="text" class="w-full border rounded px-2 py-1" placeholder="e.g., T98765">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium">Tx Cert</label>
                                        <input id="refTxCert" type="text" class="w-full border rounded px-2 py-1" placeholder="e.g., CERT-123">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium">Tx Range</label>
                                        <input id="refTxRange" type="text" class="w-full border rounded px-2 py-1" placeholder="e.g., 0-100 V">
                                    </div>
                                </div>
                                <div>
                                    <button id="saveModelMeta" class="px-3 py-1.5 bg-emerald-600 text-white rounded hover:bg-emerald-700">Save Model Meta</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Calibrate Panel -->
            <section id="panelCalibrate" class="hidden space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                        <label class="block text-sm font-medium mb-1">Make</label>
                        <input id="calMake" type="text" class="w-full border rounded px-3 py-2" placeholder="Start typing...">
                        <div id="makeSuggestions" class="absolute z-10 bg-white border rounded shadow text-sm hidden"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Model</label>
                        <input id="calModel" type="text" class="w-full border rounded px-3 py-2" placeholder="Start typing...">
                        <div id="modelSuggestions" class="absolute z-10 bg-white border rounded shadow text-sm hidden"></div>
                    </div>
                    <div class="flex items-end">
                        <button id="loadSpecsBtn" class="px-3 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 w-full">Load Test Specs</button>
                    </div>
                </div>

                <div id="specsContainer" class="hidden">
                    <div id="refCard" class="mb-4 p-3 border rounded bg-gray-50 text-sm"></div>
                    <h3 class="text-lg font-medium">As Found</h3>
                    <div id="asFoundContainer" class="overflow-auto border rounded mb-6"></div>

                    <h3 class="text-lg font-medium">As Left</h3>
                    <div id="asLeftContainer" class="overflow-auto border rounded"></div>
                </div>
            </section>
        </div>
    </div>

    <script>
    // Data structure in localStorage: electricalModelLibrary
    // {
    //   makes: { [make]: { models: { [model]: { asFound: TestSpec[], asLeft: TestSpec[], meta?: ModelMeta }}}},
    //   updatedAt: ISO string
    // }

    const STORAGE_KEY = 'electricalModelLibrary';
    let modelLibrary = loadLibrary();
    let selectedMake = null;
    let selectedModel = null;

    function loadLibrary(){
        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return { makes: {}, updatedAt: new Date().toISOString() };
            const parsed = JSON.parse(raw);
            if (!parsed.makes) parsed.makes = {};
            return parsed;
        } catch (e) {
            console.error('Failed to load library', e);
            return { makes: {}, updatedAt: new Date().toISOString() };
        }
    }

    function saveLibrary(){
        modelLibrary.updatedAt = new Date().toISOString();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(modelLibrary));
        renderModelsTable();
    }

    function ensureModel(make, model){
        if (!modelLibrary.makes[make]) modelLibrary.makes[make] = { models: {} };
        if (!modelLibrary.makes[make].models[model]) modelLibrary.makes[make].models[model] = { asFound: [], asLeft: [], meta: { defaultTolerance: null, defaultUncertainty: null, reference: { displaySN: '', displayCert: '', txSN: '', txCert: '', txRange: '' } } };
        return modelLibrary.makes[make].models[model];
    }

    function renderModelsTable(){
        const tbody = document.getElementById('modelsTable');
        tbody.innerHTML = '';
        const makes = Object.keys(modelLibrary.makes).sort();
        for (const make of makes){
            const models = Object.keys(modelLibrary.makes[make].models).sort();
            for (const model of models){
                const spec = modelLibrary.makes[make].models[model];
                const tr = document.createElement('tr');
                tr.className = (selectedMake===make && selectedModel===model) ? 'bg-indigo-50' : '';
                tr.innerHTML = `
                    <td class="px-4 py-2 align-top">${escapeHtml(make)}</td>
                    <td class="px-4 py-2 align-top">${escapeHtml(model)}</td>
                    <td class="px-4 py-2">
                        <div class="text-xs text-gray-600">As Found: ${spec.asFound.length} specs</div>
                        <div class="text-xs text-gray-600">As Left: ${spec.asLeft.length} specs</div>
                        <div class="text-xs text-gray-500">Tol%: ${spec.meta?.defaultTolerance ?? '-'} | Unc%: ${spec.meta?.defaultUncertainty ?? '-'}</div>
                    </td>
                    <td class="px-4 py-2 text-right space-x-2">
                        <button class="px-2 py-1 text-xs rounded bg-gray-100 hover:bg-gray-200" data-action="select">Select</button>
                        <button class="px-2 py-1 text-xs rounded bg-red-50 text-red-700 hover:bg-red-100" data-action="delete">Delete</button>
                    </td>
                `;
                tr.addEventListener('click', (e)=>{
                    const action = e.target.getAttribute('data-action');
                    if (action === 'delete'){
                        if (confirm(`Delete ${make} ${model}?`)){
                            delete modelLibrary.makes[make].models[model];
                            if (Object.keys(modelLibrary.makes[make].models).length===0){
                                delete modelLibrary.makes[make];
                            }
                            if (selectedMake===make && selectedModel===model){ selectedMake=null; selectedModel=null; }
                            saveLibrary();
                        }
                        return;
                    }
                    selectedMake = make; selectedModel = model; renderModelsTable();
                    document.getElementById('specBindInfo').textContent = `Adding specs to: ${make} ${model}`;
                });
                tbody.appendChild(tr);
            }
        }
    }

    function escapeHtml(str){
        return String(str??'').replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[s]));
    }

    // Add model
    document.getElementById('addModelBtn').addEventListener('click', ()=>{
        const make = document.getElementById('makeInput').value.trim();
        const model = document.getElementById('modelInput').value.trim();
        if (!make || !model){ alert('Enter both make and model'); return; }
        ensureModel(make, model);
        saveLibrary();
        document.getElementById('makeInput').value='';
        document.getElementById('modelInput').value='';
    });

    // Add spec helpers
    function getPointsFromInput(){
        const raw = document.getElementById('specPoints').value.trim();
        if (!raw) return [];
        // Accept non-numeric tokens (e.g., "1A @ 50Hz")
        return raw.split(',').map(s=>s.trim()).filter(s=>s!=='');
    }

    function addSpec(to){
        if (!selectedMake || !selectedModel){ alert('Select a make/model row first'); return; }
        const fn = document.getElementById('specFunction').value.trim();
        const range = document.getElementById('specRange').value.trim();
        const unit = document.getElementById('specUnit').value.trim();
        const points = getPointsFromInput();
        const tol = document.getElementById('specTolerance').value;
        const unc = document.getElementById('specUncertainty').value;
        if (!fn || !range || !unit){ alert('Enter function, range, and unit'); return; }
        const modelRef = ensureModel(selectedMake, selectedModel);
        const spec = { function: fn, range, unit, points, tolerancePercent: tol ? Number(tol) : null, uncertaintyPercent: unc ? Number(unc) : null };
        if (to==='found') modelRef.asFound.push(spec); else modelRef.asLeft.push(spec);
        saveLibrary();
        document.getElementById('specFunction').value='';
        document.getElementById('specRange').value='';
        document.getElementById('specUnit').value='';
        document.getElementById('specPoints').value='';
        document.getElementById('specTolerance').value='';
        document.getElementById('specUncertainty').value='';
    }

    document.getElementById('addSpecFound').addEventListener('click', ()=>addSpec('found'));
    document.getElementById('addSpecLeft').addEventListener('click', ()=>addSpec('left'));

    // Excel import
    document.getElementById('importBtn').addEventListener('click', async ()=>{
        const xlsInput = document.getElementById('excelFile');
        const docxInput = document.getElementById('wordFile');
        const log = document.getElementById('importLog');
        log.textContent = '';
        if ((!xlsInput.files || !xlsInput.files[0]) && (!docxInput.files || !docxInput.files[0])){
            alert('Choose an Excel or Word file'); return;
        }

        if (xlsInput.files && xlsInput.files[0]){
            const file = xlsInput.files[0];
            const data = await file.arrayBuffer();
            const workbook = XLSX.read(data, { type: 'array' });
            const foundSheet = workbook.Sheets['As Found'] || workbook.Sheets['as found'] || workbook.Sheets['Found'] || workbook.Sheets[workbook.SheetNames[0]];
            const leftSheet = workbook.Sheets['As Left'] || workbook.Sheets['as left'] || workbook.Sheets['Left'] || workbook.Sheets[workbook.SheetNames[1]];

        function rowsFromSheet(sheet){
            if (!sheet) return [];
            return XLSX.utils.sheet_to_json(sheet, { defval: '' });
        }

        const asFoundRows = rowsFromSheet(foundSheet);
        const asLeftRows = rowsFromSheet(leftSheet);

        let imported = 0; let modelsTouched = new Set();

        function importRows(rows, target){
            for (const r of rows){
                const make = String(r.Make || r.make || r.MAKE || '').trim();
                const model = String(r.Model || r.model || r.MODEL || '').trim();
                const fn = String(r.Function || r.function || r.FUNCTION || '').trim();
                const range = String(r.Range || r.range || r.RANGE || '').trim();
                const unit = String(r.Unit || r.unit || r.UNIT || '').trim();
                const pointsRaw = String(r.Points || r.points || r.POINTS || '').trim();
                const points = pointsRaw ? pointsRaw.split(',').map(s=>s.trim()).filter(s=>s!=='') : [];
                if (!make || !model || !fn || !range || !unit){ continue; }
                const modelRef = ensureModel(make, model);
                const tol = r.Tolerance ?? r.tolerance ?? r.TOLERANCE;
                const unc = r.Uncertainty ?? r.uncertainty ?? r.UNCERTAINTY;
                const spec = { function: fn, range, unit, points, tolerancePercent: tol!==undefined && tol!=='' ? Number(tol) : null, uncertaintyPercent: unc!==undefined && unc!=='' ? Number(unc) : null };
                modelRef[target].push(spec);
                // Optional model-level meta per row (last wins)
                const dispSN = r.DisplaySN || r['Display SN'] || r.Display || '';
                const dispCert = r.DisplayCert || r['Display Cert'] || '';
                const txSN = r.TxSN || r['Tx SN'] || r.TransmitterSN || r['Transmitter SN'] || '';
                const txCert = r.TxCert || r['Tx Cert'] || r.TransmitterCert || r['Transmitter Cert'] || '';
                const txRange = r.TxRange || r['Tx Range'] || r.TransmitterRange || r['Transmitter Range'] || '';
                const defaultTol = r.DefaultTolerance ?? r['Default Tolerance'] ?? '';
                const defaultUnc = r.DefaultUncertainty ?? r['Default Uncertainty'] ?? '';
                modelRef.meta = modelRef.meta || { defaultTolerance: null, defaultUncertainty: null, reference: { displaySN: '', displayCert: '', txSN: '', txCert: '', txRange: '' } };
                if (defaultTol!=='' && !isNaN(Number(defaultTol))) modelRef.meta.defaultTolerance = Number(defaultTol);
                if (defaultUnc!=='' && !isNaN(Number(defaultUnc))) modelRef.meta.defaultUncertainty = Number(defaultUnc);
                if (dispSN) modelRef.meta.reference.displaySN = String(dispSN);
                if (dispCert) modelRef.meta.reference.displayCert = String(dispCert);
                if (txSN) modelRef.meta.reference.txSN = String(txSN);
                if (txCert) modelRef.meta.reference.txCert = String(txCert);
                if (txRange) modelRef.meta.reference.txRange = String(txRange);
                imported++; modelsTouched.add(`${make}|||${model}`);
            }
        }

            importRows(asFoundRows, 'asFound');
            importRows(asLeftRows, 'asLeft');
            saveLibrary();

            log.textContent += `Imported ${imported} specs across ${modelsTouched.size} models from Excel.\n`+
                              `Sheets parsed: ${(foundSheet?1:0)+(leftSheet?1:0)}\n`+
                              `Columns supported: Make, Model, Function, Range, Unit, Points, Tolerance, Uncertainty, DisplaySN, DisplayCert, TxSN, TxCert, TxRange, DefaultTolerance, DefaultUncertainty.\n`;
        }

        if (docxInput.files && docxInput.files[0]){
            const file = docxInput.files[0];
            try {
                const arrayBuf = await file.arrayBuffer();
                // Lightweight docx extraction via zip: read document.xml
                const zip = await JSZip.loadAsync(arrayBuf);
                const docXml = await zip.file('word/document.xml').async('string');
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(docXml, 'application/xml');
                const textNodes = Array.from(xmlDoc.getElementsByTagName('w:t'));
                const fullText = textNodes.map(n=>n.textContent).join('\n');

                // Heuristic extraction for Fluke 376 FC report
                // Make/Model: look for lines containing 'Item/Cat No' or similar
                let make = 'Fluke';
                let model = '';
                const lines = fullText.split(/\n+/);
                for (const ln of lines){
                    const l = ln.trim();
                    if (/376\s*FC/i.test(l)) model = '376 FC';
                    if (/Item\s*\/\s*Cat\s*No/i.test(l) || /Item\s*No/i.test(l)){
                        // Try to parse make/model on same or next lines
                        const nextIdx = lines.indexOf(ln)+1;
                        const next = lines[nextIdx] || '';
                        if (/Fluke/i.test(l) || /Fluke/i.test(next)) make = 'Fluke';
                    }
                }
                if (!model){
                    // fallback: look for 'Fluke 376 FC'
                    const m = fullText.match(/Fluke\s+([0-9]+\s*FC)/i);
                    if (m) { make = 'Fluke'; model = m[1].replace(/\s+/g,' ').trim(); }
                }
                const modelRef = ensureModel(make, model || '376 FC');

                // Table extraction: find tables and map to As Found/As Left by headings
                const tbls = Array.from(xmlDoc.getElementsByTagName('w:tbl'));
                function textFromNode(node){ return Array.from(node.getElementsByTagName('w:t')).map(n=>n.textContent.trim()).filter(Boolean).join(' '); }
                let foundSpecs = []; let leftSpecs = [];
                for (const tbl of tbls){
                    const rows = Array.from(tbl.getElementsByTagName('w:tr'));
                    const header = rows[0] ? textFromNode(rows[0]).toLowerCase() : '';
                    let isFound = /as\s*found/i.test(header);
                    let isLeft = /as\s*left/i.test(header);
                    const looksLikeInstrTable = /instrument/i.test(header) && /applied/i.test(header) && /reading/i.test(header);
                    const assignTo = isFound ? 'found' : (isLeft ? 'left' : (looksLikeInstrTable ? 'found' : null));
                    if (!assignTo) continue;
                    // Heuristic: dual 3-col blocks per row: [Instrument, Range, Applied/Value] x2, sometimes with Reading column merged
                    for (let i=1;i<rows.length;i++){
                        const cells = Array.from(rows[i].getElementsByTagName('w:tc'));
                        const values = cells.map(textFromNode).map(s=>s.replace(/\s+/g,' ').trim());
                        if (values.every(v=>!v)) continue;
                        // Normalize to at least 6 entries
                        while (values.length < 6) values.push('');
                        const leftFn = values[0];
                        const leftRange = values[1];
                        const leftApplied = values[2] || values[3] || '';
                        const rightFn = values[3];
                        const rightRange = values[4];
                        const rightApplied = values[5] || '';
                        function inferUnit(text){
                            const m = text.match(/(mV|V|A|mA|\u03A9|Ω|kΩ|MΩ|µF|uF|nF|Hz)/i);
                            return m ? m[1].replace('uF','µF') : '';
                        }
                        function mkSpec(fn, range, applied){
                            if (!fn && !range && !applied) return null;
                            const unit = inferUnit(fn+' '+range+' '+applied);
                            const points = applied ? applied.split(/,|\s{2,}/).map(s=>s.trim()).filter(Boolean) : [];
                            return { function: fn, range, unit, points, tolerancePercent: null, uncertaintyPercent: null };
                        }
                        const sL = mkSpec(leftFn, leftRange, leftApplied);
                        const sR = mkSpec(rightFn, rightRange, rightApplied);
                        if (sL) (assignTo==='found' ? foundSpecs : leftSpecs).push(sL);
                        if (sR) (assignTo==='found' ? foundSpecs : leftSpecs).push(sR);
                    }
                }
                if (foundSpecs.length) modelRef.asFound.push(...foundSpecs);
                if (leftSpecs.length) modelRef.asLeft.push(...leftSpecs);
                saveLibrary();
                log.textContent += `Imported ${foundSpecs.length} As Found and ${leftSpecs.length} As Left specs from Word for ${make} ${model||'376 FC'}.\n`;
            } catch (e){
                console.error(e);
                log.textContent += 'DOCX import failed. If possible, export the tables to Excel and import.\n';
            }
        }
    });

    // One-click import of bundled workbook (served over http)
    document.getElementById('importWorkbookBtn').addEventListener('click', async ()=>{
        const log = document.getElementById('importLog');
        log.textContent = '';
        try {
            const resp = await fetch('Electrical%20Workbook%20Draft.xlsm');
            if (!resp.ok) throw new Error('HTTP '+resp.status);
            const data = await resp.arrayBuffer();
            const workbook = XLSX.read(data, { type: 'array' });
            const foundSheet = workbook.Sheets['As Found'] || workbook.Sheets['as found'] || workbook.Sheets['Found'] || workbook.Sheets[workbook.SheetNames[0]];
            const leftSheet = workbook.Sheets['As Left'] || workbook.Sheets['as left'] || workbook.Sheets['Left'] || workbook.Sheets[workbook.SheetNames[1]];

            function rowsFromSheet(sheet){ return sheet ? XLSX.utils.sheet_to_json(sheet, { defval: '' }) : []; }
            const asFoundRows = rowsFromSheet(foundSheet);
            const asLeftRows = rowsFromSheet(leftSheet);

            let imported = 0; let modelsTouched = new Set();
            // For this run, default missing make/model to Fluke / 8846A as requested
            const defaultMake = 'Fluke';
            const defaultModel = '8846A';
            function importRows(rows, target){
                for (const r of rows){
                    const make = String(r.Make || r.make || r.MAKE || '').trim() || defaultMake;
                    const model = String(r.Model || r.model || r.MODEL || '').trim() || defaultModel;
                    const fn = String(r.Function || r.function || r.FUNCTION || '').trim();
                    const range = String(r.Range || r.range || r.RANGE || '').trim();
                    const unit = String(r.Unit || r.unit || r.UNIT || '').trim();
                    const pointsRaw = String(r.Points || r.points || r.POINTS || '').trim();
                    const points = pointsRaw ? pointsRaw.split(',').map(s=>s.trim()).filter(s=>s!=='') : [];
                    if (!make || !model || !fn || !range || !unit){ continue; }
                    const modelRef = ensureModel(make, model);
                    const tol = r.Tolerance ?? r.tolerance ?? r.TOLERANCE;
                    const unc = r.Uncertainty ?? r.uncertainty ?? r.UNCERTAINTY;
                    const spec = { function: fn, range, unit, points, tolerancePercent: tol!==undefined && tol!=='' ? Number(tol) : null, uncertaintyPercent: unc!==undefined && unc!=='' ? Number(unc) : null };
                    modelRef[target].push(spec);
                    const dispSN = r.DisplaySN || r['Display SN'] || r.Display || '';
                    const dispCert = r.DisplayCert || r['Display Cert'] || '';
                    const txSN = r.TxSN || r['Tx SN'] || r.TransmitterSN || r['Transmitter SN'] || '';
                    const txCert = r.TxCert || r['Tx Cert'] || r.TransmitterCert || r['Transmitter Cert'] || '';
                    const txRange = r.TxRange || r['Tx Range'] || r.TransmitterRange || r['Transmitter Range'] || '';
                    const defaultTol = r.DefaultTolerance ?? r['Default Tolerance'] ?? '';
                    const defaultUnc = r.DefaultUncertainty ?? r['Default Uncertainty'] ?? '';
                    modelRef.meta = modelRef.meta || { defaultTolerance: null, defaultUncertainty: null, reference: { displaySN: '', displayCert: '', txSN: '', txCert: '', txRange: '' } };
                    if (defaultTol!=='' && !isNaN(Number(defaultTol))) modelRef.meta.defaultTolerance = Number(defaultTol);
                    if (defaultUnc!=='' && !isNaN(Number(defaultUnc))) modelRef.meta.defaultUncertainty = Number(defaultUnc);
                    if (dispSN) modelRef.meta.reference.displaySN = String(dispSN);
                    if (dispCert) modelRef.meta.reference.displayCert = String(dispCert);
                    if (txSN) modelRef.meta.reference.txSN = String(txSN);
                    if (txCert) modelRef.meta.reference.txCert = String(txCert);
                    if (txRange) modelRef.meta.reference.txRange = String(txRange);
                    imported++; modelsTouched.add(`${make}|||${model}`);
                }
            }
            importRows(asFoundRows, 'asFound');
            importRows(asLeftRows, 'asLeft');
            saveLibrary();

            log.textContent = `Imported ${imported} specs across ${modelsTouched.size} models from bundled workbook.\n`+
                              `Sheets parsed: ${(foundSheet?1:0)+(leftSheet?1:0)}\n`;
        } catch (e){
            console.error(e);
            log.textContent = 'Failed to fetch workbook. Please open this page via http (not file://).';
        }
    });

    // Export & Clear
    document.getElementById('exportBtn').addEventListener('click', ()=>{
        const blob = new Blob([JSON.stringify(modelLibrary, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'electricalModelLibrary.json'; a.click();
        URL.revokeObjectURL(url);
    });
    document.getElementById('clearBtn').addEventListener('click', ()=>{
        if (!confirm('Clear the entire electrical model library?')) return;
        modelLibrary = { makes: {}, updatedAt: new Date().toISOString() };
        saveLibrary();
    });

    // Save model meta
    document.getElementById('saveModelMeta').addEventListener('click', ()=>{
        if (!selectedMake || !selectedModel){ alert('Select a make/model row first'); return; }
        const m = ensureModel(selectedMake, selectedModel);
        m.meta = m.meta || { defaultTolerance: null, defaultUncertainty: null, reference: { displaySN: '', displayCert: '', txSN: '', txCert: '', txRange: '' } };
        const tol = document.getElementById('modelTolerance').value;
        const unc = document.getElementById('modelUncertainty').value;
        if (tol!=='') m.meta.defaultTolerance = Number(tol);
        if (unc!=='') m.meta.defaultUncertainty = Number(unc);
        m.meta.reference.displaySN = document.getElementById('refDisplaySN').value;
        m.meta.reference.displayCert = document.getElementById('refDisplayCert').value;
        m.meta.reference.txSN = document.getElementById('refTxSN').value;
        m.meta.reference.txCert = document.getElementById('refTxCert').value;
        m.meta.reference.txRange = document.getElementById('refTxRange').value;
        saveLibrary();
        alert('Model meta saved');
    });

    // Tabs
    function showPanel(which){
        const isSetup = which==='setup';
        const isLib = which==='lib';
        document.getElementById('panelSetup').classList.toggle('hidden', !isSetup);
        document.getElementById('panelLibrary').classList.toggle('hidden', !isLib);
        document.getElementById('panelCalibrate').classList.toggle('hidden', isSetup || isLib);
        document.getElementById('tabSetup').className = isSetup ? 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-600 text-indigo-600' : 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700';
        document.getElementById('tabLibrary').className = isLib ? 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-600 text-indigo-600' : 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700';
        document.getElementById('tabCalibrate').className = (!isSetup && !isLib) ? 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-600 text-indigo-600' : 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700';
    }
    document.getElementById('tabSetup').addEventListener('click', ()=>showPanel('setup'));
    document.getElementById('tabLibrary').addEventListener('click', ()=>showPanel('lib'));
    document.getElementById('tabCalibrate').addEventListener('click', ()=>showPanel('cal'));

    // Calibrate view
    document.getElementById('loadSpecsBtn').addEventListener('click', ()=>{
        const make = document.getElementById('calMake').value.trim();
        const model = document.getElementById('calModel').value.trim();
        if (!make || !model){ alert('Enter make and model'); return; }
        const spec = modelLibrary.makes[make]?.models?.[model];
        if (!spec){ alert('Model not found in library'); return; }
        renderRefCard(spec.meta);
        renderSpecs('asFoundContainer', spec.asFound);
        renderSpecs('asLeftContainer', spec.asLeft);
        document.getElementById('specsContainer').classList.remove('hidden');
    });

    function renderRefCard(meta){
        const el = document.getElementById('refCard');
        if (!meta){ el.innerHTML = ''; return; }
        el.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                <div>
                    <div class="font-medium text-gray-700 mb-1">Reference Display</div>
                    <div>SN: <span class="font-mono">${escapeHtml(meta.reference?.displaySN||'')}</span></div>
                    <div>Cert: <span class="font-mono">${escapeHtml(meta.reference?.displayCert||'')}</span></div>
                </div>
                <div>
                    <div class="font-medium text-gray-700 mb-1">Transmitter</div>
                    <div>SN: <span class="font-mono">${escapeHtml(meta.reference?.txSN||'')}</span></div>
                    <div>Cert: <span class="font-mono">${escapeHtml(meta.reference?.txCert||'')}</span></div>
                    <div>Range: <span class="font-mono">${escapeHtml(meta.reference?.txRange||'')}</span></div>
                </div>
                <div>
                    <div class="font-medium text-gray-700 mb-1">Defaults</div>
                    <div>Tolerance: <span class="font-mono">${meta.defaultTolerance ?? '-'}%</span></div>
                    <div>Uncertainty: <span class="font-mono">${meta.defaultUncertainty ?? '-'}%</span></div>
                </div>
            </div>
        `;
    }

    function parseNumeric(value){
        if (value==null) return NaN;
        const m = String(value).replace(/,/g,'').match(/-?\d*\.?\d+(e[+-]?\d+)?/i);
        return m ? parseFloat(m[0]) : NaN;
    }

    function computeAverage(nums){
        const vals = nums.map(parseNumeric).filter(v=>!isNaN(v));
        if (vals.length===0) return '';
        const sum = vals.reduce((a,b)=>a+b,0);
        return (sum/vals.length).toFixed(6).replace(/0+$/,'').replace(/\.$/,'');
    }

    function renderSpecs(containerId, specs){
        const container = document.getElementById(containerId);
        if (!specs || specs.length===0){ container.innerHTML = '<div class="p-3 text-sm text-gray-500">No specs defined.</div>'; return; }
        const htmlParts = [];
        specs.forEach((spec, specIdx)=>{
            const points = Array.isArray(spec.points) && spec.points.length ? spec.points : [''];
            htmlParts.push(
                `<div class="p-3">
                    <div class="font-medium mb-1">${escapeHtml(spec.function)} — ${escapeHtml(spec.range)} (${escapeHtml(spec.unit)})</div>
                    <div class="text-xs text-gray-600 mb-2">Tol: ${spec.tolerancePercent ?? '-'}% · Unc: ${spec.uncertaintyPercent ?? '-'}%</div>
                    <div class="overflow-auto">
                        <table class="min-w-full text-sm border">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-2 py-1 border text-left">Target (${escapeHtml(spec.unit)})</th>
                                    <th class="px-2 py-1 border">R1</th>
                                    <th class="px-2 py-1 border">R2</th>
                                    <th class="px-2 py-1 border">R3</th>
                                    <th class="px-2 py-1 border">R4</th>
                                    <th class="px-2 py-1 border">R5</th>
                                    <th class="px-2 py-1 border">Average</th>
                                    <th class="px-2 py-1 border">Correction</th>
                                    <th class="px-2 py-1 border">Avg Corrected</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${points.map((p, rowIdx)=>{
                                    const rowId = `${containerId}-s${specIdx}-r${rowIdx}`;
                                    return `
                                    <tr data-row-id="${rowId}">
                                        <td class="px-2 py-1 border">
                                            <input class="w-full border rounded px-2 py-1" data-role="applied" value="${escapeHtml(String(p))}" />
                                        </td>
                                        ${[1,2,3,4,5].map(i=>`<td class=\"px-2 py-1 border\"><input class=\"w-full border rounded px-2 py-1\" data-role=\"r${i}\" /></td>`).join('')}
                                        <td class="px-2 py-1 border"><span data-role="avg"></span></td>
                                        <td class="px-2 py-1 border"><span data-role="correction"></span></td>
                                        <td class="px-2 py-1 border"><span data-role="avgCorrected"></span></td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`
            );
        });
        container.innerHTML = htmlParts.join('');

        // Hook up calculators
        Array.from(container.querySelectorAll('tr[data-row-id]')).forEach(tr=>{
            const recalc = ()=>{
                const appliedStr = tr.querySelector('[data-role="applied"]').value;
                const readings = [1,2,3,4,5].map(i=> tr.querySelector(`[data-role="r${i}"]`).value);
                const avgStr = computeAverage(readings);
                const appliedVal = parseNumeric(appliedStr);
                const avgVal = parseNumeric(avgStr);
                const correction = (!isNaN(avgVal) && !isNaN(appliedVal)) ? (avgVal - appliedVal) : '';
                const avgCorrected = (!isNaN(avgVal) && correction!=='') ? (avgVal - correction) : '';
                const avgEl = tr.querySelector('[data-role="avg"]');
                const corrEl = tr.querySelector('[data-role="correction"]');
                const avgCorrEl = tr.querySelector('[data-role="avgCorrected"]');
                avgEl.textContent = avgStr;
                corrEl.textContent = (correction===''? '' : Number(correction).toFixed(6).replace(/0+$/,'').replace(/\.$/,''));
                avgCorrEl.textContent = (avgCorrected===''? '' : Number(avgCorrected).toFixed(6).replace(/0+$/,'').replace(/\.$/,''));
            };
            tr.querySelectorAll('input').forEach(inp=>{
                inp.addEventListener('input', recalc);
            });
            recalc();
        });
    }

    // Simple autocomplete for makes/models in calibrate tab
    function listMakes(){ return Object.keys(modelLibrary.makes); }
    function listModels(make){ return Object.keys(modelLibrary.makes[make]?.models || {}); }
    function attachAutocomplete(inputId, suggestId, provider){
        const input = document.getElementById(inputId);
        const box = document.getElementById(suggestId);
        function render(){
            const q = input.value.trim().toLowerCase();
            if (!q){ box.classList.add('hidden'); return; }
            const options = provider().filter(v=>v.toLowerCase().includes(q)).slice(0,10);
            if (options.length===0){ box.classList.add('hidden'); return; }
            box.innerHTML = options.map(o=>`<div class='px-3 py-1 hover:bg-gray-100 cursor-pointer'>${escapeHtml(o)}</div>`).join('');
            const rect = input.getBoundingClientRect();
            box.style.minWidth = rect.width+'px';
            box.classList.remove('hidden');
            Array.from(box.children).forEach(child=>{
                child.addEventListener('click', ()=>{ input.value = child.textContent; box.classList.add('hidden'); });
            });
        }
        input.addEventListener('input', render);
        input.addEventListener('blur', ()=> setTimeout(()=>box.classList.add('hidden'), 150));
    }
    attachAutocomplete('calMake', 'makeSuggestions', listMakes);
    attachAutocomplete('calModel', 'modelSuggestions', ()=>listModels(document.getElementById('calMake').value.trim()));

    // Initial render
    renderModelsTable();

    // Seed Fluke 8846A example to demonstrate understanding
    document.getElementById('seedFlukeBtn').addEventListener('click', ()=>{
        const make = 'Fluke';
        const model = '8846A';
        const m = ensureModel(make, model);
        m.asFound = [
            { function: 'DC Voltage', range: '0 - 1000 V', unit: 'V', points: ['100 mV','1 V','10 V','100 V','500 V','1000 V'], tolerancePercent: 0.05, uncertaintyPercent: 0.02 },
            { function: 'AC Voltage', range: '0 - 1000 V @ 50Hz', unit: 'V', points: ['100 mV','1 V','10 V','100 V','500 V','1000 V'], tolerancePercent: 0.1, uncertaintyPercent: 0.05 },
            { function: 'Resistance', range: '0 - 60 kΩ', unit: 'Ω', points: ['600 Ω','6 kΩ','60 kΩ'], tolerancePercent: 0.05, uncertaintyPercent: 0.02 },
            { function: 'Capacitance', range: '0 - 1000 µF', unit: 'µF', points: ['9 µF','90 µF','900 µF'], tolerancePercent: 0.2, uncertaintyPercent: 0.1 },
            { function: 'Frequency', range: '0 - 500 Hz', unit: 'Hz', points: ['50 Hz','500 Hz'], tolerancePercent: 0.1, uncertaintyPercent: 0.05 },
        ];
        m.asLeft = [
            { function: 'DC Voltage', range: '0 - 1000 V', unit: 'V', points: ['100 mV','1 V','10 V','100 V','500 V','1000 V'], tolerancePercent: 0.05, uncertaintyPercent: 0.02 },
            { function: 'AC Voltage', range: '0 - 1000 V @ 50Hz', unit: 'V', points: ['100 mV','1 V','10 V','100 V','500 V','1000 V'], tolerancePercent: 0.1, uncertaintyPercent: 0.05 },
            { function: 'Resistance', range: '0 - 60 kΩ', unit: 'Ω', points: ['600 Ω','6 kΩ','60 kΩ'], tolerancePercent: 0.05, uncertaintyPercent: 0.02 },
            { function: 'Capacitance', range: '0 - 1000 µF', unit: 'µF', points: ['9 µF','90 µF','900 µF'], tolerancePercent: 0.2, uncertaintyPercent: 0.1 },
            { function: 'Frequency', range: '0 - 500 Hz', unit: 'Hz', points: ['50 Hz','500 Hz'], tolerancePercent: 0.1, uncertaintyPercent: 0.05 },
        ];
        m.meta = m.meta || { defaultTolerance: 0.05, defaultUncertainty: 0.02, reference: { displaySN: '', displayCert: '', txSN: '', txCert: '', txRange: '' } };
        saveLibrary();
        alert('Added Fluke 8846A to library. Go to Calibrate to load specs.');
    });

    // Persist and load Setup
    const SETUP_KEY = 'electricalSetup';
    function loadSetup(){
        try{
            const raw = localStorage.getItem(SETUP_KEY);
            if (!raw) return;
            const s = JSON.parse(raw);
            const ids = ['setupLab','setupTechnician','setupDateTested','setupStandard','setupTemp','setupHumidity','setupDefaultTolerance','setupDefaultUncertainty','setupDisplaySN','setupDisplayCert','setupDisplayRange','setupTxSN','setupTxCert','setupTxRange'];
            ids.forEach(id=>{ if (s[id]!==undefined) document.getElementById(id).value = s[id]; });
        } catch(e){ console.warn('Failed to load setup', e); }
    }
    function saveSetup(){
        const ids = ['setupLab','setupTechnician','setupDateTested','setupStandard','setupTemp','setupHumidity','setupDefaultTolerance','setupDefaultUncertainty','setupDisplaySN','setupDisplayCert','setupDisplayRange','setupTxSN','setupTxCert','setupTxRange'];
        const s = {};
        ids.forEach(id=> s[id] = document.getElementById(id).value);
        localStorage.setItem(SETUP_KEY, JSON.stringify(s));
    }
    document.getElementById('saveSetupBtn').addEventListener('click', ()=>{ saveSetup(); alert('Setup saved'); });
    document.getElementById('resetSetupBtn').addEventListener('click', ()=>{ localStorage.removeItem(SETUP_KEY); loadSetup(); alert('Setup reset'); });
    loadSetup();

    // Import Setup from workbook (first sheet key/value)
    document.getElementById('importSetupBtn').addEventListener('click', async ()=>{
        const log = document.getElementById('importSetupLog');
        log.textContent='';
        try{
            const resp = await fetch('Electrical%20Workbook%20Draft.xlsm');
            if (!resp.ok) throw new Error('HTTP '+resp.status);
            const data = await resp.arrayBuffer();
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: '' });
            // Expect pairs like [Label, Value]
            const map = new Map();
            rows.forEach(r=>{
                if (r.length>=2){
                    const k = String(r[0]).trim().toLowerCase();
                    const v = r[1];
                    if (k) map.set(k, v);
                }
            });
            function setIfHas(keyVariants, id){
                for (const kv of keyVariants){
                    const v = map.get(kv);
                    if (v!==undefined){ document.getElementById(id).value = v; return true; }
                }
                return false;
            }
            setIfHas(['laboratory','lab','company'], 'setupLab');
            setIfHas(['technician','calibrated by','approved signatory'], 'setupTechnician');
            setIfHas(['date tested','date'], 'setupDateTested');
            setIfHas(['standard','standards'], 'setupStandard');
            setIfHas(['ambient temperature','temperature'], 'setupTemp');
            setIfHas(['humidity','relative humidity'], 'setupHumidity');
            setIfHas(['default tolerance','tolerance %'], 'setupDefaultTolerance');
            setIfHas(['default uncertainty','uncertainty %'], 'setupDefaultUncertainty');
            setIfHas(['display sn','display serial','display serial no'], 'setupDisplaySN');
            setIfHas(['display cert','display certificate'], 'setupDisplayCert');
            setIfHas(['display range'], 'setupDisplayRange');
            setIfHas(['tx sn','transmitter sn'], 'setupTxSN');
            setIfHas(['tx cert','transmitter cert'], 'setupTxCert');
            setIfHas(['tx range','transmitter range'], 'setupTxRange');
            saveSetup();
            log.textContent = 'Setup imported from workbook first sheet.';
        } catch(e){
            console.error(e);
            log.textContent = 'Failed to import setup. Ensure the workbook is served over http and present in the folder.';
        }
    });

    </script>
    </div>
</body>
</html>


