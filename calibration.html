<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calibration - WIKA Calibration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Calibration Management</h1>
                <p class="text-sm text-gray-600">Welcome, <span id="userName"></span> (<span id="userRole"></span>)</p>
            </div>
            <div class="flex space-x-4">
                <a href="home.html" class="bg-gray-500 hover:bg-gray-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-home mr-2"></i>Home
                </a>
                <button onclick="logout()" class="bg-red-500 hover:bg-red-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
        </div>

        <!-- Management Links -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <a href="reference-equipment.html" class="inline-flex items-center bg-indigo-500 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg shadow-md">
                <i class="fas fa-tools mr-2"></i>
                <span class="font-semibold">Manage Reference Equipment</span>
            </a>
            <button onclick="showCertificates()" class="inline-flex items-center bg-blue-500 hover:bg-blue-700 text-white px-6 py-3 rounded-lg shadow-md">
                <i class="fas fa-certificate mr-2"></i>
                <span class="font-semibold">View All Certificates</span>
            </button>
            <button onclick="showManageUsers()" class="inline-flex items-center bg-purple-500 hover:bg-purple-700 text-white px-6 py-3 rounded-lg shadow-md">
                <i class="fas fa-user-cog mr-2"></i>
                <span class="font-semibold">Manage User Signatures</span>
            </button>
        </div>

        <!-- Calibration Type Selection -->
        <div class="mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Select Calibration Type</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

                <!-- Electrical - TRACE only -->
                <div class="bg-white rounded-xl shadow p-6">
                    <div class="text-center mb-4">
                        <div class="text-yellow-600 text-5xl mb-2"><i class="fas fa-bolt"></i></div>
                        <div class="text-lg font-semibold">Electrical</div>
                    </div>
                    <div class="space-y-2">
                        <a href="electrical-trace.html" class="block bg-yellow-500 hover:bg-yellow-700 text-white px-4 py-2 rounded text-center">
                            <i class="fas fa-certificate mr-2"></i>TRACE Calibration
                        </a>
                        <button disabled class="block w-full bg-gray-300 text-gray-500 px-4 py-2 rounded text-center cursor-not-allowed">
                            <i class="fas fa-award mr-2"></i>NATA - Coming Soon
                        </button>
                    </div>
                </div>

                <!-- Torque - TRACE only -->
                <div class="bg-white rounded-xl shadow p-6">
                    <div class="text-center mb-4">
                        <div class="text-purple-600 text-5xl mb-2"><i class="fas fa-wrench"></i></div>
                        <div class="text-lg font-semibold">Torque</div>
                    </div>
                    <div class="space-y-2">
                        <a href="torque-trace.html" class="block bg-purple-500 hover:bg-purple-700 text-white px-4 py-2 rounded text-center">
                            <i class="fas fa-certificate mr-2"></i>TRACE Calibration
                        </a>
                        <button disabled class="block w-full bg-gray-300 text-gray-500 px-4 py-2 rounded text-center cursor-not-allowed">
                            <i class="fas fa-award mr-2"></i>NATA - Coming Soon
                        </button>
                    </div>
                </div>

                <!-- Dimensional - TRACE only -->
                <div class="bg-white rounded-xl shadow p-6">
                    <div class="text-center mb-4">
                        <div class="text-green-600 text-5xl mb-2"><i class="fas fa-ruler"></i></div>
                        <div class="text-lg font-semibold">Dimensional</div>
                    </div>
                    <div class="space-y-2">
                        <a href="dimensional-trace.html" class="block bg-green-500 hover:bg-green-700 text-white px-4 py-2 rounded text-center">
                            <i class="fas fa-certificate mr-2"></i>TRACE Calibration
                        </a>
                        <button disabled class="block w-full bg-gray-300 text-gray-500 px-4 py-2 rounded text-center cursor-not-allowed">
                            <i class="fas fa-award mr-2"></i>NATA - Coming Soon
                        </button>
                    </div>
                </div>

                <!-- Coming Soon Types -->
                <div class="bg-white rounded-xl shadow p-6 opacity-60">
                    <div class="text-center mb-4">
                        <div class="text-gray-400 text-5xl mb-2"><i class="fas fa-weight"></i></div>
                        <div class="text-lg font-semibold text-gray-600">Weights & Scales</div>
                    </div>
                    <div class="text-center text-sm text-gray-500">Coming soon</div>
                </div>

                <div class="bg-white rounded-xl shadow p-6 opacity-60">
                    <div class="text-center mb-4">
                        <div class="text-gray-400 text-5xl mb-2"><i class="fas fa-wind"></i></div>
                        <div class="text-lg font-semibold text-gray-600">Flow</div>
                    </div>
                    <div class="text-center text-sm text-gray-500">Coming soon</div>
                </div>

                <div class="bg-white rounded-xl shadow p-6 opacity-60">
                    <div class="text-center mb-4">
                        <div class="text-gray-400 text-5xl mb-2"><i class="fas fa-plug"></i></div>
                        <div class="text-lg font-semibold text-gray-600">High Voltage</div>
                    </div>
                    <div class="text-center text-sm text-gray-500">Coming soon</div>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Quick Overview</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Electrical Stats -->
                <div class="text-center p-4 bg-yellow-50 rounded border border-yellow-200">
                    <div class="text-2xl font-bold text-yellow-600" id="electricalTotalCount">0</div>
                    <div class="text-sm font-semibold text-gray-700 mb-2">Electrical</div>
                    <div class="text-xs text-gray-600">
                        <div>TRACE: <span id="electricalTraceCount" class="font-semibold">0</span></div>
                        <div class="text-gray-400">NATA: Coming soon</div>
                    </div>
                </div>

                <!-- Torque Stats -->
                <div class="text-center p-4 bg-purple-50 rounded border border-purple-200">
                    <div class="text-2xl font-bold text-purple-600" id="torqueTotalCount">0</div>
                    <div class="text-sm font-semibold text-gray-700 mb-2">Torque</div>
                    <div class="text-xs text-gray-600">
                        <div>TRACE: <span id="torqueTraceCount" class="font-semibold">0</span></div>
                        <div class="text-gray-400">NATA: Coming soon</div>
                    </div>
                </div>

                <!-- Dimensional Stats -->
                <div class="text-center p-4 bg-green-50 rounded border border-green-200">
                    <div class="text-2xl font-bold text-green-600" id="dimensionalTotalCount">0</div>
                    <div class="text-sm font-semibold text-gray-700 mb-2">Dimensional</div>
                    <div class="text-xs text-gray-600">
                        <div>TRACE: <span id="dimensionalTraceCount" class="font-semibold">0</span></div>
                        <div class="text-gray-400">NATA: Coming soon</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Certificates Modal -->
    <div id="certificatesModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="display: flex; align-items: center; justify-content: center; height: 100%;">
            <div class="bg-white rounded-lg shadow-lg p-6 w-11/12 max-w-6xl max-h-screen overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">All Calibration Certificates</h2>
                    <button onclick="closeCertificates()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <div class="mb-4">
                    <input type="text" id="certSearch" placeholder="Search by certificate no, customer, serial number..." class="w-full border rounded px-4 py-2" onkeyup="filterCertificates()">
                </div>
                
                <div id="certificatesList">
                    <!-- Certificates will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Users Modal -->
    <div id="manageUsersModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="display: flex; align-items: center; justify-content: center; height: 100%;">
            <div class="bg-white rounded-lg shadow-lg p-6 w-11/12 max-w-2xl">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Manage User Signatures</h2>
                    <button onclick="closeManageUsers()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3">Upload Your Digital Signature</h3>
                    <p class="text-sm text-gray-600 mb-4">This signature will automatically appear on all calibration certificates you generate.</p>
                    
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center mb-4">
                        <div id="signaturePreviewContainer" class="mb-4 hidden">
                            <p class="text-sm font-semibold mb-2">Current Signature:</p>
                            <img id="signaturePreview" style="max-width: 300px; max-height: 100px; margin: 0 auto; border: 1px solid #ddd; padding: 5px;" alt="Signature">
                        </div>
                        
                        <input type="file" id="signatureUpload" accept="image/*" class="hidden" onchange="handleSignatureUpload(event)">
                        <button onclick="document.getElementById('signatureUpload').click()" class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded mb-2">
                            <i class="fas fa-upload mr-2"></i>Upload Signature
                        </button>
                        <p class="text-xs text-gray-500">PNG, JPG, or GIF (max 500KB, recommended: transparent PNG)</p>
                    </div>
                    
                    <button id="removeSignatureBtn" onclick="removeSignature()" class="bg-red-500 hover:bg-red-700 text-white px-4 py-2 rounded text-sm hidden">
                        <i class="fas fa-trash mr-2"></i>Remove Signature
                    </button>
                </div>
                
                <div class="flex justify-end">
                    <button onclick="closeManageUsers()" class="bg-gray-500 hover:bg-gray-700 text-white px-4 py-2 rounded">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

<script>
const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
if (!currentUser) {
    window.location.href = 'index.html';
}

document.addEventListener('DOMContentLoaded', function() {
    setupUserInfo();
    loadStats();
    loadUserSignature();
});

function setupUserInfo() {
    document.getElementById('userName').textContent = currentUser.name;
    document.getElementById('userRole').textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
}

function logout() {
    sessionStorage.removeItem('currentUser');
    window.location.href = 'index.html';
}

function loadStats() {
    // Load calibration counts from localStorage
    const electricalTrace = JSON.parse(localStorage.getItem('electricalTraceCalibrations') || '[]');
    const torqueTrace = JSON.parse(localStorage.getItem('torqueTraceCalibrations') || '[]');
    const dimensionalTrace = JSON.parse(localStorage.getItem('dimensionalTraceCalibrations') || '[]');
    
    // Electrical
    document.getElementById('electricalTotalCount').textContent = electricalTrace.length;
    document.getElementById('electricalTraceCount').textContent = electricalTrace.length;
    
    // Torque
    document.getElementById('torqueTotalCount').textContent = torqueTrace.length;
    document.getElementById('torqueTraceCount').textContent = torqueTrace.length;
    
    // Dimensional
    document.getElementById('dimensionalTotalCount').textContent = dimensionalTrace.length;
    document.getElementById('dimensionalTraceCount').textContent = dimensionalTrace.length;
}

// ============================================================================
// CERTIFICATES MANAGEMENT
// ============================================================================

function showCertificates() {
    document.getElementById('certificatesModal').style.display = 'block';
    loadAllCertificates();
}

function closeCertificates() {
    document.getElementById('certificatesModal').style.display = 'none';
}

function loadAllCertificates() {
    // Load all certificate types
    const torqueCerts = JSON.parse(localStorage.getItem('torqueCertificates') || '[]');
    const electricalCerts = JSON.parse(localStorage.getItem('electricalCertificates') || '[]');
    const dimensionalCerts = JSON.parse(localStorage.getItem('dimensionalCertificates') || '[]');
    
    const allCerts = [
        ...torqueCerts.map(c => ({...c, type: 'Torque'})),
        ...electricalCerts.map(c => ({...c, type: 'Electrical'})),
        ...dimensionalCerts.map(c => ({...c, type: 'Dimensional'}))
    ];
    
    // Sort by date (newest first)
    allCerts.sort((a, b) => new Date(b.dateTested || b.timestamp) - new Date(a.dateTested || a.timestamp));
    
    renderCertificates(allCerts);
}

function renderCertificates(certs) {
    const container = document.getElementById('certificatesList');
    
    if (certs.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500 py-8">No certificates found</p>';
        return;
    }
    
    container.innerHTML = certs.map(cert => `
        <div class="border border-gray-200 rounded-lg p-4 mb-3 hover:border-blue-400 transition">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-2">
                        <span class="inline-block px-2 py-1 text-xs font-semibold rounded ${getCertTypeColor(cert.type)}">${cert.type}</span>
                        <h3 class="font-bold text-lg">${cert.certificateNo || cert.certNo || 'N/A'}</h3>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div><span class="font-semibold">Customer:</span> ${cert.customer || 'N/A'}</div>
                        <div><span class="font-semibold">Serial No:</span> ${cert.serialNumber || cert.serialNo || 'N/A'}</div>
                        <div><span class="font-semibold">Make/Model:</span> ${cert.make || 'N/A'} ${cert.model || ''}</div>
                        <div><span class="font-semibold">Date:</span> ${cert.dateTested || 'N/A'}</div>
                    </div>
                </div>
                <div class="flex flex-col space-y-2 ml-4">
                    <button onclick="viewCertificateExternal('${cert.id}', '${cert.type}')" class="bg-blue-500 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                        <i class="fas fa-eye"></i> View
                    </button>
                    <button onclick="deleteCertificateExternal('${cert.id}', '${cert.type}')" class="bg-red-500 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

function getCertTypeColor(type) {
    const colors = {
        'Torque': 'bg-purple-100 text-purple-800',
        'Electrical': 'bg-yellow-100 text-yellow-800',
        'Dimensional': 'bg-green-100 text-green-800'
    };
    return colors[type] || 'bg-gray-100 text-gray-800';
}

function filterCertificates() {
    const search = document.getElementById('certSearch').value.toLowerCase();
    loadAllCertificates();
    
    if (!search) return;
    
    const allCerts = Array.from(document.querySelectorAll('#certificatesList > div'));
    allCerts.forEach(cert => {
        const text = cert.textContent.toLowerCase();
        cert.style.display = text.includes(search) ? 'block' : 'none';
    });
}

function viewCertificateExternal(certId, type) {
    const storageKey = type.toLowerCase() + 'Certificates';
    const certs = JSON.parse(localStorage.getItem(storageKey) || '[]');
    const cert = certs.find(c => c.id === certId);
    
    if (!cert) {
        alert('Certificate not found');
        return;
    }
    
    alert('Certificate viewer opening - functionality from specific calibration type');
}

function deleteCertificateExternal(certId, type) {
    if (!confirm('Delete this certificate? This cannot be undone.')) return;
    
    const storageKey = type.toLowerCase() + 'Certificates';
    let certs = JSON.parse(localStorage.getItem(storageKey) || '[]');
    certs = certs.filter(c => c.id !== certId);
    localStorage.setItem(storageKey, JSON.stringify(certs));
    
    loadAllCertificates();
    loadStats();
    alert('Certificate deleted');
}

// ============================================================================
// USER SIGNATURE MANAGEMENT
// ============================================================================

let userSignature = null;

function loadUserSignature() {
    const stored = localStorage.getItem(`signature_${currentUser.id || currentUser.name}`);
    if (stored) {
        userSignature = stored;
    }
}

function showManageUsers() {
    document.getElementById('manageUsersModal').style.display = 'block';
    displaySignaturePreview();
}

function closeManageUsers() {
    document.getElementById('manageUsersModal').style.display = 'none';
}

function handleSignatureUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (file.size > 500000) {
        alert('File too large! Maximum size is 500KB');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        userSignature = e.target.result;
        localStorage.setItem(`signature_${currentUser.id || currentUser.name}`, userSignature);
        displaySignaturePreview();
        alert('Signature uploaded successfully! This will appear on all your calibration certificates.');
    };
    reader.readAsDataURL(file);
}

function displaySignaturePreview() {
    if (userSignature) {
        document.getElementById('signaturePreview').src = userSignature;
        document.getElementById('signaturePreviewContainer').classList.remove('hidden');
        document.getElementById('removeSignatureBtn').classList.remove('hidden');
    }
}

function removeSignature() {
    if (confirm('Remove your signature? It will no longer appear on certificates.')) {
        userSignature = null;
        localStorage.removeItem(`signature_${currentUser.id || currentUser.name}`);
        document.getElementById('signaturePreviewContainer').classList.add('hidden');
        document.getElementById('removeSignatureBtn').classList.add('hidden');
        alert('Signature removed');
    }
}
</script>
</body>
</html>

