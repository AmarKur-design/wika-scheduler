<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warehouse - WIKA Calibration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 2rem; border-radius: 0.5rem; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; }
        .inbound-item { border-left: 4px solid #3b82f6; }
        .outbound-item { border-left: 4px solid #f59e0b; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Warehouse Management</h1>
                <p class="text-sm text-gray-600">Welcome, <span id="userName"></span> (<span id="userRole"></span>)</p>
            </div>
            <div class="flex space-x-4">
                <button onclick="showCollectionHistory()" class="bg-indigo-500 hover:bg-indigo-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-history mr-2"></i>Collection History
                </button>
                <button onclick="showScannerModal()" class="bg-purple-500 hover:bg-purple-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-qrcode mr-2"></i>Scan Barcode
                </button>
                <a href="home.html" id="homeBtn" class="bg-gray-500 hover:bg-gray-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-home mr-2"></i>Home
                </a>
                <button onclick="logout()" class="bg-red-500 hover:bg-red-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
        </div>

        <!-- INBOUND Section - Full Width at Top -->
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="px-6 py-4 border-b border-gray-200 bg-blue-50">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-semibold text-blue-900">Inbound</h2>
                        <p class="text-sm text-blue-700">Items received - route to Pending, Quotation, or Lab</p>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="expandInbound()" class="bg-gray-500 hover:bg-gray-700 text-white px-3 py-2 rounded" title="Expand Full View">
                            <i class="fas fa-expand"></i>
                        </button>
                        <button onclick="showCustomerForm()" class="bg-green-500 hover:bg-green-700 text-white px-4 py-2 rounded">
                            <i class="fas fa-users mr-2"></i>Customer Form
                        </button>
                        <button onclick="showAddInboundModal()" class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded">
                            <i class="fas fa-plus mr-2"></i>Add Item
                        </button>
                    </div>
                </div>
            </div>
            <div id="inboundList" class="p-4 space-y-3" style="max-height: 200px; overflow-y: auto;">
                <!-- Inbound items will be rendered here -->
            </div>
        </div>

        <!-- OUTBOUND Section - Full Width -->
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="px-6 py-4 border-b border-gray-200 bg-orange-50">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-semibold text-orange-900">Outbound</h2>
                        <p class="text-sm text-orange-700">Items ready for pickup</p>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="expandOutbound()" class="bg-gray-500 hover:bg-gray-700 text-white px-3 py-2 rounded" title="Expand Full View">
                            <i class="fas fa-expand"></i>
                        </button>
                        <button onclick="showAddOutboundModal()" class="bg-orange-500 hover:bg-orange-700 text-white px-4 py-2 rounded">
                            <i class="fas fa-plus mr-2"></i>Add Item
                        </button>
                    </div>
                </div>
            </div>
            <div id="outboundList" class="p-4 space-y-3" style="max-height: 200px; overflow-y: auto;">
                <!-- Outbound items will be rendered here -->
            </div>
        </div>

        <!-- PENDING Section - Full Width -->
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="px-6 py-4 border-b border-gray-200 bg-yellow-50">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-semibold text-yellow-900">Pending</h2>
                        <p class="text-sm text-yellow-700">Awaiting payment or other items</p>
                    </div>
                </div>
            </div>
            <div id="pendingList" class="p-4 space-y-3 max-h-[350px] overflow-y-auto">
                <!-- Pending items will be rendered here -->
            </div>
        </div>

        <!-- QUOTATION SHELF Section - Full Width -->
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="px-6 py-4 border-b border-gray-200 bg-purple-50">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-semibold text-purple-900">Quotation Shelf</h2>
                        <p class="text-sm text-purple-700">Items for quotation</p>
                    </div>
                </div>
            </div>
            <div id="quotationList" class="p-4 space-y-3 max-h-[350px] overflow-y-auto">
                <!-- Quotation items will be rendered here -->
            </div>
        </div>

        <!-- LAB Section - Full Width -->
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="px-6 py-4 border-b border-gray-200 bg-green-50">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-semibold text-green-900">Lab</h2>
                        <p class="text-sm text-green-700">Items in calibration</p>
                    </div>
                </div>
            </div>
            <div id="labList" class="p-4 space-y-3 max-h-[350px] overflow-y-auto">
                <!-- Lab items will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Add Item Modal -->
    <div id="inboundModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">Add Item to Inbound</h2>
            <form id="inboundForm" onsubmit="saveInboundItem(event)">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="relative">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Company Name *</label>
                        <input id="companyName" type="text" required 
                               class="w-full border border-gray-300 rounded px-3 py-2" 
                               placeholder="Start typing customer name..."
                               oninput="showInboundCustomerSuggestions()"
                               onfocus="showInboundCustomerSuggestions()"
                               autocomplete="off">
                        <div id="inboundCustomerSuggestions" class="hidden absolute z-50 w-full bg-white border border-gray-300 rounded-b shadow-lg max-h-60 overflow-y-auto" style="top: 100%; left: 0;"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">WO Number</label>
                        <input id="woNumber" type="text" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Optional">
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Make *</label>
                        <input id="itemMake" type="text" required class="w-full border border-gray-300 rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Model *</label>
                        <input id="itemModel" type="text" required class="w-full border border-gray-300 rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Serial Number *</label>
                        <input id="serialNumber" type="text" required class="w-full border border-gray-300 rounded px-3 py-2">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Barcode</label>
                    <div class="flex space-x-2">
                        <input id="barcode" type="text" class="flex-1 border border-gray-300 rounded px-3 py-2" placeholder="Scan or enter barcode">
                        <button type="button" onclick="openBarcodeScanner()" class="bg-purple-500 hover:bg-purple-700 text-white px-4 py-2 rounded">
                            <i class="fas fa-qrcode"></i>
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Contact Person</label>
                        <input id="contactPerson" type="text" class="w-full border border-gray-300 rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                        <input id="phoneNumber" type="text" class="w-full border border-gray-300 rounded px-3 py-2">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input id="email" type="email" class="w-full border border-gray-300 rounded px-3 py-2">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">PO/Quote Number</label>
                    <input id="poNumber" type="text" class="w-full border border-gray-300 rounded px-3 py-2">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Item Image</label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                        <input type="file" id="inboundItemImage" accept="image/*" class="hidden" onchange="handleInboundImageUpload(event)">
                        <div id="inboundImagePreview" class="hidden mb-2">
                            <img id="inboundPreviewImg" class="max-w-full max-h-48 mx-auto rounded" alt="Item preview">
                            <button type="button" onclick="removeInboundImage()" class="mt-2 text-red-500 hover:text-red-700 text-sm">
                                <i class="fas fa-trash mr-1"></i>Remove Image
                            </button>
                        </div>
                        <div id="inboundImageUploadArea" class="space-y-2">
                            <div class="cursor-pointer" onclick="document.getElementById('inboundItemImage').click()">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                                <p class="text-gray-600">Click to upload image</p>
                            </div>
                            <div class="border-t border-gray-200 pt-2">
                                <button type="button" onclick="openInboundCameraModal()" class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">
                                    <i class="fas fa-camera mr-2"></i>Take Photo
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">PNG, JPG, JPEG up to 5MB</p>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="closeInboundModal()" class="bg-gray-500 hover:bg-gray-700 text-white px-4 py-2 rounded">
                        Cancel
                    </button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded">
                        Add to Inbound
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Outbound Item Modal -->
    <div id="outboundModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">Add Item to Outbound</h2>
            <form id="outboundForm" onsubmit="saveOutboundItem(event)">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="relative">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Company Name *</label>
                        <input id="outboundCompanyName" type="text" required 
                               class="w-full border border-gray-300 rounded px-3 py-2"
                               placeholder="Start typing customer name..."
                               oninput="showOutboundCustomerSuggestions()"
                               onfocus="showOutboundCustomerSuggestions()"
                               autocomplete="off">
                        <div id="outboundCustomerSuggestions" class="hidden absolute z-50 w-full bg-white border border-gray-300 rounded-b shadow-lg max-h-60 overflow-y-auto" style="top: 100%; left: 0;"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Sales Order Number</label>
                        <input id="outboundPoNumber" type="text" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Optional">
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Make</label>
                        <input id="outboundItemMake" type="text" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Optional">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Model</label>
                        <input id="outboundItemModel" type="text" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Optional">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Serial Number</label>
                        <input id="outboundSerialNumber" type="text" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Optional">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Contact Person</label>
                        <input id="outboundContactPerson" type="text" class="w-full border border-gray-300 rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                        <input id="outboundPhoneNumber" type="text" class="w-full border border-gray-300 rounded px-3 py-2">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input id="outboundEmail" type="email" class="w-full border border-gray-300 rounded px-3 py-2">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Connote Number</label>
                    <input id="outboundConnoteNumber" type="text" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="For courier tracking">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Item Image</label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                        <input type="file" id="outboundItemImage" accept="image/*" class="hidden" onchange="handleOutboundImageUpload(event)">
                        <div id="outboundImagePreview" class="hidden mb-2">
                            <img id="outboundPreviewImg" class="max-w-full max-h-48 mx-auto rounded" alt="Item preview">
                            <button type="button" onclick="removeOutboundImage()" class="mt-2 text-red-500 hover:text-red-700 text-sm">
                                <i class="fas fa-trash mr-1"></i>Remove Image
                            </button>
                        </div>
                        <div id="outboundImageUploadArea" class="space-y-2">
                            <div class="cursor-pointer" onclick="document.getElementById('outboundItemImage').click()">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                                <p class="text-gray-600">Click to upload image</p>
                            </div>
                            <div class="border-t border-gray-200 pt-2">
                                <button type="button" onclick="openOutboundCameraModal()" class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">
                                    <i class="fas fa-camera mr-2"></i>Take Photo
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">PNG, JPG, JPEG up to 5MB</p>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="closeOutboundModal()" class="bg-gray-500 hover:bg-gray-700 text-white px-4 py-2 rounded">
                        Cancel
                    </button>
                    <button type="submit" class="bg-orange-500 hover:bg-orange-700 text-white px-4 py-2 rounded">
                        Add to Outbound
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Barcode Scanner Modal -->
    <div id="scannerModal" class="modal" onclick="closeScannerModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 class="text-2xl font-bold mb-4">Scan Barcode</h2>
            <div id="reader" style="width: 100%;"></div>
            <div class="mt-4">
                <p class="text-sm text-gray-600 mb-2">Or enter barcode manually:</p>
                <input id="manualBarcodeInput" type="text" class="w-full border border-gray-300 rounded px-3 py-2 mb-4" placeholder="Enter barcode">
                <div class="flex justify-end space-x-4">
                    <button onclick="closeScannerModal()" class="bg-gray-500 hover:bg-gray-700 text-white px-4 py-2 rounded">
                        Cancel
                    </button>
                    <button onclick="searchByBarcode()" class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded">
                        Search
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Signature Modal -->
    <div id="signatureModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">Collection Signature</h2>
            <form id="signatureForm" onsubmit="saveSignature(event)">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Collector Name *</label>
                    <input id="collectorName" type="text" required class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Enter name">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Signature *</label>
                    <canvas id="signatureCanvas" width="400" height="200" class="border-2 border-gray-300 rounded cursor-crosshair" style="touch-action: none;"></canvas>
                    <button type="button" onclick="clearSignature()" class="mt-2 text-sm text-blue-500 hover:text-blue-700">
                        <i class="fas fa-redo"></i> Clear Signature
                    </button>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="closeSignatureModal()" class="bg-gray-500 hover:bg-gray-700 text-white px-4 py-2 rounded">
                        Cancel
                    </button>
                    <button type="submit" class="bg-green-500 hover:bg-green-700 text-white px-4 py-2 rounded">
                        Save Signature
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Expanded Inbound Modal -->
    <div id="expandedInboundModal" class="modal">
        <div class="modal-content" style="max-width: 95%; max-height: 95vh;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-blue-900">Inbound - Full View</h2>
                <button onclick="closeExpandedInbound()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div id="expandedInboundContent" class="overflow-auto" style="max-height: 80vh;">
                <!-- Full inbound list will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Expanded Outbound Modal -->
    <div id="expandedOutboundModal" class="modal">
        <div class="modal-content" style="max-width: 95%; max-height: 95vh;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-orange-900">Outbound - Full View</h2>
                <button onclick="closeExpandedOutbound()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div id="expandedOutboundContent" class="overflow-auto" style="max-height: 80vh;">
                <!-- Full outbound list will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Collection History Modal -->
    <div id="collectionHistoryModal" class="modal">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Collection History</h2>
                <button onclick="closeCollectionHistory()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <!-- Search and Filters -->
            <div class="mb-4 grid grid-cols-3 gap-4">
                <input id="historySearchCompany" type="text" placeholder="Search by company..." class="border border-gray-300 rounded px-3 py-2" oninput="filterCollectionHistory()">
                <input id="historySearchCollector" type="text" placeholder="Search by collector..." class="border border-gray-300 rounded px-3 py-2" oninput="filterCollectionHistory()">
                <input id="historySearchDate" type="date" class="border border-gray-300 rounded px-3 py-2" onchange="filterCollectionHistory()">
            </div>
            
            <!-- History Table -->
            <div id="collectionHistoryContent" class="overflow-auto" style="max-height: 500px;">
                <!-- Content will be rendered here -->
            </div>
            
            <div class="mt-4 flex justify-end">
                <button onclick="closeCollectionHistory()" class="bg-gray-500 hover:bg-gray-700 text-white px-4 py-2 rounded">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Customer Form Modal -->
    <div id="customerFormModal" class="modal">
        <div class="modal-content" style="max-width: 95vw; max-height: 95vh; width: 1200px;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Customer Form - Multiple Items</h2>
                <button onclick="closeCustomerForm()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <form id="customerForm" onsubmit="saveCustomerForm(event)">
                <!-- Customer Information Section -->
                <div class="bg-blue-50 p-4 rounded-lg mb-6">
                    <h3 class="text-lg font-semibold text-blue-900 mb-4">Customer Information</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Company Name *</label>
                            <input id="customerCompanyName" type="text" required class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Company Name">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Quote Request</label>
                            <select id="customerQuoteRequest" class="w-full border border-gray-300 rounded px-3 py-2">
                                <option value="">Select Option</option>
                                <option value="Yes">Yes - Please provide quote</option>
                                <option value="No">No - Proceed with calibration</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Address *</label>
                            <textarea id="customerAddress" required class="w-full border border-gray-300 rounded px-3 py-2" rows="2" placeholder="Full Address"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Contact Name *</label>
                            <input id="customerContactName" type="text" required class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Contact Person">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number *</label>
                            <input id="customerPhoneNumber" type="tel" required class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Phone Number">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                            <input id="customerEmail" type="email" required class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Email Address">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">PO/Quote Number</label>
                            <input id="customerPoNumber" type="text" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="PO/Quote Number">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Work Required *</label>
                            <select id="customerWorkRequired" required class="w-full border border-gray-300 rounded px-3 py-2">
                                <option value="">Select Work Type</option>
                                <option value="Calibration">Calibration</option>
                                <option value="Repair">Repair</option>
                                <option value="Testing">Testing</option>
                                <option value="Inspection">Inspection</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Certification Type *</label>
                            <select id="customerCertType" required class="w-full border border-gray-300 rounded px-3 py-2">
                                <option value="">Select Certification</option>
                                <option value="TRACE">TRACE</option>
                                <option value="NATA">NATA</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Number of Calibration Points</label>
                            <input id="customerCalPoints" type="number" min="1" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Number of points">
                        </div>
                    </div>
                </div>

                <!-- Items Section -->
                <div class="bg-gray-50 p-4 rounded-lg mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Items to be Calibrated</h3>
                        <button type="button" onclick="addCustomerItem()" class="bg-green-500 hover:bg-green-700 text-white px-4 py-2 rounded">
                            <i class="fas fa-plus mr-2"></i>Add Another Item
                        </button>
                    </div>
                    <div id="customerItemsList" class="space-y-4">
                        <!-- Items will be added here dynamically -->
                    </div>
                </div>

                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="closeCustomerForm()" class="bg-gray-500 hover:bg-gray-700 text-white px-6 py-3 rounded">
                        Cancel
                    </button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white px-6 py-3 rounded">
                        <i class="fas fa-save mr-2"></i>Submit All Items
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Camera Modal for Inbound -->
    <div id="inboundCameraModal" class="modal">
        <div class="modal-content" style="max-width: 90vw; max-height: 90vh;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Take Photo - Inbound Item</h2>
                <button onclick="closeInboundCameraModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div class="text-center">
                <video id="inboundCameraVideo" autoplay playsinline class="w-full max-w-md mx-auto rounded mb-4" style="display: none;"></video>
                <canvas id="inboundCameraCanvas" class="hidden"></canvas>
                <div id="inboundCameraControls" class="space-y-4">
                    <button onclick="startInboundCamera()" class="bg-green-500 hover:bg-green-700 text-white px-6 py-3 rounded">
                        <i class="fas fa-video mr-2"></i>Start Camera
                    </button>
                    <div id="inboundCaptureControls" class="hidden space-y-2">
                        <button onclick="captureInboundPhoto()" class="bg-blue-500 hover:bg-blue-700 text-white px-6 py-3 rounded">
                            <i class="fas fa-camera mr-2"></i>Capture Photo
                        </button>
                        <button onclick="stopInboundCamera()" class="bg-gray-500 hover:bg-gray-700 text-white px-6 py-3 rounded">
                            <i class="fas fa-stop mr-2"></i>Stop Camera
                        </button>
                    </div>
                </div>
                <div id="inboundCameraError" class="hidden text-red-600 mt-4">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <span id="inboundCameraErrorMessage">Camera access denied or not available</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Camera Modal for Outbound -->
    <div id="outboundCameraModal" class="modal">
        <div class="modal-content" style="max-width: 90vw; max-height: 90vh;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Take Photo - Outbound Item</h2>
                <button onclick="closeOutboundCameraModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div class="text-center">
                <video id="outboundCameraVideo" autoplay playsinline class="w-full max-w-md mx-auto rounded mb-4" style="display: none;"></video>
                <canvas id="outboundCameraCanvas" class="hidden"></canvas>
                <div id="outboundCameraControls" class="space-y-4">
                    <button onclick="startOutboundCamera()" class="bg-green-500 hover:bg-green-700 text-white px-6 py-3 rounded">
                        <i class="fas fa-video mr-2"></i>Start Camera
                    </button>
                    <div id="outboundCaptureControls" class="hidden space-y-2">
                        <button onclick="captureOutboundPhoto()" class="bg-blue-500 hover:bg-blue-700 text-white px-6 py-3 rounded">
                            <i class="fas fa-camera mr-2"></i>Capture Photo
                        </button>
                        <button onclick="stopOutboundCamera()" class="bg-gray-500 hover:bg-gray-700 text-white px-6 py-3 rounded">
                            <i class="fas fa-stop mr-2"></i>Stop Camera
                        </button>
                    </div>
                </div>
                <div id="outboundCameraError" class="hidden text-red-600 mt-4">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <span id="outboundCameraErrorMessage">Camera access denied or not available</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Camera Modal for Customer Form Items -->
    <div id="customerItemCameraModal" class="modal">
        <div class="modal-content" style="max-width: 90vw; max-height: 90vh;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Take Photo - Customer Item</h2>
                <button onclick="closeCustomerItemCameraModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div class="text-center">
                <video id="customerItemCameraVideo" autoplay playsinline class="w-full max-w-md mx-auto rounded mb-4" style="display: none;"></video>
                <canvas id="customerItemCameraCanvas" class="hidden"></canvas>
                <div id="customerItemCameraControls" class="space-y-4">
                    <button onclick="startCustomerItemCamera()" class="bg-green-500 hover:bg-green-700 text-white px-6 py-3 rounded">
                        <i class="fas fa-video mr-2"></i>Start Camera
                    </button>
                    <div id="customerItemCaptureControls" class="hidden space-y-2">
                        <button onclick="captureCustomerItemPhoto()" class="bg-blue-500 hover:bg-blue-700 text-white px-6 py-3 rounded">
                            <i class="fas fa-camera mr-2"></i>Capture Photo
                        </button>
                        <button onclick="stopCustomerItemCamera()" class="bg-gray-500 hover:bg-gray-700 text-white px-6 py-3 rounded">
                            <i class="fas fa-stop mr-2"></i>Stop Camera
                        </button>
                    </div>
                </div>
                <div id="customerItemCameraError" class="hidden text-red-600 mt-4">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <span id="customerItemCameraErrorMessage">Camera access denied or not available</span>
                </div>
            </div>
        </div>
    </div>


<script>
const currentUser = JSON.parse(sessionStorage.getItem('currentUser')) || { name: 'Test User', role: 'admin' };

let inboundItems = [];
let outboundItems = [];
let pendingItems = [];
let quotationItems = [];
let labItems = [];
let collectionHistory = [];
let html5QrCode = null;
let inboundImageData = null;
let outboundImageData = null;
let inboundCameraStream = null;
let outboundCameraStream = null;
let customerItemCameraStream = null;
let currentCustomerItemCounter = null;
let customerItems = [];
let customerItemCounter = 0;

document.addEventListener('DOMContentLoaded', function() {
    setupUserInfo();
    loadWarehouseData();
    renderPendingList();
    renderQuotationList();
    renderLabList();
    renderInboundList();
    renderOutboundList();
    
    // Add escape key handler to close scanner modal
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const scannerModal = document.getElementById('scannerModal');
            if (scannerModal && scannerModal.classList.contains('show')) {
                closeScannerModal();
            }
        }
    });
});

function setupUserInfo() {
    document.getElementById('userName').textContent = currentUser.name;
    document.getElementById('userRole').textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
    
    // Hide Home button for warehouse users
    if (currentUser.role === 'warehouse') {
        const homeBtn = document.getElementById('homeBtn');
        if (homeBtn) {
            homeBtn.style.display = 'none';
        }
    }
}

function logout() {
    sessionStorage.removeItem('currentUser');
    window.location.href = 'index.html';
}

function loadWarehouseData() {
    const storedInbound = localStorage.getItem('inboundItems');
    const storedOutbound = localStorage.getItem('outboundItems');
    const storedPending = localStorage.getItem('pendingItems');
    const storedQuotation = localStorage.getItem('quotationItems');
    const storedLab = localStorage.getItem('labItems');
    const storedHistory = localStorage.getItem('collectionHistory');
    
    if (storedInbound) {
        inboundItems = JSON.parse(storedInbound);
    }
    if (storedOutbound) {
        outboundItems = JSON.parse(storedOutbound);
    }
    if (storedPending) {
        pendingItems = JSON.parse(storedPending);
    }
    if (storedQuotation) {
        quotationItems = JSON.parse(storedQuotation);
    }
    if (storedLab) {
        labItems = JSON.parse(storedLab);
    }
    if (storedHistory) {
        collectionHistory = JSON.parse(storedHistory);
    }
}

function saveWarehouseData() {
    localStorage.setItem('inboundItems', JSON.stringify(inboundItems));
    localStorage.setItem('outboundItems', JSON.stringify(outboundItems));
    localStorage.setItem('pendingItems', JSON.stringify(pendingItems));
    localStorage.setItem('quotationItems', JSON.stringify(quotationItems));
    localStorage.setItem('labItems', JSON.stringify(labItems));
    localStorage.setItem('collectionHistory', JSON.stringify(collectionHistory));
}

// Render Functions for New Sections
function renderPendingList() {
    const container = document.getElementById('pendingList');
    
    if (pendingItems.length === 0) {
        container.innerHTML = `
            <div class="text-center text-gray-500 py-8">
                <i class="fas fa-clock text-4xl mb-2"></i>
                <p class="text-sm">No pending items</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <table class="w-full">
            <thead class="bg-gray-50 sticky top-0">
                <tr class="border-b border-gray-200">
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Company</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Make</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Model</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Serial Number</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Contact</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">PO/Quote</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Received</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                ${pendingItems.map((item, index) => `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-4 py-3 text-sm text-gray-900">${item.companyName}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.make}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.model}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.serialNumber}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">
                            ${item.contactPerson ? `<div>${item.contactPerson}</div>` : ''}
                            ${item.phoneNumber ? `<div class="text-xs">${item.phoneNumber}</div>` : ''}
                            ${!item.contactPerson && !item.phoneNumber ? '-' : ''}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.poNumber || '-'}</td>
                        <td class="px-4 py-3 text-xs text-gray-500 whitespace-nowrap">${new Date(item.receivedDate).toLocaleDateString()}</td>
                        <td class="px-4 py-3 text-right">
                            <div class="flex justify-end space-x-1">
                                <button onclick="movePendingToInbound(${index})" title="Move to Inbound" class="bg-blue-500 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs">
                                    <i class="fas fa-inbox"></i>
                                </button>
                                <button onclick="movePendingToOutbound(${index})" title="Move to Outbound" class="bg-orange-500 hover:bg-orange-700 text-white px-2 py-1 rounded text-xs">
                                    <i class="fas fa-truck"></i>
                                </button>
                                <button onclick="movePendingToQuotation(${index})" title="Move to Quotation" class="bg-purple-500 hover:bg-purple-700 text-white px-2 py-1 rounded text-xs">
                                    <i class="fas fa-file-invoice"></i>
                                </button>
                                <button onclick="movePendingToLab(${index})" title="Create Work Order" class="bg-green-500 hover:bg-green-700 text-white px-2 py-1 rounded text-xs">
                                    <i class="fas fa-flask"></i>
                                </button>
                                <button onclick="deletePending(${index})" title="Delete" class="bg-red-500 hover:bg-red-700 text-white px-2 py-1 rounded text-xs">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

function renderQuotationList() {
    const container = document.getElementById('quotationList');
    
    if (quotationItems.length === 0) {
        container.innerHTML = `
            <div class="text-center text-gray-500 py-8">
                <i class="fas fa-file-invoice text-4xl mb-2"></i>
                <p class="text-sm">No items for quotation</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <table class="w-full">
            <thead class="bg-gray-50 sticky top-0">
                <tr class="border-b border-gray-200">
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Company</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Make</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Model</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Serial Number</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Contact</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">PO/Quote</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Received</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                ${quotationItems.map((item, index) => `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-4 py-3 text-sm text-gray-900">${item.companyName}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.make}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.model}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.serialNumber}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">
                            ${item.contactPerson ? `<div>${item.contactPerson}</div>` : ''}
                            ${item.phoneNumber ? `<div class="text-xs">${item.phoneNumber}</div>` : ''}
                            ${!item.contactPerson && !item.phoneNumber ? '-' : ''}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.poNumber || '-'}</td>
                        <td class="px-4 py-3 text-xs text-gray-500 whitespace-nowrap">${new Date(item.receivedDate).toLocaleDateString()}</td>
                        <td class="px-4 py-3 text-right">
                            <div class="flex justify-end space-x-1">
                                <button onclick="moveQuotationToLab(${index})" title="Create Work Order" class="bg-green-500 hover:bg-green-700 text-white px-2 py-1 rounded text-xs">
                                    <i class="fas fa-flask"></i>
                                </button>
                                <button onclick="moveQuotationToOutbound(${index})" title="Move to Outbound" class="bg-orange-500 hover:bg-orange-700 text-white px-2 py-1 rounded text-xs">
                                    <i class="fas fa-truck"></i>
                                </button>
                                <button onclick="deleteQuotation(${index})" title="Delete" class="bg-red-500 hover:bg-red-700 text-white px-2 py-1 rounded text-xs">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

function renderLabList() {
    const container = document.getElementById('labList');
    
    if (labItems.length === 0) {
        container.innerHTML = `
            <div class="text-center text-gray-500 py-8">
                <i class="fas fa-flask text-4xl mb-2"></i>
                <p class="text-sm">No items in lab</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <table class="w-full">
            <thead class="bg-gray-50 sticky top-0">
                <tr class="border-b border-gray-200">
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Company</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Make</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Model</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Serial Number</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Work Order</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">In Lab Since</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                ${labItems.map((item, index) => `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-4 py-3 text-sm text-gray-900">${item.companyName}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.make}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.model}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.serialNumber}</td>
                        <td class="px-4 py-3 text-sm text-blue-600">${item.workOrderNumber || '-'}</td>
                        <td class="px-4 py-3 text-xs text-gray-500 whitespace-nowrap">${new Date(item.labDate).toLocaleDateString()}</td>
                        <td class="px-4 py-3 text-right">
                            <button onclick="deleteLab(${index})" title="Delete" class="bg-red-500 hover:bg-red-700 text-white px-2 py-1 rounded text-xs">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

function renderInboundList() {
    const container = document.getElementById('inboundList');
    
    if (inboundItems.length === 0) {
        container.innerHTML = `
            <div class="text-center text-gray-500 py-12">
                <i class="fas fa-inbox text-6xl mb-4"></i>
                <p class="text-lg">No inbound items</p>
                <p class="text-sm">Add items or scan barcodes to get started</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <table class="w-full">
            <thead class="bg-gray-50 sticky top-0">
                <tr class="border-b border-gray-200">
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Company</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Quote Request</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Make</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Model</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Serial Number</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Barcode</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Contact</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">PO/Quote</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Received</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                ${inboundItems.map((item, index) => `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-4 py-3 text-sm text-gray-900">${item.companyName}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">
                            ${item.quoteRequest ? 
                                `<span class="px-2 py-1 rounded text-xs ${item.quoteRequest === 'Yes' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">${item.quoteRequest}</span>` : 
                                '-'
                            }
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.make}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.model}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.serialNumber}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.barcode || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">
                            ${item.contactPerson ? `<div>${item.contactPerson}</div>` : ''}
                            ${item.phoneNumber ? `<div class="text-xs">${item.phoneNumber}</div>` : ''}
                            ${item.email ? `<div class="text-xs">${item.email}</div>` : ''}
                            ${!item.contactPerson && !item.phoneNumber && !item.email ? '-' : ''}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.poNumber || '-'}</td>
                        <td class="px-4 py-3 text-xs text-gray-500 whitespace-nowrap">${new Date(item.receivedDate).toLocaleDateString()}<br>${new Date(item.receivedDate).toLocaleTimeString()}</td>
                        <td class="px-4 py-3 text-right">
                            <div class="flex justify-end space-x-1">
                                <button onclick="editInboundItem(${index})" title="Edit Item" class="bg-gray-500 hover:bg-gray-700 text-white px-2 py-1 rounded text-xs">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="moveInboundToPending(${index})" title="Move to Pending" class="bg-yellow-500 hover:bg-yellow-700 text-white px-2 py-1 rounded text-xs">
                                    <i class="fas fa-clock"></i>
                                </button>
                                <button onclick="moveInboundToQuotation(${index})" title="Move to Quotation" class="bg-purple-500 hover:bg-purple-700 text-white px-2 py-1 rounded text-xs">
                                    <i class="fas fa-file-invoice"></i>
                                </button>
                                <button onclick="moveInboundToLab(${index})" title="Create Work Order" class="bg-green-500 hover:bg-green-700 text-white px-2 py-1 rounded text-xs">
                                    <i class="fas fa-flask"></i>
                                </button>
                                <button onclick="moveInboundToOutbound(${index})" title="Move to Outbound" class="bg-orange-500 hover:bg-orange-700 text-white px-2 py-1 rounded text-xs">
                                    <i class="fas fa-truck"></i>
                                </button>
                                <button onclick="deleteInbound(${index})" title="Delete" class="bg-red-500 hover:bg-red-700 text-white px-2 py-1 rounded text-xs">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

function renderOutboundList() {
    const container = document.getElementById('outboundList');
    
    if (outboundItems.length === 0) {
        container.innerHTML = `
            <div class="text-center text-gray-500 py-12">
                <i class="fas fa-box-open text-6xl mb-4"></i>
                <p class="text-lg">No outbound items</p>
                <p class="text-sm">Move items from inbound when ready</p>
            </div>
        `;
        return;
    }
    
    // Group items by sales order
    const groupedBySO = {};
    outboundItems.forEach((item, index) => {
        const soNumber = item.poNumber || 'No SO';
        if (!groupedBySO[soNumber]) {
            groupedBySO[soNumber] = [];
        }
        groupedBySO[soNumber].push({ ...item, originalIndex: index });
    });
    
    container.innerHTML = `
        <table class="w-full">
            <thead class="bg-gray-50 sticky top-0">
                <tr class="border-b border-gray-200">
                    <th class="px-2 py-3 text-center text-xs font-semibold text-gray-700 uppercase">
                        <input type="checkbox" id="selectAllOutbound" onchange="toggleSelectAllOutbound(this.checked)">
                    </th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Company</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Contact</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Phone</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Sales Order</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Make</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Model</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Serial Number</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Connote #</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Signature</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Name</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Date/Time</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                ${outboundItems.map((item, index) => `
                    <tr class="hover:bg-gray-50 transition ${item.groupedForPickup ? 'bg-blue-50' : ''}">
                        <td class="px-2 py-3 text-center">
                            <input type="checkbox" class="outbound-checkbox" data-index="${index}" onchange="toggleOutboundSelection(${index})">
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900">${item.companyName}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.contactPerson || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.phoneNumber || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.poNumber || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.make}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.model}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.serialNumber}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.connoteNumber || '-'}</td>
                        <td class="px-4 py-3">
                            ${item.signature ? `<div class="text-green-600"><i class="fas fa-check-circle"></i> Signed</div>` : 
                            `<button onclick="showSignatureModal(${index})" class="text-blue-500 hover:text-blue-700 text-sm"><i class="fas fa-signature"></i> Sign</button>`}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.collectorName || '-'}</td>
                        <td class="px-4 py-3 text-xs text-gray-500 whitespace-nowrap">
                            ${item.collectionDate ? new Date(item.collectionDate).toLocaleDateString() + '<br>' + new Date(item.collectionDate).toLocaleTimeString() : '-'}
                        </td>
                        <td class="px-4 py-3 text-right">
                            <div class="flex justify-end space-x-2">
                                <button onclick="editOutboundItem(${index})" title="Edit Item" class="bg-gray-500 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="markAsPickedUp(${index})" title="Mark as Picked Up" class="bg-green-500 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button onclick="deleteOutbound(${index})" title="Delete" class="bg-red-500 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
        <div class="mt-4 px-4 flex justify-between items-center">
            <div>
                <button onclick="groupSelectedBySO()" class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded mr-2">
                    <i class="fas fa-box mr-2"></i>Group by Sales Order
                </button>
                <button onclick="groupSelected()" class="bg-purple-500 hover:bg-purple-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-boxes mr-2"></i>Group Selected Items
                </button>
            </div>
            <div class="text-sm text-gray-600">
                <span id="selectedCount">0</span> items selected
            </div>
        </div>
    `;
}

function showAddInboundModal() {
    document.getElementById('inboundModal').classList.add('show');
}

function closeInboundModal() {
    document.getElementById('inboundModal').classList.remove('show');
    document.getElementById('inboundForm').reset();
    resetInboundImageUpload();
}

function showAddOutboundModal() {
    document.getElementById('outboundModal').classList.add('show');
}

function closeOutboundModal() {
    document.getElementById('outboundModal').classList.remove('show');
    document.getElementById('outboundForm').reset();
    resetOutboundImageUpload();
}

// Warehouse Image handling functions
function handleInboundImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Validate file size (5MB limit)
    if (file.size > 5 * 1024 * 1024) {
        alert('Image file is too large. Please choose a file smaller than 5MB.');
        return;
    }
    
    // Validate file type
    if (!file.type.startsWith('image/')) {
        alert('Please select a valid image file.');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        inboundImageData = e.target.result;
        showInboundImagePreview(e.target.result);
    };
    reader.readAsDataURL(file);
}

function showInboundImagePreview(imageData) {
    const preview = document.getElementById('inboundImagePreview');
    const uploadArea = document.getElementById('inboundImageUploadArea');
    const previewImg = document.getElementById('inboundPreviewImg');
    
    previewImg.src = imageData;
    preview.classList.remove('hidden');
    uploadArea.classList.add('hidden');
}

function removeInboundImage() {
    inboundImageData = null;
    const preview = document.getElementById('inboundImagePreview');
    const uploadArea = document.getElementById('inboundImageUploadArea');
    const fileInput = document.getElementById('inboundItemImage');
    
    preview.classList.add('hidden');
    uploadArea.classList.remove('hidden');
    fileInput.value = '';
}

function resetInboundImageUpload() {
    inboundImageData = null;
    const preview = document.getElementById('inboundImagePreview');
    const uploadArea = document.getElementById('inboundImageUploadArea');
    const fileInput = document.getElementById('inboundItemImage');
    
    preview.classList.add('hidden');
    uploadArea.classList.remove('hidden');
    fileInput.value = '';
}

function handleOutboundImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Validate file size (5MB limit)
    if (file.size > 5 * 1024 * 1024) {
        alert('Image file is too large. Please choose a file smaller than 5MB.');
        return;
    }
    
    // Validate file type
    if (!file.type.startsWith('image/')) {
        alert('Please select a valid image file.');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        outboundImageData = e.target.result;
        showOutboundImagePreview(e.target.result);
    };
    reader.readAsDataURL(file);
}

function showOutboundImagePreview(imageData) {
    const preview = document.getElementById('outboundImagePreview');
    const uploadArea = document.getElementById('outboundImageUploadArea');
    const previewImg = document.getElementById('outboundPreviewImg');
    
    previewImg.src = imageData;
    preview.classList.remove('hidden');
    uploadArea.classList.add('hidden');
}

function removeOutboundImage() {
    outboundImageData = null;
    const preview = document.getElementById('outboundImagePreview');
    const uploadArea = document.getElementById('outboundImageUploadArea');
    const fileInput = document.getElementById('outboundItemImage');
    
    preview.classList.add('hidden');
    uploadArea.classList.remove('hidden');
    fileInput.value = '';
}

function resetOutboundImageUpload() {
    outboundImageData = null;
    const preview = document.getElementById('outboundImagePreview');
    const uploadArea = document.getElementById('outboundImageUploadArea');
    const fileInput = document.getElementById('outboundItemImage');
    
    preview.classList.add('hidden');
    uploadArea.classList.remove('hidden');
    fileInput.value = '';
}

// Camera functions for warehouse
function openInboundCameraModal() {
    document.getElementById('inboundCameraModal').classList.add('show');
    resetInboundCameraModal();
}

function closeInboundCameraModal() {
    stopInboundCamera();
    document.getElementById('inboundCameraModal').classList.remove('show');
}

function resetInboundCameraModal() {
    const video = document.getElementById('inboundCameraVideo');
    const canvas = document.getElementById('inboundCameraCanvas');
    const controls = document.getElementById('inboundCameraControls');
    const captureControls = document.getElementById('inboundCaptureControls');
    const error = document.getElementById('inboundCameraError');
    
    video.style.display = 'none';
    canvas.classList.add('hidden');
    controls.style.display = 'block';
    captureControls.classList.add('hidden');
    error.classList.add('hidden');
}

async function startInboundCamera() {
    try {
        const video = document.getElementById('inboundCameraVideo');
        const controls = document.getElementById('inboundCameraControls');
        const captureControls = document.getElementById('inboundCaptureControls');
        const error = document.getElementById('inboundCameraError');
        
        inboundCameraStream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: 'environment',
                width: { ideal: 1280 },
                height: { ideal: 720 }
            } 
        });
        
        video.srcObject = inboundCameraStream;
        video.style.display = 'block';
        controls.style.display = 'none';
        captureControls.classList.remove('hidden');
        error.classList.add('hidden');
        
    } catch (err) {
        console.error('Camera access error:', err);
        const error = document.getElementById('inboundCameraError');
        const errorMessage = document.getElementById('inboundCameraErrorMessage');
        
        if (err.name === 'NotAllowedError') {
            errorMessage.textContent = 'Camera access denied. Please allow camera access and try again.';
        } else if (err.name === 'NotFoundError') {
            errorMessage.textContent = 'No camera found on this device.';
        } else {
            errorMessage.textContent = 'Camera access failed. Please try again.';
        }
        
        error.classList.remove('hidden');
    }
}

function captureInboundPhoto() {
    const video = document.getElementById('inboundCameraVideo');
    const canvas = document.getElementById('inboundCameraCanvas');
    const ctx = canvas.getContext('2d');
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    const imageData = canvas.toDataURL('image/jpeg', 0.8);
    inboundImageData = imageData;
    showInboundImagePreview(imageData);
    
    closeInboundCameraModal();
    alert('Photo captured successfully!');
}

function stopInboundCamera() {
    if (inboundCameraStream) {
        inboundCameraStream.getTracks().forEach(track => track.stop());
        inboundCameraStream = null;
    }
    
    const video = document.getElementById('inboundCameraVideo');
    video.srcObject = null;
    resetInboundCameraModal();
}

function openOutboundCameraModal() {
    document.getElementById('outboundCameraModal').classList.add('show');
    resetOutboundCameraModal();
}

function closeOutboundCameraModal() {
    stopOutboundCamera();
    document.getElementById('outboundCameraModal').classList.remove('show');
}

function resetOutboundCameraModal() {
    const video = document.getElementById('outboundCameraVideo');
    const canvas = document.getElementById('outboundCameraCanvas');
    const controls = document.getElementById('outboundCameraControls');
    const captureControls = document.getElementById('outboundCaptureControls');
    const error = document.getElementById('outboundCameraError');
    
    video.style.display = 'none';
    canvas.classList.add('hidden');
    controls.style.display = 'block';
    captureControls.classList.add('hidden');
    error.classList.add('hidden');
}

async function startOutboundCamera() {
    try {
        const video = document.getElementById('outboundCameraVideo');
        const controls = document.getElementById('outboundCameraControls');
        const captureControls = document.getElementById('outboundCaptureControls');
        const error = document.getElementById('outboundCameraError');
        
        outboundCameraStream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: 'environment',
                width: { ideal: 1280 },
                height: { ideal: 720 }
            } 
        });
        
        video.srcObject = outboundCameraStream;
        video.style.display = 'block';
        controls.style.display = 'none';
        captureControls.classList.remove('hidden');
        error.classList.add('hidden');
        
    } catch (err) {
        console.error('Camera access error:', err);
        const error = document.getElementById('outboundCameraError');
        const errorMessage = document.getElementById('outboundCameraErrorMessage');
        
        if (err.name === 'NotAllowedError') {
            errorMessage.textContent = 'Camera access denied. Please allow camera access and try again.';
        } else if (err.name === 'NotFoundError') {
            errorMessage.textContent = 'No camera found on this device.';
        } else {
            errorMessage.textContent = 'Camera access failed. Please try again.';
        }
        
        error.classList.remove('hidden');
    }
}

function captureOutboundPhoto() {
    const video = document.getElementById('outboundCameraVideo');
    const canvas = document.getElementById('outboundCameraCanvas');
    const ctx = canvas.getContext('2d');
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    const imageData = canvas.toDataURL('image/jpeg', 0.8);
    outboundImageData = imageData;
    showOutboundImagePreview(imageData);
    
    closeOutboundCameraModal();
    alert('Photo captured successfully!');
}

function stopOutboundCamera() {
    if (outboundCameraStream) {
        outboundCameraStream.getTracks().forEach(track => track.stop());
        outboundCameraStream = null;
    }
    
    const video = document.getElementById('outboundCameraVideo');
    video.srcObject = null;
    resetOutboundCameraModal();
}

// Customer Item Camera functions
function openCustomerItemCameraModal(counter) {
    currentCustomerItemCounter = counter;
    document.getElementById('customerItemCameraModal').classList.add('show');
    resetCustomerItemCameraModal();
}

function closeCustomerItemCameraModal() {
    stopCustomerItemCamera();
    document.getElementById('customerItemCameraModal').classList.remove('show');
    resetCustomerItemCameraModal();
}

function resetCustomerItemCameraModal() {
    const video = document.getElementById('customerItemCameraVideo');
    const canvas = document.getElementById('customerItemCameraCanvas');
    const controls = document.getElementById('customerItemCameraControls');
    const captureControls = document.getElementById('customerItemCaptureControls');
    const error = document.getElementById('customerItemCameraError');
    
    video.style.display = 'none';
    canvas.classList.add('hidden');
    controls.classList.remove('hidden');
    captureControls.classList.add('hidden');
    error.classList.add('hidden');
}

function startCustomerItemCamera() {
    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
            customerItemCameraStream = stream;
            const video = document.getElementById('customerItemCameraVideo');
            video.srcObject = stream;
            video.style.display = 'block';
            
            document.getElementById('customerItemCameraControls').classList.add('hidden');
            document.getElementById('customerItemCaptureControls').classList.remove('hidden');
        })
        .catch(err => {
            console.error('Error accessing camera:', err);
            document.getElementById('customerItemCameraError').classList.remove('hidden');
            document.getElementById('customerItemCameraErrorMessage').textContent = 
                'Camera access denied or not available. Please check your camera permissions.';
        });
}

function captureCustomerItemPhoto() {
    const video = document.getElementById('customerItemCameraVideo');
    const canvas = document.getElementById('customerItemCameraCanvas');
    const context = canvas.getContext('2d');
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0);
    
    const imageData = canvas.toDataURL('image/jpeg', 0.8);
    
    // Store the image data for the current customer item
    const item = customerItems.find(i => i.counter == currentCustomerItemCounter);
    if (item) {
        item.imageData = imageData;
    }
    
    showCustomerItemImagePreview(imageData, currentCustomerItemCounter);
    
    closeCustomerItemCameraModal();
    alert('Photo captured successfully!');
}

function stopCustomerItemCamera() {
    if (customerItemCameraStream) {
        customerItemCameraStream.getTracks().forEach(track => track.stop());
        customerItemCameraStream = null;
    }
    
    const video = document.getElementById('customerItemCameraVideo');
    video.srcObject = null;
    resetCustomerItemCameraModal();
}

// Customer Form functions
function showCustomerForm() {
    document.getElementById('customerFormModal').classList.add('show');
    resetCustomerForm();
    addCustomerItem(); // Add first item automatically
}

function closeCustomerForm() {
    document.getElementById('customerFormModal').classList.remove('show');
    resetCustomerForm();
}

function resetCustomerForm() {
    document.getElementById('customerForm').reset();
    customerItems = [];
    customerItemCounter = 0;
    document.getElementById('customerItemsList').innerHTML = '';
}

function addCustomerItem() {
    customerItemCounter++;
    const itemId = `customerItem_${customerItemCounter}`;
    
    const itemHtml = `
        <div id="${itemId}" class="bg-white p-4 rounded-lg border border-gray-200">
            <div class="flex justify-between items-center mb-4">
                <h4 class="text-md font-semibold text-gray-800">Item ${customerItemCounter}</h4>
                <button type="button" onclick="removeCustomerItem('${itemId}')" class="text-red-500 hover:text-red-700">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Make *</label>
                    <input type="text" required class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Manufacturer" name="make_${customerItemCounter}">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Model *</label>
                    <input type="text" required class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Model Number" name="model_${customerItemCounter}">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Serial Number *</label>
                    <input type="text" required class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Serial Number" name="serial_${customerItemCounter}">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Barcode</label>
                    <input type="text" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Barcode" name="barcode_${customerItemCounter}">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Item Image</label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-2 text-center">
                        <input type="file" accept="image/*" class="hidden" onchange="handleCustomerItemImageUpload(event, '${itemId}')" id="customerItemImage_${customerItemCounter}">
                        <div id="customerItemImagePreview_${customerItemCounter}" class="hidden mb-2">
                            <img id="customerItemPreviewImg_${customerItemCounter}" class="max-w-full max-h-32 mx-auto rounded" alt="Item preview">
                            <button type="button" onclick="removeCustomerItemImage('${customerItemCounter}')" class="mt-1 text-red-500 hover:text-red-700 text-xs">
                                <i class="fas fa-trash mr-1"></i>Remove
                            </button>
                        </div>
                        <div id="customerItemImageUploadArea_${customerItemCounter}" class="space-y-2">
                            <div class="cursor-pointer" onclick="document.getElementById('customerItemImage_${customerItemCounter}').click()">
                                <i class="fas fa-cloud-upload-alt text-2xl text-gray-400 mb-1"></i>
                                <p class="text-gray-600 text-sm">Upload Image</p>
                            </div>
                            <div class="border-t border-gray-200 pt-2">
                                <button type="button" onclick="openCustomerItemCameraModal('${customerItemCounter}')" class="bg-blue-500 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs">
                                    <i class="fas fa-camera mr-1"></i>Take Photo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Special Instructions</label>
                    <textarea class="w-full border border-gray-300 rounded px-3 py-2" rows="2" placeholder="Any special requirements" name="instructions_${customerItemCounter}"></textarea>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('customerItemsList').insertAdjacentHTML('beforeend', itemHtml);
    customerItems.push({
        id: itemId,
        counter: customerItemCounter,
        imageData: null
    });
}

function removeCustomerItem(itemId) {
    const itemElement = document.getElementById(itemId);
    if (itemElement) {
        itemElement.remove();
        customerItems = customerItems.filter(item => item.id !== itemId);
    }
}

function handleCustomerItemImageUpload(event, itemId) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (file.size > 5 * 1024 * 1024) {
        alert('Image file is too large. Please choose a file smaller than 5MB.');
        return;
    }
    
    if (!file.type.startsWith('image/')) {
        alert('Please select a valid image file.');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const counter = itemId.split('_')[1];
        const item = customerItems.find(i => i.id === itemId);
        if (item) {
            item.imageData = e.target.result;
        }
        showCustomerItemImagePreview(e.target.result, counter);
    };
    reader.readAsDataURL(file);
}

function showCustomerItemImagePreview(imageData, counter) {
    const preview = document.getElementById(`customerItemImagePreview_${counter}`);
    const uploadArea = document.getElementById(`customerItemImageUploadArea_${counter}`);
    const previewImg = document.getElementById(`customerItemPreviewImg_${counter}`);
    
    previewImg.src = imageData;
    preview.classList.remove('hidden');
    uploadArea.classList.add('hidden');
}

function removeCustomerItemImage(counter) {
    const item = customerItems.find(i => i.counter == counter);
    if (item) {
        item.imageData = null;
    }
    
    const preview = document.getElementById(`customerItemImagePreview_${counter}`);
    const uploadArea = document.getElementById(`customerItemImageUploadArea_${counter}`);
    const fileInput = document.getElementById(`customerItemImage_${counter}`);
    
    preview.classList.add('hidden');
    uploadArea.classList.remove('hidden');
    fileInput.value = '';
}

function saveCustomerForm(event) {
    event.preventDefault();
    
    if (customerItems.length === 0) {
        alert('Please add at least one item.');
        return;
    }
    
    // Get customer information
    const customerInfo = {
        companyName: document.getElementById('customerCompanyName').value,
        quoteRequest: document.getElementById('customerQuoteRequest').value,
        address: document.getElementById('customerAddress').value,
        contactName: document.getElementById('customerContactName').value,
        phoneNumber: document.getElementById('customerPhoneNumber').value,
        email: document.getElementById('customerEmail').value,
        poNumber: document.getElementById('customerPoNumber').value,
        workRequired: document.getElementById('customerWorkRequired').value,
        certType: document.getElementById('customerCertType').value,
        calPoints: document.getElementById('customerCalPoints').value
    };
    
    // Process each item
    customerItems.forEach(item => {
        const counter = item.counter;
        const make = document.querySelector(`input[name="make_${counter}"]`).value;
        const model = document.querySelector(`input[name="model_${counter}"]`).value;
        const serialNumber = document.querySelector(`input[name="serial_${counter}"]`).value;
        const barcode = document.querySelector(`input[name="barcode_${counter}"]`).value;
        const instructions = document.querySelector(`textarea[name="instructions_${counter}"]`).value;
        
        // Create inbound item
        const inboundItem = {
            id: Date.now() + Math.random(),
            companyName: customerInfo.companyName,
            quoteRequest: customerInfo.quoteRequest,
            make: make,
            model: model,
            serialNumber: serialNumber,
            barcode: barcode,
            contactPerson: customerInfo.contactName,
            phoneNumber: customerInfo.phoneNumber,
            email: customerInfo.email,
            poNumber: customerInfo.poNumber,
            address: customerInfo.address,
            workRequired: customerInfo.workRequired,
            certType: customerInfo.certType,
            calPoints: customerInfo.calPoints,
            instructions: instructions,
            image: item.imageData || null,
            receivedDate: new Date().toISOString(),
            status: 'inbound'
        };
        
        inboundItems.push(inboundItem);
        
        // Add to items database if it doesn't exist
        const items = JSON.parse(localStorage.getItem('items') || '[]');
        const existingItem = items.find(i => i.serialNumber === serialNumber);
        
        if (!existingItem) {
            const itemForDb = {
                barcode: barcode || `WIKA${Date.now()}${Math.floor(Math.random() * 1000)}`,
                make: make,
                model: model,
                serialNumber: serialNumber,
                image: item.imageData || null
            };
            items.push(itemForDb);
            localStorage.setItem('items', JSON.stringify(items));
        }
    });
    
    saveWarehouseData();
    renderInboundList();
    closeCustomerForm();
    alert(`Successfully added ${customerItems.length} item(s) to Inbound!`);
}

function saveOutboundItem(event) {
    event.preventDefault();
    
    // Check if we're editing an existing item
    const editingIndex = document.getElementById('outboundModal').getAttribute('data-editing-index');
    
    if (editingIndex !== null) {
        // Update existing item
        outboundItems[parseInt(editingIndex)] = {
            ...outboundItems[parseInt(editingIndex)],
            companyName: document.getElementById('outboundCompanyName').value,
            make: document.getElementById('outboundItemMake').value,
            model: document.getElementById('outboundItemModel').value,
            serialNumber: document.getElementById('outboundSerialNumber').value,
            poNumber: document.getElementById('outboundPoNumber').value,
            contactPerson: document.getElementById('outboundContactPerson').value,
            phoneNumber: document.getElementById('outboundPhoneNumber').value,
            email: document.getElementById('outboundEmail').value,
            connoteNumber: document.getElementById('outboundConnoteNumber').value
        };
        
        saveWarehouseData();
        renderOutboundList();
        
        // Reset modal
        document.getElementById('outboundModal').removeAttribute('data-editing-index');
        document.querySelector('#outboundModal h2').textContent = 'Add Item to Outbound';
        closeOutboundModal();
        alert('Item updated successfully!');
        return;
    }
    
    // Create new item
    const outboundItem = {
        id: Date.now(),
        companyName: document.getElementById('outboundCompanyName').value,
        make: document.getElementById('outboundItemMake').value,
        model: document.getElementById('outboundItemModel').value,
        serialNumber: document.getElementById('outboundSerialNumber').value,
        poNumber: document.getElementById('outboundPoNumber').value,
        contactPerson: document.getElementById('outboundContactPerson').value,
        phoneNumber: document.getElementById('outboundPhoneNumber').value,
        email: document.getElementById('outboundEmail').value,
        connoteNumber: document.getElementById('outboundConnoteNumber').value,
        outboundDate: new Date().toISOString(),
        status: 'outbound',
        addedManually: true // Flag to indicate this was added directly to outbound
    };
    
    outboundItems.push(outboundItem);
    saveWarehouseData();
    renderOutboundList();
    closeOutboundModal();
    alert('Item added to Outbound section successfully!');
}

function editOutboundItem(index) {
    const item = outboundItems[index];
    if (!item) return;
    
    // Populate form with existing data
    document.getElementById('outboundCompanyName').value = item.companyName;
    document.getElementById('outboundPoNumber').value = item.poNumber || '';
    document.getElementById('outboundItemMake').value = item.make || '';
    document.getElementById('outboundItemModel').value = item.model || '';
    document.getElementById('outboundSerialNumber').value = item.serialNumber || '';
    document.getElementById('outboundContactPerson').value = item.contactPerson || '';
    document.getElementById('outboundPhoneNumber').value = item.phoneNumber || '';
    document.getElementById('outboundEmail').value = item.email || '';
    document.getElementById('outboundConnoteNumber').value = item.connoteNumber || '';
    
    // Store the index for updating
    document.getElementById('outboundModal').setAttribute('data-editing-index', index);
    
    // Change modal title
    document.querySelector('#outboundModal h2').textContent = 'Edit Outbound Item';
    
    // Show modal
    showAddOutboundModal();
}

function saveInboundItem(event) {
    event.preventDefault();
    
    const serialNumber = document.getElementById('serialNumber').value;
    const make = document.getElementById('itemMake').value;
    const model = document.getElementById('itemModel').value;
    const barcode = document.getElementById('barcode').value;
    
    // Check if we're editing an existing item
    const editingIndex = document.getElementById('inboundModal').getAttribute('data-editing-index');
    
    if (editingIndex !== null) {
        // Update existing item
        inboundItems[parseInt(editingIndex)] = {
            ...inboundItems[parseInt(editingIndex)],
            companyName: document.getElementById('companyName').value,
            woNumber: document.getElementById('woNumber').value,
            make: make,
            model: model,
            serialNumber: serialNumber,
            barcode: barcode,
            contactPerson: document.getElementById('contactPerson').value,
            phoneNumber: document.getElementById('phoneNumber').value,
            email: document.getElementById('email').value,
            poNumber: document.getElementById('poNumber').value,
            image: inboundImageData || null
        };
        
        saveWarehouseData();
        renderInboundList();
        
        // Reset modal
        document.getElementById('inboundModal').removeAttribute('data-editing-index');
        document.querySelector('#inboundModal h2').textContent = 'Add Item to Inbound';
        closeInboundModal();
        alert('Item updated successfully!');
        return;
    }
    
    // Check if serial number already exists in items database (for new items only)
    const items = JSON.parse(localStorage.getItem('items') || '[]');
    const existingItem = items.find(item => item.serialNumber === serialNumber);
    
    if (existingItem) {
        // Create a custom modal for better UX
        const modal = document.createElement('div');
        modal.className = 'modal show';
        modal.innerHTML = `
            <div class="modal-content">
                <h3 class="text-lg font-bold mb-4 text-red-600"> Duplicate Serial Number Detected</h3>
                <div class="mb-4 p-4 bg-gray-50 rounded">
                    <p class="text-sm font-semibold mb-2">Existing Item in Database:</p>
                    <p class="text-sm"><strong>Make:</strong> ${existingItem.make}</p>
                    <p class="text-sm"><strong>Model:</strong> ${existingItem.model}</p>
                    <p class="text-sm"><strong>Serial:</strong> ${existingItem.serialNumber}</p>
                    <p class="text-sm"><strong>Barcode:</strong> ${existingItem.barcode || 'N/A'}</p>
                </div>
                <p class="text-sm mb-4">What would you like to do?</p>
                <div class="flex flex-col space-y-2">
                    <button onclick="useExistingItemData()" class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded">
                        <i class="fas fa-database mr-2"></i>Bring Existing Item to Inbound
                    </button>
                    <button onclick="continueWithDuplicate()" class="bg-orange-500 hover:bg-orange-700 text-white px-4 py-2 rounded">
                        <i class="fas fa-copy mr-2"></i>Create Duplicate Item Anyway
                    </button>
                    <button onclick="this.closest('.modal').remove()" class="bg-gray-500 hover:bg-gray-700 text-white px-4 py-2 rounded">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Add click handlers
        window.useExistingItemData = function() {
            // Add existing item to inbound with company details from form
            const itemToAdd = {
                id: Date.now(),
                companyName: document.getElementById('companyName').value,
                woNumber: document.getElementById('woNumber').value,
                make: existingItem.make,
                model: existingItem.model,
                serialNumber: existingItem.serialNumber,
                barcode: existingItem.barcode,
                contactPerson: document.getElementById('contactPerson').value,
                phoneNumber: document.getElementById('phoneNumber').value,
                email: document.getElementById('email').value,
                poNumber: document.getElementById('poNumber').value,
                receivedDate: new Date().toISOString(),
                status: 'inbound'
            };
            
            inboundItems.push(itemToAdd);
            saveWarehouseData();
            renderInboundList();
            modal.remove();
            closeInboundModal();
            alert('Existing item added to Inbound with your company details!');
        };
        
        window.continueWithDuplicate = function() {
            modal.remove();
            // Continue with form submission - will create duplicate
            event.target.dispatchEvent(new Event('submit', { cancelable: true }));
        };
        
        return; // Stop the normal form submission
    }
    
    const newItem = {
        id: Date.now(),
        companyName: document.getElementById('companyName').value,
        woNumber: document.getElementById('woNumber').value,
        make: make,
        model: model,
        serialNumber: serialNumber,
        barcode: barcode,
        contactPerson: document.getElementById('contactPerson').value,
        phoneNumber: document.getElementById('phoneNumber').value,
        email: document.getElementById('email').value,
        poNumber: document.getElementById('poNumber').value,
        image: inboundImageData || null,
        receivedDate: new Date().toISOString(),
        status: 'inbound'
    };
    
    inboundItems.push(newItem);
    saveWarehouseData();
    
    // Add to items database if it doesn't exist
    if (!existingItem) {
        const itemForDb = {
            barcode: barcode || `WIKA${Date.now()}${Math.floor(Math.random() * 1000)}`,
            make: make,
            model: model,
            serialNumber: serialNumber,
            image: inboundImageData || null
        };
        items.push(itemForDb);
        localStorage.setItem('items', JSON.stringify(items));
    }
    
    renderInboundList();
    closeInboundModal();
    alert('Item added to Inbound section successfully!');
}

// Movement Functions Between Sections
function moveInboundToPending(index) {
    const item = inboundItems[index];
    item.status = 'pending';
    item.pendingDate = new Date().toISOString();
    pendingItems.push(item);
    inboundItems.splice(index, 1);
    saveWarehouseData();
    renderInboundList();
    renderPendingList();
    alert('Item moved to Pending!');
}

function moveInboundToQuotation(index) {
    const item = inboundItems[index];
    item.status = 'quotation';
    item.quotationDate = new Date().toISOString();
    quotationItems.push(item);
    inboundItems.splice(index, 1);
    saveWarehouseData();
    renderInboundList();
    renderQuotationList();
    alert('Item moved to Quotation Shelf!');
}

function moveInboundToLab(index) {
    const item = inboundItems[index];
    
    // Create URL with pre-filled data and redirect to calendar
    const params = new URLSearchParams({
        companyName: item.companyName,
        woNumber: item.woNumber || '',
        workType: `${item.make} ${item.model}`,
        itemMake: item.make || '',
        itemModel: item.model || '',
        itemSerialNumber: item.serialNumber || '',
        contactPerson: item.contactPerson || '',
        phoneNumber: item.phoneNumber || '',
        email: item.email || '',
        poNumber: item.poNumber || '',
        from: 'warehouse',
        itemId: item.id,
        source: 'inbound'
    });
    
    // Store item temporarily
    sessionStorage.setItem('warehouseToLabItem', JSON.stringify(item));
    sessionStorage.setItem('warehouseToLabIndex', index);
    sessionStorage.setItem('warehouseToLabSource', 'inbound');
    
    window.location.href = `calendar.html?${params.toString()}`;
}

function moveInboundToOutbound(index) {
    if (confirm('Move this item directly to outbound (ready for pickup)?')) {
        const item = inboundItems[index];
        item.outboundDate = new Date().toISOString();
        item.status = 'outbound';
        
        outboundItems.push(item);
        inboundItems.splice(index, 1);
        
        saveWarehouseData();
        renderInboundList();
        renderOutboundList();
        alert('Item moved to outbound!');
    }
}

function movePendingToInbound(index) {
    const item = pendingItems[index];
    item.status = 'inbound';
    inboundItems.push(item);
    pendingItems.splice(index, 1);
    saveWarehouseData();
    renderPendingList();
    renderInboundList();
    alert('Item moved to Inbound!');
}

function movePendingToOutbound(index) {
    if (confirm('Move this item directly to outbound (ready for pickup)?')) {
        const item = pendingItems[index];
        item.status = 'outbound';
        item.outboundDate = new Date().toISOString();
        outboundItems.push(item);
        pendingItems.splice(index, 1);
        saveWarehouseData();
        renderPendingList();
        renderOutboundList();
        alert('Item moved to Outbound!');
    }
}

function movePendingToQuotation(index) {
    const item = pendingItems[index];
    item.status = 'quotation';
    item.quotationDate = new Date().toISOString();
    quotationItems.push(item);
    pendingItems.splice(index, 1);
    saveWarehouseData();
    renderPendingList();
    renderQuotationList();
    alert('Item moved to Quotation Shelf!');
}

function movePendingToLab(index) {
    const item = pendingItems[index];
    
    // Create URL with pre-filled data and redirect to calendar
    const params = new URLSearchParams({
        companyName: item.companyName,
        woNumber: item.woNumber || '',
        workType: `${item.make} ${item.model}`,
        itemMake: item.make || '',
        itemModel: item.model || '',
        itemSerialNumber: item.serialNumber || '',
        contactPerson: item.contactPerson || '',
        phoneNumber: item.phoneNumber || '',
        email: item.email || '',
        poNumber: item.poNumber || '',
        from: 'warehouse',
        itemId: item.id,
        source: 'pending'
    });
    
    // Store item temporarily
    sessionStorage.setItem('warehouseToLabItem', JSON.stringify(item));
    sessionStorage.setItem('warehouseToLabIndex', index);
    sessionStorage.setItem('warehouseToLabSource', 'pending');
    
    window.location.href = `calendar.html?${params.toString()}`;
}

function moveQuotationToLab(index) {
    const item = quotationItems[index];
    
    // Create URL with pre-filled data and redirect to calendar
    const params = new URLSearchParams({
        companyName: item.companyName,
        woNumber: item.woNumber || '',
        workType: `${item.make} ${item.model}`,
        itemMake: item.make || '',
        itemModel: item.model || '',
        itemSerialNumber: item.serialNumber || '',
        contactPerson: item.contactPerson || '',
        phoneNumber: item.phoneNumber || '',
        email: item.email || '',
        poNumber: item.poNumber || '',
        from: 'warehouse',
        itemId: item.id,
        source: 'quotation'
    });
    
    // Store item temporarily
    sessionStorage.setItem('warehouseToLabItem', JSON.stringify(item));
    sessionStorage.setItem('warehouseToLabIndex', index);
    sessionStorage.setItem('warehouseToLabSource', 'quotation');
    
    window.location.href = `calendar.html?${params.toString()}`;
}

function moveQuotationToOutbound(index) {
    if (confirm('Move this item directly to outbound (ready for pickup)?')) {
        const item = quotationItems[index];
        item.status = 'outbound';
        item.outboundDate = new Date().toISOString();
        outboundItems.push(item);
        quotationItems.splice(index, 1);
        saveWarehouseData();
        renderQuotationList();
        renderOutboundList();
        alert('Item moved to Outbound!');
    }
}

function deletePending(index) {
    if (confirm('Delete this pending item?')) {
        pendingItems.splice(index, 1);
        saveWarehouseData();
        renderPendingList();
    }
}

function deleteQuotation(index) {
    if (confirm('Delete this quotation item?')) {
        quotationItems.splice(index, 1);
        saveWarehouseData();
        renderQuotationList();
    }
}

function deleteLab(index) {
    if (confirm('Delete this lab item? (Note: This will not delete the associated work order)')) {
        labItems.splice(index, 1);
        saveWarehouseData();
        renderLabList();
    }
}

function moveToOutbound(index) {
    if (confirm('Move this item to outbound (ready for pickup)?')) {
        const item = inboundItems[index];
        item.outboundDate = new Date().toISOString();
        item.status = 'outbound';
        
        outboundItems.push(item);
        inboundItems.splice(index, 1);
        
        saveWarehouseData();
        renderInboundList();
        renderOutboundList();
        alert('Item moved to outbound!');
    }
}

function editInboundItem(index) {
    const item = inboundItems[index];
    if (!item) return;
    
    // Populate form with existing data
    document.getElementById('companyName').value = item.companyName;
    document.getElementById('woNumber').value = item.woNumber || '';
    document.getElementById('itemMake').value = item.make;
    document.getElementById('itemModel').value = item.model;
    document.getElementById('serialNumber').value = item.serialNumber;
    document.getElementById('barcode').value = item.barcode || '';
    document.getElementById('contactPerson').value = item.contactPerson || '';
    document.getElementById('phoneNumber').value = item.phoneNumber || '';
    document.getElementById('email').value = item.email || '';
    document.getElementById('poNumber').value = item.poNumber || '';
    
    // Store the index for updating
    document.getElementById('inboundModal').setAttribute('data-editing-index', index);
    
    // Change modal title
    document.querySelector('#inboundModal h2').textContent = 'Edit Inbound Item';
    
    // Show modal
    showAddInboundModal();
}

function deleteInbound(index) {
    if (confirm('Are you sure you want to delete this inbound item?')) {
        inboundItems.splice(index, 1);
        saveWarehouseData();
        renderInboundList();
        alert('Inbound item deleted!');
    }
}

function markAsPickedUp(index) {
    if (confirm('Mark this item as picked up and move to collection history?')) {
        const item = outboundItems[index];
        
        // Add to collection history
        const historyEntry = {
            ...item,
            pickedUpDate: new Date().toISOString(),
            pickedUpBy: currentUser.name
        };
        
        collectionHistory.push(historyEntry);
        
        // Remove from outbound
        outboundItems.splice(index, 1);
        
        saveWarehouseData();
        renderOutboundList();
        alert('Item moved to collection history!');
    }
}

function deleteOutbound(index) {
    if (confirm('Are you sure you want to delete this outbound item?')) {
        outboundItems.splice(index, 1);
        saveWarehouseData();
        renderOutboundList();
        alert('Outbound item deleted!');
    }
}

function showScannerModal() {
    document.getElementById('scannerModal').classList.add('show');
    startScanner();
}

function closeScannerModal() {
    try {
        if (html5QrCode) {
            html5QrCode.stop().then(() => {
                console.log('Scanner stopped successfully');
            }).catch(err => {
                console.log('Error stopping scanner:', err);
            });
        }
    } catch (error) {
        console.log('Error in closeScannerModal:', error);
    }
    
    // Always hide the modal regardless of scanner stop success
    const modal = document.getElementById('scannerModal');
    if (modal) {
        modal.classList.remove('show');
    }
    
    // Clear the manual input
    const manualInput = document.getElementById('manualBarcodeInput');
    if (manualInput) {
        manualInput.value = '';
    }
}

function startScanner() {
    if (!html5QrCode) {
        html5QrCode = new Html5Qrcode("reader");
    }
    
    html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        (decodedText) => {
            document.getElementById('manualBarcodeInput').value = decodedText;
            searchByBarcode();
            closeScannerModal();
        }
    ).catch(err => {
        console.log('Camera access denied or not available');
    });
}

function searchByBarcode() {
    const barcode = document.getElementById('manualBarcodeInput').value;
    if (!barcode) {
        alert('Please enter a barcode');
        return;
    }
    
    // Search in items database
    const items = JSON.parse(localStorage.getItem('items') || '[]');
    const foundItem = items.find(i => i.barcode === barcode);
    
    if (foundItem) {
        const choice = confirm(`Item found in database!\n\nMake: ${foundItem.make}\nModel: ${foundItem.model}\nSerial: ${foundItem.serialNumber}\n\nClick OK to ADD TO INBOUND with this item data\nClick Cancel to OPEN FORM and add company details`);
        
        if (choice) {
            // Add directly to inbound with item data only
            const quickInboundItem = {
                id: Date.now(),
                companyName: 'To be assigned',
                woNumber: '',
                make: foundItem.make,
                model: foundItem.model,
                serialNumber: foundItem.serialNumber,
                barcode: foundItem.barcode,
                contactPerson: '',
                phoneNumber: '',
                email: '',
                poNumber: '',
                receivedDate: new Date().toISOString(),
                status: 'inbound'
            };
            
            inboundItems.push(quickInboundItem);
            saveWarehouseData();
            renderInboundList();
            closeScannerModal();
            alert('Item added to Inbound! You can edit it later to add company details.');
        } else {
            // Auto-fill form with item data
            document.getElementById('barcode').value = foundItem.barcode;
            document.getElementById('itemMake').value = foundItem.make;
            document.getElementById('itemModel').value = foundItem.model;
            document.getElementById('serialNumber').value = foundItem.serialNumber;
            
            closeScannerModal();
            showAddInboundModal();
            alert('Item found! Please complete the remaining fields.');
        }
    } else {
        const addNew = confirm(`Barcode "${barcode}" not found in database. Would you like to add it as a new item?`);
        if (addNew) {
            document.getElementById('barcode').value = barcode;
            closeScannerModal();
            showAddInboundModal();
        }
    }
}

function openBarcodeScanner() {
    closeInboundModal();
    showScannerModal();
}

// Outbound selection and grouping
let selectedOutboundIndices = new Set();
let currentSignatureIndex = null;
let signatureCanvas = null;
let signatureCtx = null;
let isDrawing = false;

function toggleOutboundSelection(index) {
    const checkbox = document.querySelector(`.outbound-checkbox[data-index="${index}"]`);
    if (checkbox.checked) {
        selectedOutboundIndices.add(index);
    } else {
        selectedOutboundIndices.delete(index);
    }
    updateSelectedCount();
}

function toggleSelectAllOutbound(checked) {
    selectedOutboundIndices.clear();
    document.querySelectorAll('.outbound-checkbox').forEach(checkbox => {
        checkbox.checked = checked;
        if (checked) {
            selectedOutboundIndices.add(parseInt(checkbox.dataset.index));
        }
    });
    updateSelectedCount();
}

function updateSelectedCount() {
    const countElement = document.getElementById('selectedCount');
    if (countElement) {
        countElement.textContent = selectedOutboundIndices.size;
    }
}

function groupSelectedBySO() {
    if (selectedOutboundIndices.size === 0) {
        alert('Please select at least one item to group');
        return;
    }
    
    // Get all selected items
    const selectedItems = Array.from(selectedOutboundIndices).map(i => outboundItems[i]);
    
    // Group by sales order
    const groupedBySO = {};
    selectedItems.forEach(item => {
        const so = item.poNumber || 'No SO';
        if (!groupedBySO[so]) {
            groupedBySO[so] = [];
        }
        groupedBySO[so].push(item);
    });
    
    // Show confirmation
    const message = Object.entries(groupedBySO).map(([so, items]) => 
        `${so}: ${items.length} item(s) - ${items.map(i => i.make + ' ' + i.model).join(', ')}`
    ).join('\n');
    
    if (confirm(`Group items by Sales Order?\n\n${message}\n\nThis will mark these items as grouped for pickup.`)) {
        // Mark all selected items as grouped
        selectedOutboundIndices.forEach(index => {
            outboundItems[index].groupedForPickup = true;
        });
        
        saveWarehouseData();
        selectedOutboundIndices.clear();
        renderOutboundList();
        alert('Items grouped by Sales Order successfully!');
    }
}

function groupSelected() {
    if (selectedOutboundIndices.size === 0) {
        alert('Please select at least one item to group');
        return;
    }
    
    const selectedItems = Array.from(selectedOutboundIndices).map(i => outboundItems[i]);
    const message = selectedItems.map(i => `${i.make} ${i.model} (SN: ${i.serialNumber})`).join('\n');
    
    if (confirm(`Group ${selectedItems.length} selected items for pickup?\n\n${message}\n\nThis will mark these items as grouped for pickup.`)) {
        // Mark all selected items as grouped
        selectedOutboundIndices.forEach(index => {
            outboundItems[index].groupedForPickup = true;
        });
        
        saveWarehouseData();
        selectedOutboundIndices.clear();
        renderOutboundList();
        alert('Items grouped successfully!');
    }
}

// Signature functionality
function showSignatureModal(index) {
    currentSignatureIndex = index;
    document.getElementById('signatureModal').classList.add('show');
    document.getElementById('collectorName').value = '';
    
    // Initialize canvas
    setTimeout(() => {
        signatureCanvas = document.getElementById('signatureCanvas');
        signatureCtx = signatureCanvas.getContext('2d');
        signatureCtx.strokeStyle = '#000';
        signatureCtx.lineWidth = 2;
        signatureCtx.lineCap = 'round';
        
        // Clear canvas
        signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
        
        // Add drawing event listeners
        signatureCanvas.addEventListener('mousedown', startDrawing);
        signatureCanvas.addEventListener('mousemove', draw);
        signatureCanvas.addEventListener('mouseup', stopDrawing);
        signatureCanvas.addEventListener('mouseout', stopDrawing);
        
        // Touch events for mobile
        signatureCanvas.addEventListener('touchstart', handleTouchStart);
        signatureCanvas.addEventListener('touchmove', handleTouchMove);
        signatureCanvas.addEventListener('touchend', stopDrawing);
    }, 100);
}

function closeSignatureModal() {
    document.getElementById('signatureModal').classList.remove('show');
    currentSignatureIndex = null;
}

function clearSignature() {
    if (signatureCtx && signatureCanvas) {
        signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
    }
}

function startDrawing(e) {
    isDrawing = true;
    const rect = signatureCanvas.getBoundingClientRect();
    signatureCtx.beginPath();
    signatureCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
}

function draw(e) {
    if (!isDrawing) return;
    const rect = signatureCanvas.getBoundingClientRect();
    signatureCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
    signatureCtx.stroke();
}

function stopDrawing() {
    isDrawing = false;
}

function handleTouchStart(e) {
    e.preventDefault();
    isDrawing = true;
    const touch = e.touches[0];
    const rect = signatureCanvas.getBoundingClientRect();
    signatureCtx.beginPath();
    signatureCtx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
}

function handleTouchMove(e) {
    if (!isDrawing) return;
    e.preventDefault();
    const touch = e.touches[0];
    const rect = signatureCanvas.getBoundingClientRect();
    signatureCtx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
    signatureCtx.stroke();
}

function saveSignature(event) {
    event.preventDefault();
    
    const collectorName = document.getElementById('collectorName').value;
    const signatureDataURL = signatureCanvas.toDataURL();
    
    if (currentSignatureIndex !== null) {
        outboundItems[currentSignatureIndex].signature = signatureDataURL;
        outboundItems[currentSignatureIndex].collectorName = collectorName;
        outboundItems[currentSignatureIndex].collectionDate = new Date().toISOString();
        
        saveWarehouseData();
        renderOutboundList();
        closeSignatureModal();
        alert('Signature saved successfully!');
    }
}

// Collection History Functions
function showCollectionHistory() {
    document.getElementById('collectionHistoryModal').classList.add('show');
    renderCollectionHistory();
}

function closeCollectionHistory() {
    document.getElementById('collectionHistoryModal').classList.remove('show');
}

function renderCollectionHistory() {
    const container = document.getElementById('collectionHistoryContent');
    
    if (collectionHistory.length === 0) {
        container.innerHTML = `
            <div class="text-center text-gray-500 py-12">
                <i class="fas fa-archive text-6xl mb-4"></i>
                <p class="text-lg">No collection history</p>
                <p class="text-sm">Picked up items will appear here</p>
            </div>
        `;
        return;
    }
    
    // Apply filters
    const companyFilter = document.getElementById('historySearchCompany')?.value.toLowerCase() || '';
    const collectorFilter = document.getElementById('historySearchCollector')?.value.toLowerCase() || '';
    const dateFilter = document.getElementById('historySearchDate')?.value || '';
    
    let filteredHistory = collectionHistory.filter(item => {
        const matchCompany = !companyFilter || item.companyName.toLowerCase().includes(companyFilter);
        const matchCollector = !collectorFilter || (item.collectorName && item.collectorName.toLowerCase().includes(collectorFilter));
        const matchDate = !dateFilter || new Date(item.pickedUpDate).toISOString().split('T')[0] === dateFilter;
        return matchCompany && matchCollector && matchDate;
    });
    
    // Sort by picked up date (newest first)
    filteredHistory.sort((a, b) => new Date(b.pickedUpDate) - new Date(a.pickedUpDate));
    
    container.innerHTML = `
        <table class="w-full">
            <thead class="bg-gray-50 sticky top-0">
                <tr class="border-b border-gray-200">
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Company</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Contact</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Sales Order</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Make</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Model</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Serial Number</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Connote #</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Collector</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Picked Up Date</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Picked Up By</th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase">Signature</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                ${filteredHistory.map((item, index) => `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-4 py-3 text-sm text-gray-900">${item.companyName}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">
                            ${item.contactPerson ? `<div>${item.contactPerson}</div>` : ''}
                            ${item.phoneNumber ? `<div class="text-xs">${item.phoneNumber}</div>` : ''}
                            ${!item.contactPerson && !item.phoneNumber ? '-' : ''}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.poNumber || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.make}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.model}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.serialNumber}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.connoteNumber || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.collectorName || '-'}</td>
                        <td class="px-4 py-3 text-xs text-gray-500 whitespace-nowrap">
                            ${new Date(item.pickedUpDate).toLocaleDateString()}<br>
                            ${new Date(item.pickedUpDate).toLocaleTimeString()}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.pickedUpBy}</td>
                        <td class="px-4 py-3 text-center">
                            ${item.signature ? 
                                `<button onclick="viewSignature(${index})" class="text-blue-500 hover:text-blue-700">
                                    <i class="fas fa-eye"></i> View
                                </button>` : 
                                '<span class="text-gray-400">-</span>'}
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
        <div class="mt-4 text-sm text-gray-600">
            Total: ${filteredHistory.length} collection(s)
        </div>
    `;
}

function filterCollectionHistory() {
    renderCollectionHistory();
}

function viewSignature(index) {
    const companyFilter = document.getElementById('historySearchCompany')?.value.toLowerCase() || '';
    const collectorFilter = document.getElementById('historySearchCollector')?.value.toLowerCase() || '';
    const dateFilter = document.getElementById('historySearchDate')?.value || '';
    
    let filteredHistory = collectionHistory.filter(item => {
        const matchCompany = !companyFilter || item.companyName.toLowerCase().includes(companyFilter);
        const matchCollector = !collectorFilter || (item.collectorName && item.collectorName.toLowerCase().includes(collectorFilter));
        const matchDate = !dateFilter || new Date(item.pickedUpDate).toISOString().split('T')[0] === dateFilter;
        return matchCompany && matchCollector && matchDate;
    });
    
    filteredHistory.sort((a, b) => new Date(b.pickedUpDate) - new Date(a.pickedUpDate));
    
    const item = filteredHistory[index];
    if (!item || !item.signature) return;
    
    // Create a modal to display the signature
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.innerHTML = `
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4">Signature - ${item.collectorName}</h3>
            <div class="mb-4">
                <p class="text-sm text-gray-600 mb-2"><strong>Company:</strong> ${item.companyName}</p>
                <p class="text-sm text-gray-600 mb-2"><strong>Item:</strong> ${item.make} ${item.model} (${item.serialNumber})</p>
                <p class="text-sm text-gray-600 mb-2"><strong>Date:</strong> ${new Date(item.pickedUpDate).toLocaleString()}</p>
            </div>
            <img src="${item.signature}" alt="Signature" class="border-2 border-gray-300 rounded w-full">
            <div class="mt-4 flex justify-end">
                <button onclick="this.closest('.modal').remove()" class="bg-gray-500 hover:bg-gray-700 text-white px-4 py-2 rounded">
                    Close
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Expand View Functions
function expandInbound() {
    document.getElementById('expandedInboundModal').classList.add('show');
    renderExpandedInbound();
}

function closeExpandedInbound() {
    document.getElementById('expandedInboundModal').classList.remove('show');
}

function renderExpandedInbound() {
    const container = document.getElementById('expandedInboundContent');
    
    if (inboundItems.length === 0) {
        container.innerHTML = `
            <div class="text-center text-gray-500 py-12">
                <i class="fas fa-inbox text-6xl mb-4"></i>
                <p class="text-lg">No inbound items</p>
            </div>
        `;
        return;
    }
    
    // Reuse the same rendering logic
    container.innerHTML = document.getElementById('inboundList').innerHTML;
}

function expandOutbound() {
    document.getElementById('expandedOutboundModal').classList.add('show');
    renderExpandedOutbound();
}

function closeExpandedOutbound() {
    document.getElementById('expandedOutboundModal').classList.remove('show');
}

function renderExpandedOutbound() {
    const container = document.getElementById('expandedOutboundContent');
    
    if (outboundItems.length === 0) {
        container.innerHTML = `
            <div class="text-center text-gray-500 py-12">
                <i class="fas fa-box-open text-6xl mb-4"></i>
                <p class="text-lg">No outbound items</p>
            </div>
        `;
        return;
    }
    
    // Reuse the same rendering logic
    container.innerHTML = document.getElementById('outboundList').innerHTML;
}

// ============================================================================
// CUSTOMER AUTOCOMPLETE FUNCTIONALITY
// ============================================================================

async function loadCustomersDatabase() {
    // Try to load from localStorage first
    let customersDB = localStorage.getItem('customers');
    if (customersDB) {
        return JSON.parse(customersDB);
    }
    
    // Try to load from JSON file
    try {
        const response = await fetch('customers-data.json');
        if (response.ok) {
            const customers = await response.json();
            localStorage.setItem('customers', JSON.stringify(customers));
            return customers;
        }
    } catch (error) {
        console.log('No customers database found');
    }
    return [];
}

function showInboundCustomerSuggestions() {
    const input = document.getElementById('companyName');
    const query = input.value.toLowerCase().trim();
    const suggestionsDiv = document.getElementById('inboundCustomerSuggestions');
    
    if (query.length < 2) {
        suggestionsDiv.classList.add('hidden');
        return;
    }
    
    loadCustomersDatabase().then(customersDB => {
        const matches = customersDB.filter(cust => 
            cust.name.toLowerCase().includes(query) ||
            cust.customerAccount.toLowerCase().includes(query) ||
            (cust.city && cust.city.toLowerCase().includes(query))
        ).slice(0, 15);
        
        if (matches.length === 0) {
            suggestionsDiv.innerHTML = `
                <div class="px-4 py-3 text-sm text-gray-500 italic bg-yellow-50">
                    <i class="fas fa-info-circle mr-2"></i>No customers found. Continue typing.
                </div>
            `;
            suggestionsDiv.classList.remove('hidden');
            return;
        }
        
        suggestionsDiv.innerHTML = matches.map(cust => `
            <div class="px-4 py-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100"
                 onclick="selectInboundCustomer('${escapeHtml(cust.name)}')">
                <div class="font-semibold text-sm">${cust.name}</div>
                <div class="text-xs text-gray-600 mt-1">
                    ${cust.customerAccount} ${cust.city ? `  ${cust.city}` : ''}
                </div>
            </div>
        `).join('');
        
        suggestionsDiv.classList.remove('hidden');
    });
}

function showOutboundCustomerSuggestions() {
    const input = document.getElementById('outboundCompanyName');
    const query = input.value.toLowerCase().trim();
    const suggestionsDiv = document.getElementById('outboundCustomerSuggestions');
    
    if (query.length < 2) {
        suggestionsDiv.classList.add('hidden');
        return;
    }
    
    loadCustomersDatabase().then(customersDB => {
        const matches = customersDB.filter(cust => 
            cust.name.toLowerCase().includes(query) ||
            cust.customerAccount.toLowerCase().includes(query) ||
            (cust.city && cust.city.toLowerCase().includes(query))
        ).slice(0, 15);
        
        if (matches.length === 0) {
            suggestionsDiv.innerHTML = `
                <div class="px-4 py-3 text-sm text-gray-500 italic bg-yellow-50">
                    <i class="fas fa-info-circle mr-2"></i>No customers found. Continue typing.
                </div>
            `;
            suggestionsDiv.classList.remove('hidden');
            return;
        }
        
        suggestionsDiv.innerHTML = matches.map(cust => `
            <div class="px-4 py-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100"
                 onclick="selectOutboundCustomer('${escapeHtml(cust.name)}')">
                <div class="font-semibold text-sm">${cust.name}</div>
                <div class="text-xs text-gray-600 mt-1">
                    ${cust.customerAccount} ${cust.city ? `  ${cust.city}` : ''}
                </div>
            </div>
        `).join('');
        
        suggestionsDiv.classList.remove('hidden');
    });
}

function escapeHtml(text) {
    if (!text) return '';
    return text.replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/\n/g, ' ');
}

function selectInboundCustomer(name) {
    document.getElementById('companyName').value = name;
    document.getElementById('inboundCustomerSuggestions').classList.add('hidden');
}

function selectOutboundCustomer(name) {
    document.getElementById('outboundCompanyName').value = name;
    document.getElementById('outboundCustomerSuggestions').classList.add('hidden');
}

// Close suggestions when clicking outside
document.addEventListener('click', function(event) {
    const inboundSuggestions = document.getElementById('inboundCustomerSuggestions');
    const outboundSuggestions = document.getElementById('outboundCustomerSuggestions');
    const inboundInput = document.getElementById('companyName');
    const outboundInput = document.getElementById('outboundCompanyName');
    
    if (inboundSuggestions && inboundInput && 
        !inboundSuggestions.contains(event.target) && 
        event.target !== inboundInput) {
        inboundSuggestions.classList.add('hidden');
    }
    
    if (outboundSuggestions && outboundInput && 
        !outboundSuggestions.contains(event.target) && 
        event.target !== outboundInput) {
        outboundSuggestions.classList.add('hidden');
    }
});

</script>
</body>
</html>


