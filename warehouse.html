<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warehouse - WIKA Calibration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 2rem; border-radius: 0.5rem; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; }
        .inbound-item { border-left: 4px solid #3b82f6; }
        .outbound-item { border-left: 4px solid #f59e0b; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Warehouse Management</h1>
                <p class="text-sm text-gray-600">Welcome, <span id="userName"></span> (<span id="userRole"></span>)</p>
            </div>
            <div class="flex space-x-4">
                <button onclick="showCollectionHistory()" class="bg-indigo-500 hover:bg-indigo-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-history mr-2"></i>Collection History
                </button>
                <button onclick="showScannerModal()" class="bg-purple-500 hover:bg-purple-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-qrcode mr-2"></i>Scan Barcode
                </button>
                <a href="home.html" class="bg-gray-500 hover:bg-gray-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-home mr-2"></i>Home
                </a>
                <button onclick="logout()" class="bg-red-500 hover:bg-red-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
        </div>

        <!-- INBOUND Section - Full Width at Top -->
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="px-6 py-4 border-b border-gray-200 bg-blue-50">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-semibold text-blue-900">Inbound</h2>
                        <p class="text-sm text-blue-700">Items received - route to Pending, Quotation, or Lab</p>
                    </div>
                    <button onclick="showAddInboundModal()" class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded">
                        <i class="fas fa-plus mr-2"></i>Add Item
                    </button>
                </div>
            </div>
            <div id="inboundList" class="p-4 space-y-3 max-h-[350px] overflow-y-auto">
                <!-- Inbound items will be rendered here -->
            </div>
        </div>

        <!-- OUTBOUND Section - Full Width -->
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="px-6 py-4 border-b border-gray-200 bg-orange-50">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-semibold text-orange-900">Outbound</h2>
                        <p class="text-sm text-orange-700">Items ready for pickup</p>
                    </div>
                </div>
            </div>
            <div id="outboundList" class="p-4 space-y-3 max-h-[350px] overflow-y-auto">
                <!-- Outbound items will be rendered here -->
            </div>
        </div>

        <!-- PENDING Section - Full Width -->
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="px-6 py-4 border-b border-gray-200 bg-yellow-50">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-semibold text-yellow-900">Pending</h2>
                        <p class="text-sm text-yellow-700">Awaiting payment or other items</p>
                    </div>
                </div>
            </div>
            <div id="pendingList" class="p-4 space-y-3 max-h-[350px] overflow-y-auto">
                <!-- Pending items will be rendered here -->
            </div>
        </div>

        <!-- QUOTATION SHELF Section - Full Width -->
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="px-6 py-4 border-b border-gray-200 bg-purple-50">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-semibold text-purple-900">Quotation Shelf</h2>
                        <p class="text-sm text-purple-700">Items for quotation</p>
                    </div>
                </div>
            </div>
            <div id="quotationList" class="p-4 space-y-3 max-h-[350px] overflow-y-auto">
                <!-- Quotation items will be rendered here -->
            </div>
        </div>

        <!-- LAB Section - Full Width -->
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="px-6 py-4 border-b border-gray-200 bg-green-50">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-semibold text-green-900">Lab</h2>
                        <p class="text-sm text-green-700">Items in calibration</p>
                    </div>
                </div>
            </div>
            <div id="labList" class="p-4 space-y-3 max-h-[350px] overflow-y-auto">
                <!-- Lab items will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Add Item Modal -->
    <div id="inboundModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">Add Item to Inbound</h2>
            <form id="inboundForm" onsubmit="saveInboundItem(event)">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Company Name *</label>
                        <input id="companyName" type="text" required class="w-full border border-gray-300 rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">WO Number</label>
                        <input id="woNumber" type="text" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Optional">
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Make *</label>
                        <input id="itemMake" type="text" required class="w-full border border-gray-300 rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Model *</label>
                        <input id="itemModel" type="text" required class="w-full border border-gray-300 rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Serial Number *</label>
                        <input id="serialNumber" type="text" required class="w-full border border-gray-300 rounded px-3 py-2">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Barcode</label>
                    <div class="flex space-x-2">
                        <input id="barcode" type="text" class="flex-1 border border-gray-300 rounded px-3 py-2" placeholder="Scan or enter barcode">
                        <button type="button" onclick="openBarcodeScanner()" class="bg-purple-500 hover:bg-purple-700 text-white px-4 py-2 rounded">
                            <i class="fas fa-qrcode"></i>
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Contact Person</label>
                        <input id="contactPerson" type="text" class="w-full border border-gray-300 rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                        <input id="phoneNumber" type="text" class="w-full border border-gray-300 rounded px-3 py-2">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input id="email" type="email" class="w-full border border-gray-300 rounded px-3 py-2">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">PO/Quote Number</label>
                    <input id="poNumber" type="text" class="w-full border border-gray-300 rounded px-3 py-2">
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="closeInboundModal()" class="bg-gray-500 hover:bg-gray-700 text-white px-4 py-2 rounded">
                        Cancel
                    </button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded">
                        Add to Inbound
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Barcode Scanner Modal -->
    <div id="scannerModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">Scan Barcode</h2>
            <div id="reader" style="width: 100%;"></div>
            <div class="mt-4">
                <p class="text-sm text-gray-600 mb-2">Or enter barcode manually:</p>
                <input id="manualBarcodeInput" type="text" class="w-full border border-gray-300 rounded px-3 py-2 mb-4" placeholder="Enter barcode">
                <div class="flex justify-end space-x-4">
                    <button onclick="closeScannerModal()" class="bg-gray-500 hover:bg-gray-700 text-white px-4 py-2 rounded">
                        Cancel
                    </button>
                    <button onclick="searchByBarcode()" class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded">
                        Search
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Signature Modal -->
    <div id="signatureModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">Collection Signature</h2>
            <form id="signatureForm" onsubmit="saveSignature(event)">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Collector Name *</label>
                    <input id="collectorName" type="text" required class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Enter name">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Signature *</label>
                    <canvas id="signatureCanvas" width="400" height="200" class="border-2 border-gray-300 rounded cursor-crosshair" style="touch-action: none;"></canvas>
                    <button type="button" onclick="clearSignature()" class="mt-2 text-sm text-blue-500 hover:text-blue-700">
                        <i class="fas fa-redo"></i> Clear Signature
                    </button>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="closeSignatureModal()" class="bg-gray-500 hover:bg-gray-700 text-white px-4 py-2 rounded">
                        Cancel
                    </button>
                    <button type="submit" class="bg-green-500 hover:bg-green-700 text-white px-4 py-2 rounded">
                        Save Signature
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Collection History Modal -->
    <div id="collectionHistoryModal" class="modal">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Collection History</h2>
                <button onclick="closeCollectionHistory()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <!-- Search and Filters -->
            <div class="mb-4 grid grid-cols-3 gap-4">
                <input id="historySearchCompany" type="text" placeholder="Search by company..." class="border border-gray-300 rounded px-3 py-2" oninput="filterCollectionHistory()">
                <input id="historySearchCollector" type="text" placeholder="Search by collector..." class="border border-gray-300 rounded px-3 py-2" oninput="filterCollectionHistory()">
                <input id="historySearchDate" type="date" class="border border-gray-300 rounded px-3 py-2" onchange="filterCollectionHistory()">
            </div>
            
            <!-- History Table -->
            <div id="collectionHistoryContent" class="overflow-auto" style="max-height: 500px;">
                <!-- Content will be rendered here -->
            </div>
            
            <div class="mt-4 flex justify-end">
                <button onclick="closeCollectionHistory()" class="bg-gray-500 hover:bg-gray-700 text-white px-4 py-2 rounded">
                    Close
                </button>
            </div>
        </div>
    </div>


<script>
const currentUser = JSON.parse(sessionStorage.getItem('currentUser')) || { name: 'Test User', role: 'admin' };

let inboundItems = [];
let outboundItems = [];
let pendingItems = [];
let quotationItems = [];
let labItems = [];
let collectionHistory = [];
let html5QrCode = null;

document.addEventListener('DOMContentLoaded', function() {
    setupUserInfo();
    loadWarehouseData();
    renderPendingList();
    renderQuotationList();
    renderLabList();
    renderInboundList();
    renderOutboundList();
});

function setupUserInfo() {
    document.getElementById('userName').textContent = currentUser.name;
    document.getElementById('userRole').textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
}

function logout() {
    sessionStorage.removeItem('currentUser');
    window.location.href = 'index.html';
}

function loadWarehouseData() {
    const storedInbound = localStorage.getItem('inboundItems');
    const storedOutbound = localStorage.getItem('outboundItems');
    const storedPending = localStorage.getItem('pendingItems');
    const storedQuotation = localStorage.getItem('quotationItems');
    const storedLab = localStorage.getItem('labItems');
    const storedHistory = localStorage.getItem('collectionHistory');
    
    if (storedInbound) {
        inboundItems = JSON.parse(storedInbound);
    }
    if (storedOutbound) {
        outboundItems = JSON.parse(storedOutbound);
    }
    if (storedPending) {
        pendingItems = JSON.parse(storedPending);
    }
    if (storedQuotation) {
        quotationItems = JSON.parse(storedQuotation);
    }
    if (storedLab) {
        labItems = JSON.parse(storedLab);
    }
    if (storedHistory) {
        collectionHistory = JSON.parse(storedHistory);
    }
}

function saveWarehouseData() {
    localStorage.setItem('inboundItems', JSON.stringify(inboundItems));
    localStorage.setItem('outboundItems', JSON.stringify(outboundItems));
    localStorage.setItem('pendingItems', JSON.stringify(pendingItems));
    localStorage.setItem('quotationItems', JSON.stringify(quotationItems));
    localStorage.setItem('labItems', JSON.stringify(labItems));
    localStorage.setItem('collectionHistory', JSON.stringify(collectionHistory));
}

// Render Functions for New Sections
function renderPendingList() {
    const container = document.getElementById('pendingList');
    
    if (pendingItems.length === 0) {
        container.innerHTML = `
            <div class="text-center text-gray-500 py-8">
                <i class="fas fa-clock text-4xl mb-2"></i>
                <p class="text-sm">No pending items</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <table class="w-full">
            <thead class="bg-gray-50 sticky top-0">
                <tr class="border-b border-gray-200">
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Company</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Make</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Model</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Serial Number</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Contact</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">PO/Quote</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Received</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                ${pendingItems.map((item, index) => `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-4 py-3 text-sm text-gray-900">${item.companyName}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.make}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.model}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.serialNumber}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">
                            ${item.contactPerson ? `<div>${item.contactPerson}</div>` : ''}
                            ${item.phoneNumber ? `<div class="text-xs">${item.phoneNumber}</div>` : ''}
                            ${!item.contactPerson && !item.phoneNumber ? '-' : ''}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.poNumber || '-'}</td>
                        <td class="px-4 py-3 text-xs text-gray-500 whitespace-nowrap">${new Date(item.receivedDate).toLocaleDateString()}</td>
                        <td class="px-4 py-3 text-right">
                            <div class="flex justify-end space-x-1">
                                <button onclick="movePendingToInbound(${index})" title="Move to Inbound" class="bg-blue-500 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs">
                                    <i class="fas fa-inbox"></i>
                                </button>
                                <button onclick="movePendingToOutbound(${index})" title="Move to Outbound" class="bg-orange-500 hover:bg-orange-700 text-white px-2 py-1 rounded text-xs">
                                    <i class="fas fa-truck"></i>
                                </button>
                                <button onclick="movePendingToQuotation(${index})" title="Move to Quotation" class="bg-purple-500 hover:bg-purple-700 text-white px-2 py-1 rounded text-xs">
                                    <i class="fas fa-file-invoice"></i>
                                </button>
                                <button onclick="movePendingToLab(${index})" title="Create Work Order" class="bg-green-500 hover:bg-green-700 text-white px-2 py-1 rounded text-xs">
                                    <i class="fas fa-flask"></i>
                                </button>
                                <button onclick="deletePending(${index})" title="Delete" class="bg-red-500 hover:bg-red-700 text-white px-2 py-1 rounded text-xs">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

function renderQuotationList() {
    const container = document.getElementById('quotationList');
    
    if (quotationItems.length === 0) {
        container.innerHTML = `
            <div class="text-center text-gray-500 py-8">
                <i class="fas fa-file-invoice text-4xl mb-2"></i>
                <p class="text-sm">No items for quotation</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <table class="w-full">
            <thead class="bg-gray-50 sticky top-0">
                <tr class="border-b border-gray-200">
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Company</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Make</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Model</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Serial Number</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Contact</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">PO/Quote</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Received</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                ${quotationItems.map((item, index) => `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-4 py-3 text-sm text-gray-900">${item.companyName}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.make}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.model}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.serialNumber}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">
                            ${item.contactPerson ? `<div>${item.contactPerson}</div>` : ''}
                            ${item.phoneNumber ? `<div class="text-xs">${item.phoneNumber}</div>` : ''}
                            ${!item.contactPerson && !item.phoneNumber ? '-' : ''}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.poNumber || '-'}</td>
                        <td class="px-4 py-3 text-xs text-gray-500 whitespace-nowrap">${new Date(item.receivedDate).toLocaleDateString()}</td>
                        <td class="px-4 py-3 text-right">
                            <div class="flex justify-end space-x-1">
                                <button onclick="moveQuotationToLab(${index})" title="Create Work Order" class="bg-green-500 hover:bg-green-700 text-white px-2 py-1 rounded text-xs">
                                    <i class="fas fa-flask"></i>
                                </button>
                                <button onclick="moveQuotationToOutbound(${index})" title="Move to Outbound" class="bg-orange-500 hover:bg-orange-700 text-white px-2 py-1 rounded text-xs">
                                    <i class="fas fa-truck"></i>
                                </button>
                                <button onclick="deleteQuotation(${index})" title="Delete" class="bg-red-500 hover:bg-red-700 text-white px-2 py-1 rounded text-xs">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

function renderLabList() {
    const container = document.getElementById('labList');
    
    if (labItems.length === 0) {
        container.innerHTML = `
            <div class="text-center text-gray-500 py-8">
                <i class="fas fa-flask text-4xl mb-2"></i>
                <p class="text-sm">No items in lab</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <table class="w-full">
            <thead class="bg-gray-50 sticky top-0">
                <tr class="border-b border-gray-200">
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Company</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Make</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Model</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Serial Number</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Work Order</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">In Lab Since</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                ${labItems.map((item, index) => `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-4 py-3 text-sm text-gray-900">${item.companyName}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.make}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.model}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.serialNumber}</td>
                        <td class="px-4 py-3 text-sm text-blue-600">${item.workOrderNumber || '-'}</td>
                        <td class="px-4 py-3 text-xs text-gray-500 whitespace-nowrap">${new Date(item.labDate).toLocaleDateString()}</td>
                        <td class="px-4 py-3 text-right">
                            <button onclick="deleteLab(${index})" title="Delete" class="bg-red-500 hover:bg-red-700 text-white px-2 py-1 rounded text-xs">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

function renderInboundList() {
    const container = document.getElementById('inboundList');
    
    if (inboundItems.length === 0) {
        container.innerHTML = `
            <div class="text-center text-gray-500 py-12">
                <i class="fas fa-inbox text-6xl mb-4"></i>
                <p class="text-lg">No inbound items</p>
                <p class="text-sm">Add items or scan barcodes to get started</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <table class="w-full">
            <thead class="bg-gray-50 sticky top-0">
                <tr class="border-b border-gray-200">
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Company</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">WO #</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Make</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Model</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Serial Number</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Barcode</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Contact</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">PO/Quote</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Received</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                ${inboundItems.map((item, index) => `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-4 py-3 text-sm text-gray-900">${item.companyName}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.woNumber || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.make}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.model}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.serialNumber}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.barcode || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">
                            ${item.contactPerson ? `<div>${item.contactPerson}</div>` : ''}
                            ${item.phoneNumber ? `<div class="text-xs">${item.phoneNumber}</div>` : ''}
                            ${item.email ? `<div class="text-xs">${item.email}</div>` : ''}
                            ${!item.contactPerson && !item.phoneNumber && !item.email ? '-' : ''}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.poNumber || '-'}</td>
                        <td class="px-4 py-3 text-xs text-gray-500 whitespace-nowrap">${new Date(item.receivedDate).toLocaleDateString()}<br>${new Date(item.receivedDate).toLocaleTimeString()}</td>
                        <td class="px-4 py-3 text-right">
                            <div class="flex justify-end space-x-1">
                                <button onclick="moveInboundToPending(${index})" title="Move to Pending" class="bg-yellow-500 hover:bg-yellow-700 text-white px-2 py-1 rounded text-xs">
                                    <i class="fas fa-clock"></i>
                                </button>
                                <button onclick="moveInboundToQuotation(${index})" title="Move to Quotation" class="bg-purple-500 hover:bg-purple-700 text-white px-2 py-1 rounded text-xs">
                                    <i class="fas fa-file-invoice"></i>
                                </button>
                                <button onclick="moveInboundToLab(${index})" title="Create Work Order" class="bg-green-500 hover:bg-green-700 text-white px-2 py-1 rounded text-xs">
                                    <i class="fas fa-flask"></i>
                                </button>
                                <button onclick="moveInboundToOutbound(${index})" title="Move to Outbound" class="bg-orange-500 hover:bg-orange-700 text-white px-2 py-1 rounded text-xs">
                                    <i class="fas fa-truck"></i>
                                </button>
                                <button onclick="deleteInbound(${index})" title="Delete" class="bg-red-500 hover:bg-red-700 text-white px-2 py-1 rounded text-xs">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

function renderOutboundList() {
    const container = document.getElementById('outboundList');
    
    if (outboundItems.length === 0) {
        container.innerHTML = `
            <div class="text-center text-gray-500 py-12">
                <i class="fas fa-box-open text-6xl mb-4"></i>
                <p class="text-lg">No outbound items</p>
                <p class="text-sm">Move items from inbound when ready</p>
            </div>
        `;
        return;
    }
    
    // Group items by sales order
    const groupedBySO = {};
    outboundItems.forEach((item, index) => {
        const soNumber = item.poNumber || 'No SO';
        if (!groupedBySO[soNumber]) {
            groupedBySO[soNumber] = [];
        }
        groupedBySO[soNumber].push({ ...item, originalIndex: index });
    });
    
    container.innerHTML = `
        <table class="w-full">
            <thead class="bg-gray-50 sticky top-0">
                <tr class="border-b border-gray-200">
                    <th class="px-2 py-3 text-center text-xs font-semibold text-gray-700 uppercase">
                        <input type="checkbox" id="selectAllOutbound" onchange="toggleSelectAllOutbound(this.checked)">
                    </th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Company</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Contact</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Phone</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Sales Order</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Make</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Model</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Serial Number</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Signature</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Name</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Date/Time</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                ${outboundItems.map((item, index) => `
                    <tr class="hover:bg-gray-50 transition ${item.groupedForPickup ? 'bg-blue-50' : ''}">
                        <td class="px-2 py-3 text-center">
                            <input type="checkbox" class="outbound-checkbox" data-index="${index}" onchange="toggleOutboundSelection(${index})">
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900">${item.companyName}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.contactPerson || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.phoneNumber || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.poNumber || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.make}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.model}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.serialNumber}</td>
                        <td class="px-4 py-3">
                            ${item.signature ? `<div class="text-green-600"><i class="fas fa-check-circle"></i> Signed</div>` : 
                            `<button onclick="showSignatureModal(${index})" class="text-blue-500 hover:text-blue-700 text-sm"><i class="fas fa-signature"></i> Sign</button>`}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.collectorName || '-'}</td>
                        <td class="px-4 py-3 text-xs text-gray-500 whitespace-nowrap">
                            ${item.collectionDate ? new Date(item.collectionDate).toLocaleDateString() + '<br>' + new Date(item.collectionDate).toLocaleTimeString() : '-'}
                        </td>
                        <td class="px-4 py-3 text-right">
                            <div class="flex justify-end space-x-2">
                                <button onclick="markAsPickedUp(${index})" title="Mark as Picked Up" class="bg-green-500 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button onclick="deleteOutbound(${index})" title="Delete" class="bg-red-500 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
        <div class="mt-4 px-4 flex justify-between items-center">
            <div>
                <button onclick="groupSelectedBySO()" class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded mr-2">
                    <i class="fas fa-box mr-2"></i>Group by Sales Order
                </button>
                <button onclick="groupSelected()" class="bg-purple-500 hover:bg-purple-700 text-white px-4 py-2 rounded">
                    <i class="fas fa-boxes mr-2"></i>Group Selected Items
                </button>
            </div>
            <div class="text-sm text-gray-600">
                <span id="selectedCount">0</span> items selected
            </div>
        </div>
    `;
}

function showAddInboundModal() {
    document.getElementById('inboundModal').classList.add('show');
}

function closeInboundModal() {
    document.getElementById('inboundModal').classList.remove('show');
    document.getElementById('inboundForm').reset();
}

function saveInboundItem(event) {
    event.preventDefault();
    
    const serialNumber = document.getElementById('serialNumber').value;
    const make = document.getElementById('itemMake').value;
    const model = document.getElementById('itemModel').value;
    const barcode = document.getElementById('barcode').value;
    
    // Check if serial number already exists in items database
    const items = JSON.parse(localStorage.getItem('items') || '[]');
    const existingItem = items.find(item => item.serialNumber === serialNumber);
    
    if (existingItem) {
        const proceed = confirm(`Warning: Serial Number "${serialNumber}" already exists in the database!\n\nExisting Item:\nMake: ${existingItem.make}\nModel: ${existingItem.model}\nSerial: ${existingItem.serialNumber}\n\nDo you want to continue adding this item?`);
        if (!proceed) {
            return;
        }
    }
    
    const newItem = {
        id: Date.now(),
        companyName: document.getElementById('companyName').value,
        woNumber: document.getElementById('woNumber').value,
        make: make,
        model: model,
        serialNumber: serialNumber,
        barcode: barcode,
        contactPerson: document.getElementById('contactPerson').value,
        phoneNumber: document.getElementById('phoneNumber').value,
        email: document.getElementById('email').value,
        poNumber: document.getElementById('poNumber').value,
        receivedDate: new Date().toISOString(),
        status: 'inbound'
    };
    
    inboundItems.push(newItem);
    saveWarehouseData();
    
    // Add to items database if it doesn't exist
    if (!existingItem) {
        const itemForDb = {
            barcode: barcode || `WIKA${Date.now()}${Math.floor(Math.random() * 1000)}`,
            make: make,
            model: model,
            serialNumber: serialNumber
        };
        items.push(itemForDb);
        localStorage.setItem('items', JSON.stringify(items));
    }
    
    renderInboundList();
    closeInboundModal();
    alert('Item added to Inbound section successfully!');
}

// Movement Functions Between Sections
function moveInboundToPending(index) {
    const item = inboundItems[index];
    item.status = 'pending';
    item.pendingDate = new Date().toISOString();
    pendingItems.push(item);
    inboundItems.splice(index, 1);
    saveWarehouseData();
    renderInboundList();
    renderPendingList();
    alert('Item moved to Pending!');
}

function moveInboundToQuotation(index) {
    const item = inboundItems[index];
    item.status = 'quotation';
    item.quotationDate = new Date().toISOString();
    quotationItems.push(item);
    inboundItems.splice(index, 1);
    saveWarehouseData();
    renderInboundList();
    renderQuotationList();
    alert('Item moved to Quotation Shelf!');
}

function moveInboundToLab(index) {
    const item = inboundItems[index];
    
    // Create URL with pre-filled data and redirect to calendar
    const params = new URLSearchParams({
        companyName: item.companyName,
        woNumber: item.woNumber || '',
        workType: `${item.make} ${item.model}`,
        itemMake: item.make || '',
        itemModel: item.model || '',
        itemSerialNumber: item.serialNumber || '',
        contactPerson: item.contactPerson || '',
        phoneNumber: item.phoneNumber || '',
        email: item.email || '',
        poNumber: item.poNumber || '',
        from: 'warehouse',
        itemId: item.id,
        source: 'inbound'
    });
    
    // Store item temporarily
    sessionStorage.setItem('warehouseToLabItem', JSON.stringify(item));
    sessionStorage.setItem('warehouseToLabIndex', index);
    sessionStorage.setItem('warehouseToLabSource', 'inbound');
    
    window.location.href = `calendar.html?${params.toString()}`;
}

function moveInboundToOutbound(index) {
    if (confirm('Move this item directly to outbound (ready for pickup)?')) {
        const item = inboundItems[index];
        item.outboundDate = new Date().toISOString();
        item.status = 'outbound';
        
        outboundItems.push(item);
        inboundItems.splice(index, 1);
        
        saveWarehouseData();
        renderInboundList();
        renderOutboundList();
        alert('Item moved to outbound!');
    }
}

function movePendingToInbound(index) {
    const item = pendingItems[index];
    item.status = 'inbound';
    inboundItems.push(item);
    pendingItems.splice(index, 1);
    saveWarehouseData();
    renderPendingList();
    renderInboundList();
    alert('Item moved to Inbound!');
}

function movePendingToOutbound(index) {
    if (confirm('Move this item directly to outbound (ready for pickup)?')) {
        const item = pendingItems[index];
        item.status = 'outbound';
        item.outboundDate = new Date().toISOString();
        outboundItems.push(item);
        pendingItems.splice(index, 1);
        saveWarehouseData();
        renderPendingList();
        renderOutboundList();
        alert('Item moved to Outbound!');
    }
}

function movePendingToQuotation(index) {
    const item = pendingItems[index];
    item.status = 'quotation';
    item.quotationDate = new Date().toISOString();
    quotationItems.push(item);
    pendingItems.splice(index, 1);
    saveWarehouseData();
    renderPendingList();
    renderQuotationList();
    alert('Item moved to Quotation Shelf!');
}

function movePendingToLab(index) {
    const item = pendingItems[index];
    
    // Create URL with pre-filled data and redirect to calendar
    const params = new URLSearchParams({
        companyName: item.companyName,
        woNumber: item.woNumber || '',
        workType: `${item.make} ${item.model}`,
        itemMake: item.make || '',
        itemModel: item.model || '',
        itemSerialNumber: item.serialNumber || '',
        contactPerson: item.contactPerson || '',
        phoneNumber: item.phoneNumber || '',
        email: item.email || '',
        poNumber: item.poNumber || '',
        from: 'warehouse',
        itemId: item.id,
        source: 'pending'
    });
    
    // Store item temporarily
    sessionStorage.setItem('warehouseToLabItem', JSON.stringify(item));
    sessionStorage.setItem('warehouseToLabIndex', index);
    sessionStorage.setItem('warehouseToLabSource', 'pending');
    
    window.location.href = `calendar.html?${params.toString()}`;
}

function moveQuotationToLab(index) {
    const item = quotationItems[index];
    
    // Create URL with pre-filled data and redirect to calendar
    const params = new URLSearchParams({
        companyName: item.companyName,
        woNumber: item.woNumber || '',
        workType: `${item.make} ${item.model}`,
        itemMake: item.make || '',
        itemModel: item.model || '',
        itemSerialNumber: item.serialNumber || '',
        contactPerson: item.contactPerson || '',
        phoneNumber: item.phoneNumber || '',
        email: item.email || '',
        poNumber: item.poNumber || '',
        from: 'warehouse',
        itemId: item.id,
        source: 'quotation'
    });
    
    // Store item temporarily
    sessionStorage.setItem('warehouseToLabItem', JSON.stringify(item));
    sessionStorage.setItem('warehouseToLabIndex', index);
    sessionStorage.setItem('warehouseToLabSource', 'quotation');
    
    window.location.href = `calendar.html?${params.toString()}`;
}

function moveQuotationToOutbound(index) {
    if (confirm('Move this item directly to outbound (ready for pickup)?')) {
        const item = quotationItems[index];
        item.status = 'outbound';
        item.outboundDate = new Date().toISOString();
        outboundItems.push(item);
        quotationItems.splice(index, 1);
        saveWarehouseData();
        renderQuotationList();
        renderOutboundList();
        alert('Item moved to Outbound!');
    }
}

function deletePending(index) {
    if (confirm('Delete this pending item?')) {
        pendingItems.splice(index, 1);
        saveWarehouseData();
        renderPendingList();
    }
}

function deleteQuotation(index) {
    if (confirm('Delete this quotation item?')) {
        quotationItems.splice(index, 1);
        saveWarehouseData();
        renderQuotationList();
    }
}

function deleteLab(index) {
    if (confirm('Delete this lab item? (Note: This will not delete the associated work order)')) {
        labItems.splice(index, 1);
        saveWarehouseData();
        renderLabList();
    }
}

function moveToOutbound(index) {
    if (confirm('Move this item to outbound (ready for pickup)?')) {
        const item = inboundItems[index];
        item.outboundDate = new Date().toISOString();
        item.status = 'outbound';
        
        outboundItems.push(item);
        inboundItems.splice(index, 1);
        
        saveWarehouseData();
        renderInboundList();
        renderOutboundList();
        alert('Item moved to outbound!');
    }
}

function deleteInbound(index) {
    if (confirm('Are you sure you want to delete this inbound item?')) {
        inboundItems.splice(index, 1);
        saveWarehouseData();
        renderInboundList();
        alert('Inbound item deleted!');
    }
}

function markAsPickedUp(index) {
    if (confirm('Mark this item as picked up and move to collection history?')) {
        const item = outboundItems[index];
        
        // Add to collection history
        const historyEntry = {
            ...item,
            pickedUpDate: new Date().toISOString(),
            pickedUpBy: currentUser.name
        };
        
        collectionHistory.push(historyEntry);
        
        // Remove from outbound
        outboundItems.splice(index, 1);
        
        saveWarehouseData();
        renderOutboundList();
        alert('Item moved to collection history!');
    }
}

function deleteOutbound(index) {
    if (confirm('Are you sure you want to delete this outbound item?')) {
        outboundItems.splice(index, 1);
        saveWarehouseData();
        renderOutboundList();
        alert('Outbound item deleted!');
    }
}

function showScannerModal() {
    document.getElementById('scannerModal').classList.add('show');
    startScanner();
}

function closeScannerModal() {
    if (html5QrCode) {
        html5QrCode.stop().catch(err => console.log(err));
    }
    document.getElementById('scannerModal').classList.remove('show');
}

function startScanner() {
    if (!html5QrCode) {
        html5QrCode = new Html5Qrcode("reader");
    }
    
    html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        (decodedText) => {
            document.getElementById('manualBarcodeInput').value = decodedText;
            searchByBarcode();
            closeScannerModal();
        }
    ).catch(err => {
        console.log('Camera access denied or not available');
    });
}

function searchByBarcode() {
    const barcode = document.getElementById('manualBarcodeInput').value;
    if (!barcode) {
        alert('Please enter a barcode');
        return;
    }
    
    // Search in items database
    const items = JSON.parse(localStorage.getItem('items') || '[]');
    const foundItem = items.find(i => i.barcode === barcode);
    
    if (foundItem) {
        // Auto-fill form with item data
        document.getElementById('barcode').value = foundItem.barcode;
        document.getElementById('itemMake').value = foundItem.make;
        document.getElementById('itemModel').value = foundItem.model;
        document.getElementById('serialNumber').value = foundItem.serialNumber;
        
        closeScannerModal();
        showAddInboundModal();
        alert('Item found! Please complete the remaining fields.');
    } else {
        const addNew = confirm(`Barcode "${barcode}" not found in database. Would you like to add it as a new item?`);
        if (addNew) {
            document.getElementById('barcode').value = barcode;
            closeScannerModal();
            showAddInboundModal();
        }
    }
}

function openBarcodeScanner() {
    closeInboundModal();
    showScannerModal();
}

// Outbound selection and grouping
let selectedOutboundIndices = new Set();
let currentSignatureIndex = null;
let signatureCanvas = null;
let signatureCtx = null;
let isDrawing = false;

function toggleOutboundSelection(index) {
    const checkbox = document.querySelector(`.outbound-checkbox[data-index="${index}"]`);
    if (checkbox.checked) {
        selectedOutboundIndices.add(index);
    } else {
        selectedOutboundIndices.delete(index);
    }
    updateSelectedCount();
}

function toggleSelectAllOutbound(checked) {
    selectedOutboundIndices.clear();
    document.querySelectorAll('.outbound-checkbox').forEach(checkbox => {
        checkbox.checked = checked;
        if (checked) {
            selectedOutboundIndices.add(parseInt(checkbox.dataset.index));
        }
    });
    updateSelectedCount();
}

function updateSelectedCount() {
    const countElement = document.getElementById('selectedCount');
    if (countElement) {
        countElement.textContent = selectedOutboundIndices.size;
    }
}

function groupSelectedBySO() {
    if (selectedOutboundIndices.size === 0) {
        alert('Please select at least one item to group');
        return;
    }
    
    // Get all selected items
    const selectedItems = Array.from(selectedOutboundIndices).map(i => outboundItems[i]);
    
    // Group by sales order
    const groupedBySO = {};
    selectedItems.forEach(item => {
        const so = item.poNumber || 'No SO';
        if (!groupedBySO[so]) {
            groupedBySO[so] = [];
        }
        groupedBySO[so].push(item);
    });
    
    // Show confirmation
    const message = Object.entries(groupedBySO).map(([so, items]) => 
        `${so}: ${items.length} item(s) - ${items.map(i => i.make + ' ' + i.model).join(', ')}`
    ).join('\n');
    
    if (confirm(`Group items by Sales Order?\n\n${message}\n\nThis will mark these items as grouped for pickup.`)) {
        // Mark all selected items as grouped
        selectedOutboundIndices.forEach(index => {
            outboundItems[index].groupedForPickup = true;
        });
        
        saveWarehouseData();
        selectedOutboundIndices.clear();
        renderOutboundList();
        alert('Items grouped by Sales Order successfully!');
    }
}

function groupSelected() {
    if (selectedOutboundIndices.size === 0) {
        alert('Please select at least one item to group');
        return;
    }
    
    const selectedItems = Array.from(selectedOutboundIndices).map(i => outboundItems[i]);
    const message = selectedItems.map(i => `${i.make} ${i.model} (SN: ${i.serialNumber})`).join('\n');
    
    if (confirm(`Group ${selectedItems.length} selected items for pickup?\n\n${message}\n\nThis will mark these items as grouped for pickup.`)) {
        // Mark all selected items as grouped
        selectedOutboundIndices.forEach(index => {
            outboundItems[index].groupedForPickup = true;
        });
        
        saveWarehouseData();
        selectedOutboundIndices.clear();
        renderOutboundList();
        alert('Items grouped successfully!');
    }
}

// Signature functionality
function showSignatureModal(index) {
    currentSignatureIndex = index;
    document.getElementById('signatureModal').classList.add('show');
    document.getElementById('collectorName').value = '';
    
    // Initialize canvas
    setTimeout(() => {
        signatureCanvas = document.getElementById('signatureCanvas');
        signatureCtx = signatureCanvas.getContext('2d');
        signatureCtx.strokeStyle = '#000';
        signatureCtx.lineWidth = 2;
        signatureCtx.lineCap = 'round';
        
        // Clear canvas
        signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
        
        // Add drawing event listeners
        signatureCanvas.addEventListener('mousedown', startDrawing);
        signatureCanvas.addEventListener('mousemove', draw);
        signatureCanvas.addEventListener('mouseup', stopDrawing);
        signatureCanvas.addEventListener('mouseout', stopDrawing);
        
        // Touch events for mobile
        signatureCanvas.addEventListener('touchstart', handleTouchStart);
        signatureCanvas.addEventListener('touchmove', handleTouchMove);
        signatureCanvas.addEventListener('touchend', stopDrawing);
    }, 100);
}

function closeSignatureModal() {
    document.getElementById('signatureModal').classList.remove('show');
    currentSignatureIndex = null;
}

function clearSignature() {
    if (signatureCtx && signatureCanvas) {
        signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
    }
}

function startDrawing(e) {
    isDrawing = true;
    const rect = signatureCanvas.getBoundingClientRect();
    signatureCtx.beginPath();
    signatureCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
}

function draw(e) {
    if (!isDrawing) return;
    const rect = signatureCanvas.getBoundingClientRect();
    signatureCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
    signatureCtx.stroke();
}

function stopDrawing() {
    isDrawing = false;
}

function handleTouchStart(e) {
    e.preventDefault();
    isDrawing = true;
    const touch = e.touches[0];
    const rect = signatureCanvas.getBoundingClientRect();
    signatureCtx.beginPath();
    signatureCtx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
}

function handleTouchMove(e) {
    if (!isDrawing) return;
    e.preventDefault();
    const touch = e.touches[0];
    const rect = signatureCanvas.getBoundingClientRect();
    signatureCtx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
    signatureCtx.stroke();
}

function saveSignature(event) {
    event.preventDefault();
    
    const collectorName = document.getElementById('collectorName').value;
    const signatureDataURL = signatureCanvas.toDataURL();
    
    if (currentSignatureIndex !== null) {
        outboundItems[currentSignatureIndex].signature = signatureDataURL;
        outboundItems[currentSignatureIndex].collectorName = collectorName;
        outboundItems[currentSignatureIndex].collectionDate = new Date().toISOString();
        
        saveWarehouseData();
        renderOutboundList();
        closeSignatureModal();
        alert('Signature saved successfully!');
    }
}

// Collection History Functions
function showCollectionHistory() {
    document.getElementById('collectionHistoryModal').classList.add('show');
    renderCollectionHistory();
}

function closeCollectionHistory() {
    document.getElementById('collectionHistoryModal').classList.remove('show');
}

function renderCollectionHistory() {
    const container = document.getElementById('collectionHistoryContent');
    
    if (collectionHistory.length === 0) {
        container.innerHTML = `
            <div class="text-center text-gray-500 py-12">
                <i class="fas fa-archive text-6xl mb-4"></i>
                <p class="text-lg">No collection history</p>
                <p class="text-sm">Picked up items will appear here</p>
            </div>
        `;
        return;
    }
    
    // Apply filters
    const companyFilter = document.getElementById('historySearchCompany')?.value.toLowerCase() || '';
    const collectorFilter = document.getElementById('historySearchCollector')?.value.toLowerCase() || '';
    const dateFilter = document.getElementById('historySearchDate')?.value || '';
    
    let filteredHistory = collectionHistory.filter(item => {
        const matchCompany = !companyFilter || item.companyName.toLowerCase().includes(companyFilter);
        const matchCollector = !collectorFilter || (item.collectorName && item.collectorName.toLowerCase().includes(collectorFilter));
        const matchDate = !dateFilter || new Date(item.pickedUpDate).toISOString().split('T')[0] === dateFilter;
        return matchCompany && matchCollector && matchDate;
    });
    
    // Sort by picked up date (newest first)
    filteredHistory.sort((a, b) => new Date(b.pickedUpDate) - new Date(a.pickedUpDate));
    
    container.innerHTML = `
        <table class="w-full">
            <thead class="bg-gray-50 sticky top-0">
                <tr class="border-b border-gray-200">
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Company</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Contact</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Sales Order</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Make</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Model</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Serial Number</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Collector</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Picked Up Date</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Picked Up By</th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase">Signature</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                ${filteredHistory.map((item, index) => `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-4 py-3 text-sm text-gray-900">${item.companyName}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">
                            ${item.contactPerson ? `<div>${item.contactPerson}</div>` : ''}
                            ${item.phoneNumber ? `<div class="text-xs">${item.phoneNumber}</div>` : ''}
                            ${!item.contactPerson && !item.phoneNumber ? '-' : ''}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.poNumber || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.make}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.model}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.serialNumber}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.collectorName || '-'}</td>
                        <td class="px-4 py-3 text-xs text-gray-500 whitespace-nowrap">
                            ${new Date(item.pickedUpDate).toLocaleDateString()}<br>
                            ${new Date(item.pickedUpDate).toLocaleTimeString()}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">${item.pickedUpBy}</td>
                        <td class="px-4 py-3 text-center">
                            ${item.signature ? 
                                `<button onclick="viewSignature(${index})" class="text-blue-500 hover:text-blue-700">
                                    <i class="fas fa-eye"></i> View
                                </button>` : 
                                '<span class="text-gray-400">-</span>'}
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
        <div class="mt-4 text-sm text-gray-600">
            Total: ${filteredHistory.length} collection(s)
        </div>
    `;
}

function filterCollectionHistory() {
    renderCollectionHistory();
}

function viewSignature(index) {
    const companyFilter = document.getElementById('historySearchCompany')?.value.toLowerCase() || '';
    const collectorFilter = document.getElementById('historySearchCollector')?.value.toLowerCase() || '';
    const dateFilter = document.getElementById('historySearchDate')?.value || '';
    
    let filteredHistory = collectionHistory.filter(item => {
        const matchCompany = !companyFilter || item.companyName.toLowerCase().includes(companyFilter);
        const matchCollector = !collectorFilter || (item.collectorName && item.collectorName.toLowerCase().includes(collectorFilter));
        const matchDate = !dateFilter || new Date(item.pickedUpDate).toISOString().split('T')[0] === dateFilter;
        return matchCompany && matchCollector && matchDate;
    });
    
    filteredHistory.sort((a, b) => new Date(b.pickedUpDate) - new Date(a.pickedUpDate));
    
    const item = filteredHistory[index];
    if (!item || !item.signature) return;
    
    // Create a modal to display the signature
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.innerHTML = `
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4">Signature - ${item.collectorName}</h3>
            <div class="mb-4">
                <p class="text-sm text-gray-600 mb-2"><strong>Company:</strong> ${item.companyName}</p>
                <p class="text-sm text-gray-600 mb-2"><strong>Item:</strong> ${item.make} ${item.model} (${item.serialNumber})</p>
                <p class="text-sm text-gray-600 mb-2"><strong>Date:</strong> ${new Date(item.pickedUpDate).toLocaleString()}</p>
            </div>
            <img src="${item.signature}" alt="Signature" class="border-2 border-gray-300 rounded w-full">
            <div class="mt-4 flex justify-end">
                <button onclick="this.closest('.modal').remove()" class="bg-gray-500 hover:bg-gray-700 text-white px-4 py-2 rounded">
                    Close
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

</script>
</body>
</html>


